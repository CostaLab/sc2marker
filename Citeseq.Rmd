---
title: "Cell marker identification with seurat samples"
author: "Ronghui"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
# .libPaths("~/R/x86_64-pc-linux-gnu-library/3.6")
library(Seurat)
library(SeuratDisk)
library(dplyr, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
library(ggplot2, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
suppressMessages(library(cowplot, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(randomForest, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(patchwork))
suppressMessages(library(data.table))
suppressMessages(library(MLmetrics))
# source("/home/ronghui/project/scMarkerDetect/R/Cell_markers.ident.R")
# source("/home/ronghui/project/scMarkerDetect/enhance-R-master/enhance.R")
# library(scMarkerDetect)
```



```{r pressure, echo=FALSE, fig.height=9, fig.width=12}
markers.allset <- read.csv(file=file.path("/home/ronghui/project/scMarkerDetect/gene_db/proteinatlas.ihc.csv"))[ ,1]

# markers.allset <- read.csv(file=file.path("/home/ronghui/project/dbmaker/abcam.tr.csv"))[ ,1]
# markers.allset <- unique(markers.allset)
# 
# markers.allset <- gsub(" ", "", markers.allset)
# # markers.allset <- gsub("-", "", markers.allset)
# 
# 
# cbmc.rna <- as.sparse(read.csv(file = "GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz", sep = ",",
#     header = TRUE, row.names = 1))
# 
# cbmc.rna <- CollapseSpeciesExpressionMatrix(cbmc.rna)
# 
# 
# markers.allset <- intersect(rownames(cbmc.rna) ,markers.allset)
# 
# length(markers.allset)

markers.allset <- c(as.character(markers.allset))
markers.allset <- unique(markers.allset)
```

# Seurat example

```{r}
# DefaultAssay(cbmc) <- "RNA"
# DefaultAssay(cbmc)
# 
# cbmc <- NormalizeData(cbmc)
# cbmc <- FindVariableFeatures(cbmc)
# cbmc <- ScaleData(cbmc)
# cbmc <- RunPCA(cbmc, verbose = FALSE)
# cbmc <- FindNeighbors(cbmc, dims = 1:30)
# cbmc <- FindClusters(cbmc, resolution = 0.8, verbose = FALSE)
# cbmc <- RunUMAP(cbmc, dims = 1:30)

# load("/home/ronghui/project/dbmaker/seurat.cbmc.rds")
citeseq <- LoadH5Seurat("/home/ronghui/Downloads/multi.h5seurat")
DimPlot(cbmc, label = TRUE)
citeseq@reductions$apca <- NULL
citeseq@assays$SCT@data


DefaultAssay(scrna) <- "ADT"
DimPlot(scrna, group.by = "celltype.l1", reduction = "wnn.umap")
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD8")
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD14")
DefaultAssay(scrna) <- "SCT"
FeaturePlot(citeseq,  reduction = "wnn.umap", features = "CD79A")
Idents(scrna) <- "celltype.l1"
makers.b <- FindMarkers(citeseq, ident.1 = "B")
makers.cd8t <- FindMarkers(scrna, ident.1 = "CD8 T")
makers.cd8t <- makers.cd8t[order(makers.cd8t$avg_log2FC, decreasing = T),]

makers.b.adt <- makers.b
makers.b <- makers.b[order(makers.b$avg_log2FC, decreasing = T),]

makers.b.all <- makers.b
makers.b.all$avg_log2FC <- abs(makers.b.all$avg_log2FC)
makers.b.all <- makers.b[order(makers.b.all$avg_log2FC, decreasing = T),]

VlnPlot(citeseq, "CD19", assay = "SCT")
table(citeseq@assays$SCT@data["CD19",])
id <- "B"
gene <- "CD19"
get_split_pos.1(citeseq, "CD19", "B")
get_split_pos.1(citeseq, "CD72", "B")
get_split_pos.1(citeseq, "LINC00926", "B")

DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, "LINC02397")
VlnPlot(scrna, "CD19")

Idents(citeseq) <- "celltype.l1"
citeseq <- makeid(citeseq, "B")
table(as.numeric(citeseq@active.ident), citeseq@active.ident)
makers.b["CD21",]


Idents(scrna) <- "celltype.l1"
DefaultAssay(scrna) <- "SCT"
makers.mono <- FindMarkers(scrna, ident.1 = "Mono", test.use = "t")
makers.mono <- makers.mono[order(makers.mono$avg_log2FC, decreasing = T),]
makers.mono["CD14", ]
```

```{r}
DefaultAssay(scrna) <- "ADT"
Idents(scrna) <- "celltype.l1"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD14")


get_split_pos.1(scrna, "CD14", "Mono")
get_split_pos.1(scrna, "S100A9", "Mono")

df.mono <- data.frame()
for (gene in rownames(makers.mono)[1:30]) {
  df.s <- get_split_pos.1(scrna, gene, "Mono")
  df.mono <- rbind(df.mono, df.s)
}
df.mono[order(df.mono$x.margin.adj, decreasing = T), ]
df.mono["CD14", ]

DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, "CD14")

hist(scrna@assays$SCT@data["CD14", ])

get_gene_PRAUC_pos <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$SCT@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.pre <- c(),
                           x.rec <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  # x.max <- max(data.id$exp)
  # x.min <- min(data.id$exp)

  # for (x.val in seq(x.min, x.max, (x.max - x.min)/100)) {
  for (x.val in quantile(data.mat.surf$exp, seq(0, 1, step))) {

    tp <- sum(data.id$exp >= x.val)
    fp <- sum(data.other$exp >= x.val)
    # tn <- sum(data.other$exp < x.val)
    fn <- sum(data.id$exp < x.val)

    x.pre <- tp/(tp + fp)
    x.rec <- tp/(tp + fn)
    de <- data.frame(x.pre, x.rec)
    gene.prauc <- rbind(gene.prauc, de)
  }

  gene.prauc <- gene.prauc[complete.cases(gene.prauc), ]
  gene.prauc <- gene.prauc[order(gene.prauc$x.rec), ]

  PRAUC <- Area_Under_Curve(gene.prauc$x.rec,  gene.prauc$x.pre,
                            method = "trapezoid", na.rm = TRUE)
  return(PRAUC)
}

get_gene_PRAUC_pos_matrix <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$SCT@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.pre <- c(),
                           x.rec <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  # x.max <- max(data.id$exp)
  # x.min <- min(data.id$exp)

  # for (x.val in seq(x.min, x.max, (x.max - x.min)/100)) {
  for (x.val in quantile(data.mat.surf$exp, seq(0, 1, step))) {

    tp <- sum(data.id$exp >= x.val)
    fp <- sum(data.other$exp >= x.val)
    # tn <- sum(data.other$exp < x.val)
    fn <- sum(data.id$exp < x.val)

    x.pre <- tp/(tp + fp)
    x.rec <- tp/(tp + fn)
    de <- data.frame(x.pre, x.rec)
    gene.prauc <- rbind(gene.prauc, de)
  }

  gene.prauc <- gene.prauc[complete.cases(gene.prauc), ]
  gene.prauc <- gene.prauc[order(gene.prauc$x.rec), ]
  return(gene.prauc)
}



get_gene_PRAUC_pos_matrix(scrna, "CD72", "B")
df <- data.frame()
for (gene in rownames(makers.b[makers.b$avg_log2FC > 0, ])) {
  df.prauc <- get_gene_PRAUC_pos(scrna, gene, "B")
  df.s <- data.frame(gene, df.prauc)
  df <- rbind(df, df.s)
}

df[order(df$df.prauc, decreasing = T), ]
markers.b.roc

df.m <- get_gene_PRAUC_pos_matrix(scrna, "CD72", "B")

plot(df.m$x.rec, df.m$x.pre)

markers.b.roc <- FindMarkers(scrna, ident.1 = "B", test.use = "roc")


```



```{r}
get_split_pos.1(scrna, "LINC02397", "B")
get_split_pos.1(scrna, "CD79A", "B")
get_split_pos.1(scrna, "CD16", "B")

DefaultAssay(scrna) <- "ADT"
markers.adt <- FindAllMarkers(scrna, test.use = "t")
markers.adt.list <- split(markers.adt, markers.adt$cluster)
markers.adt.list <- lapply(markers.adt.list, subset, subset = p_val_adj < 0.05)
DimPlot(scrna, group.by = "celltype.l1", reduction = "wnn.umap", label = T)
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD16")

DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, " CD")

markers.adt.intersect.list <- list()
for (cluster in names(markers.adt.list)) {
  df <- markers.adt.list[[cluster]]
  df <- df[df$gene %in% intersect(rownames(scrna[["ADT"]]), rownames(scrna[["SCT"]])), ]
  df <- df[order(df$avg_log2FC, decreasing = T),]
  markers.adt.intersect.list[[cluster]] <- df
}

```


```{r}
markers.t.list
```

```{r}
get_split_pos.1(scrna, "CD14", "Mono", step = 0.1)
```



```{r}
intersect(rownames(scrna[["ADT"]]), rownames(scrna[["SCT"]]))

DefaultAssay(scrna) <- "SCT"
FeaturePlot(scrna, "CLEC12A", reduction = "wnn.umap")
DimPlot(scrna, group.by = "celltype.l1", reduction = "wnn.umap", label = T)
VlnPlot(scrna, "CLEC12A")
```

```{r}
get_split_pos.1(scrna.1, "CD22", "B")
get_split_pos.1(scrna, "CNTNAP2", "B")
get_split_pos.1(scrna, "CD79A", "B")
get_split_pos.1(scrna.1, "CD19", "B")
get_split_pos.1(scrna.1, "CD72", "B")
get_split_pos.1(scrna, "CLEC12A", "Mono")

```



```{r}
DefaultAssay(scrna) <- "ADT"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD72")

DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, "CD72")
VlnPlot(scrna, "CD19")
```



```{r}
df <- data.frame()
for (gene in c(rownames(makers.b[makers.b$avg_log2FC > 0, ]), "CD19")) {
  df.s <- get_split_pos.1(citeseq, gene, "B")
  df <- rbind(df, df.s)
}

df[order(df$x.margin, decreasing = T), ]


df.5 <- data.frame()
for (gene in rownames(makers.b[makers.b$avg_log2FC > 0, ])) {
  df.s <- get_split_pos.1(scrna, gene, "B")
  df.5 <- rbind(df.5, df.s)
}

df.5[order(df.5$x.margin.adj, decreasing = T), ]
makers.b
makers.b["CD19",]
makers.b["CD22",]
df.5["CD79A",]

DefaultAssay(scrna) <- "ADT"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD24")

DefaultAssay(scrna) <- "SCT"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD79A")
Idents(scrna) <- "celltype.l1"
markers.t <- FindAllMarkers(scrna, test.use = "t")
markers.wilcox <- FindAllMarkers(scrna, test.use = "wilcox")
markers.wilcox.list <- split(markers.wilcox, markers.wilcox$cluster)
markers.wilcox.list <- lapply(markers.wilcox.list, subset, subset = p_val_adj < 0.05)

# save(markers.wilcox.list, file = "citeseq.markers.wilcoc.rds")
# save(markers.t.list, file = "citeseq.markers.t.rds")

markers.t.list <- split(markers.t, markers.t$cluster)
markers.t.list <- lapply(markers.t.list, subset, subset = p_val_adj < 0.05)
cluster <- "B"
markers.list.rerank.2 <- list()
for (cluster in names(markers.t.list)) {
  df <- data.frame()
  markers.list <- markers.t.list[[cluster]]
  print(paste(cluster))
  
  for (gene in markers.list$gene) {
    df.s <- get_split_pos.1(scrna, gene, cluster)
    df <- rbind(df, df.s)
  }
  markers.list.rerank.2[[cluster]] <- df
}

markers.list.rerank.2.sort <- list()
for (cluster in names(markers.list.rerank)) {
  markers.list <- markers.list.rerank.2[[cluster]]
  markers.list <- markers.list[order(markers.list$x.margin.adj, decreasing = T), ]
  markers.list
  markers.list.rerank.2.sort[[cluster]] <- markers.list
}

markers.list.rerank.1[["DC"]][intersect(rownames(scrna[["ADT"]]), rownames(scrna[["SCT"]])),]

markers.wilcox.list[["Mono"]][rownames(markers.list.rerank.1[["Mono"]])[1:50],]


VlnPlot(scrna.1, "FCAR")
VlnPlot(scrna.1, "CD14")
hist(as.numeric(scrna[["SCT"]]["FCAR", ]))

scrna <- NormalizeData(scrna, assay = "SCT")

save(markers.list.rerank.1, file = "citeseq.markers.rerank.rds")

```

```{r}
get_split_pos.1(scrna, "CLEC12A", "Mono")
```

```{r}
VlnPlot(scrna, "CLEC12A")
```


```{r}
get_split_pos.1(scrna.1, "CD19", "B")
get_split_pos.1(scrna.1, "CD79A", "B")

get_split_pos.1(scrna.1, "CD14", "Mono")
get_split_pos.1(scrna.1, "S100A12", "Mono")

df.b.1 <- data.frame()
for (gene in c(rownames(makers.b[makers.b$avg_log2FC > 0, ])[1:50], "CD19", "CD24")) {
  df.s <- get_split_pos.1(scrna, gene, "B")
  df.b.1 <- rbind(df.b.1, df.s)
}

df.b.1[order(df.b.1$x.margin.adj, decreasing = T), ]
```


```{r}
makers.mono["WLS",]
makers.mono["VSTM1",]
makers.b
makers.b["CD79A",]
makers.b["CD22",]
get_split_pos.1(scrna, "CD14", "Mono")
get_split_pos.1(scrna, "AC245128.3", "Mono")
get_split_pos.1(scrna, "CD79A", "B")
get_split_pos.1(scrna, "CD22", "B")
get_split_pos.1(scrna, "CD19", "B")
get_split_pos.1(scrna, "LINC00926", "B")

sum(scrna@active.ident == "B")

hist(as.numeric(scrna@assays$SCT@data["CD14", ]))
hist(as.numeric(scrna@assays$SCT@data["WLS", ]))

VlnPlot(scrna, "SLC11A1")


df.b.1 <- data.frame()
for (gene in c(rownames(makers.b[makers.b$avg_log2FC > 0, ])[1:50], "CD19", "CD24")) {
  df.s <- get_split_pos.1(scrna, gene, "B")
  df.b.1 <- rbind(df.b.1, df.s)
}

df.b.1[order(df.b.1$x.margin.adj, decreasing = T), ]


df.mono.1 <- data.frame()
pb <- txtProgressBar(style=3)
i <- 1
for (gene in rownames(makers.mono[makers.mono$avg_log2FC > 0, ])) {
  df.s <- get_split_pos.1(scrna, gene, "Mono", step = 0.1)
  df.mono.1 <- rbind(df.mono.1, df.s)
  setTxtProgressBar(pb, i/length(rownames(makers.mono[makers.mono$avg_log2FC > 0, ])))
  i <- i + 1
}
close(pb)

df.mono.1 <- df.mono.1[order(df.mono.1$x.margin.adj, decreasing = T), ]
df.mono.1

# get_split_pos.1(scrna, "WLS", "Mono")

get_split_pos.1(scrna, "AC245128.3", "Mono")

DefaultAssay(scrna) <- "SCT"
df.mono.1
VlnPlot(scrna, "CPSF2")
```

```{r}
get_split_pos.1(scrna, "CD22", "B", step = 0.1)
get_split_pos.1(scrna, "CD19", "B", step = 0.1)
get_split_pos.1(scrna, "CD79A", "B", step = 0.1)
get_split_pos.1(scrna, "CD14", "Mono", step = 0.1)
get_split_pos.1(scrna, "CLEC12A", "Mono", step = 0.1)
VlnPlot(scrna, "CPSF2")
```



```{r}
matrix_cometsc <- Seurat::GetAssayData(citeseq, slot = "data", assay = "SCT") #gets the normalized count matrix

library(Matrix)
write(colnames(matrix_cometsc), file = "colnames.txt")
write(rownames(matrix_cometsc), file = "rownames.txt")
writeMM(matrix_cometsc, file = "sparsematrix.txt")

write.table(matrix_cometsc, file= "citeseq.matrix.1.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)

umap_cometsc <- Embeddings(citeseq, reduction = "wnn.umap")
write.table(umap_cometsc, file="vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

citeseq@meta.data$numer_id <- as.numeric(citeseq@active.ident)
Idents(citeseq) <- "numer_id"
cluster_cometsc <- noquote(as.matrix(Idents(citeseq))) # Get the active cluster identities. Should be numbers. COMET does not take Non-Number cluster names.

write.table(cluster_cometsc, file = "citeseq.clusters.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)
write.table(top50_markers_MAST_res1_pct25$gene, file = "genes.txt", col.names = F, row.names = F, quote = F)
```



```{r}
scrna <- citeseq
rm(citeseq)
id <- "B"
gene <- "CD79A"
get_split_pos.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- round((mean(data.id$exp) + 1)/(mean(data.other$exp) + 1), 3)
  # x.factor.size <- length(data.other$id)/length(data.id$id)
  x.factor.size <- 100*length(data.id$id)/length(data.mat.surf$id)
  

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp >= x.val)
    fp <- sum(data.other$exp >= x.val)
    # tn <- sum(data.other$exp < x.val)
    # fn <- sum(data.id$exp < x.val)

    # if (length(data.id$id) <= length(data.other$id)) {
    #   x.margin <- tp - fp*x.factor.size
    # }
    # else{
    #   x.margin <- tp - fp*x.factor.size
    # }
    # x.margin <- x.factor*x.margin
    
    # x.margin <- (tp*x.factor.size - fp)*(x.factor**2)
    x.margin <- (tp - fp*x.factor.size)*(x.factor**2)
    # x.margin.adj <- x.margin/((sum(data.other[data.other$exp > x.val,]$exp) + 50)*x.val)
    # x.margin.adj <- x.margin/(10**((max(data.mat.surf$exp) - x.val)))
    # x.margin.adj <- (tp - fp*x.factor.size)*(x.factor**2)/(x.val**3)
    # x.margin.adj <- x.margin**(max(data.mat.surf$exp) - x.val)/data.other.sum
    
    # x.margin.adj <- x.margin*(sum(data.id[data.id$exp >= x.val,]$exp - x.val))/(x.val**5)
    # x.margin.adj <- x.margin*(id.pr**2)/(x.val**4)
    de <- data.frame(x.val, x.margin, "+", tp, fp)
    # de <- data.frame(x.val, x.margin, x.margin.adj, "+", tp, fp)
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, gene.prauc$x.val, decreasing = T),]
  x.split <- gene.prauc[1,]
  
  x.margin.adj <- x.split$x.margin/((sum(data.other[data.other$exp > x.split$x.val,]$exp) + 5)*x.split$x.val)
  x.split$x.margin.adj <- x.margin.adj
  
  rownames(x.split) <- paste(gene)
  return(x.split)
}
```


```{r}

id <- "B"
gene <- "CD79A"
get_split_pos.2 <- function(scrna, gene, id) {
  data.mat.surf <- data.frame(exp = scrna@assays$SCT@data[gene,],
                              id = as.character(scrna@active.ident))
  data.mat.surf <- data.mat.surf[order(data.mat.surf$exp, decreasing = T), ]
  
  list.id <- data.mat.surf$id
  
  id.size <- sum(data.mat.surf$id == id)
  
  K = sum(data.mat.surf$id == "B")
  N = length(data.mat.surf$id)
  
  tp <- 0
  fp <- 0
  tp.fp
  x.seq <- 1
  
  # for (x.seq in 1:id.size) {
  #   ifelse(list.id[x.seq] == id, tp <- tp +1, fp <- fp +1)
  #   if (tp >= 0.1*id.size) {
  #     
  #   }
  # }

}


get_hgp(1, k, N, K, n+1)

```


```{r}
# # Normalize ADT data,
# DefaultAssay(cbmc) <- "ADT"
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2)
# DefaultAssay(cbmc) <- "RNA"
# 
# # Note that the following command is an alternative but returns the same result
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2, assay = "ADT")

# Now, we will visualize CD14 levels for RNA and protein By setting the default assay, we can
# visualize one or the other
DefaultAssay(cbmc) <- "ADT"
p1 <- FeaturePlot(cbmc, "CD8", cols = c("lightgrey", "darkgreen")) + ggtitle("CD19 protein")
DefaultAssay(cbmc) <- "RNA"
p2 <- FeaturePlot(cbmc, "CD8") + ggtitle("CD19 RNA")

rownames(cbmc[["ADT"]])

for (gene in intersect(rownames(cbmc[["ADT"]]), rownames(cbmc[["RNA"]]))) {
  print(FeaturePlot(cbmc, gene, cols = c("lightgrey", "darkgreen")))
}

intersect(rownames(cbmc[["ADT"]]), rownames(cbmc[["RNA"]]))

# place plots side-by-side
p1 | p2
```

# Get single markers from Seurat and PRAUC

```{r warning=F}
Idents(cbmc) <- "seurat_clusters"

# markers.wilcox <- list()
# markers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   markers <- FindMarkers(cbmc, ident.1 = x.cluster, features = intersect(rownames(cbmc[["RNA"]]), markers.allset))
#   markers <- markers[order(markers$avg_log2FC, decreasing = T),]
#   markers.wilcox[[x.cluster]] <- markers
#   markers.i <- identify_single_marker(cbmc, x.cluster, markers.allset)
#   markers.prauc[[x.cluster]] <- markers.i
# }

# save(markers.wilcox, file = "first8.seuratDE.markers.rds")
# save(markers.prauc, file = "first8.prauc.markers.rds")

load(file = "first8.seuratDE.markers.rds")
load(file = "first8.prauc.markers.rds")

Idents(cbmc) <- "seurat_clusters"
markers.i <- identify_single_marker(cbmc, "12", markers.allset)

```



Compare top 9 marker from DE and prauc based method

# Plot PRAUC of TOP 9 Positive markers from DE and prauc based ranking

```{r}
Idents(cbmc) <- "seurat_clusters"

for (x.cluster in seq(1,8)) {
  df.prauc <- markers.prauc[[x.cluster]]
  df.wilcox <- markers.wilcox[[x.cluster]]
  
  g <- ggplot()
  for (genes in intersect(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc$gene[1:9], rownames(df.wilcox)[1:9])) {
    if (df.prauc[df.prauc$gene == genes, ]$direction == "+") {
      df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }else{
      df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }
  }
  print(g)
}

```


# Plot PRAUC of TOP 12 markers from COMET and prauc ranking

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
x.cluster <- 12
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_singleton_all_ranked.csv", sep = ""))
  genes <- genes[1:10, ]
  comet.genes.pos <- genes[genes$Log2FoldChange > 0, ]$gene_1
  comet.genes.neg <- genes[genes$Log2FoldChange < 0, ]$gene_1
  comet.genes.neg <-gsub("_negation", "", comet.genes.neg)
  
  df.prauc <- markers.prauc[[x.cluster]]
  df.prauc <- df.prauc[1:10,]
  df.prauc.pos <- df.prauc[df.prauc$direction == "+", ]$gene
  df.prauc.neg <- df.prauc[df.prauc$direction == "-", ]$gene
  
  g <- ggplot()
  for (genes in intersect(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.pos, comet.genes.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  
  for (genes in intersect(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.neg, comet.genes.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  print(g + xlab("Recall") + ylab("Precision") + ggtitle(paste(x.cluster)))
}

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, comet.genes.pos)
VlnPlot(cbmc, df.prauc.pos)
genes[genes$gene_1 == "CD11c", ]
df.prauc[df.prauc$gene== "CD11c",]
genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", "12", "_singleton_all_ranked.csv", sep = ""))
genes
markers.prauc[[6]]
genes$hgrank + genes$fcrank
markers.i
cbmc <- makeid(cbmc, "12")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "PROM1")
VlnPlot(cbmc, "CD34")
VlnPlot(cbmc, "SPINK2")

Idents(cbmc) <- "seurat_clusters"
cbmc.6 <- subset(cbmc, idents = "6")
cbmc.other <- subset(cbmc, idents = "6", invert = TRUE)
mean(cbmc.6@assays$RNA@data["CD37",])/mean(cbmc.other@assays$RNA@data["CD37",])
mean(cbmc.6@assays$RNA@data["CD19",])/mean(cbmc.other@assays$RNA@data["CD19",])
0.8571429*6.0270978
0.6857143*8.3523919
```

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "HLA-DOB")
VlnPlot(cbmc, df.prauc.pos)


get_split_pos.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- mean(data.id$exp)/mean(data.other$exp)
  # df <- data.frame(sum(data.other$exp == 0), length(data.other$exp))
  # return(df)
  # x.factor <- length(data.other$id)/length(data.id$id)
  

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id[data.id$exp >= x.val, ]$exp)
    fp <- sum(data.other[data.id$exp >= x.val, ]$exp)
    tn <- sum(data.other$exp < x.val)
    fn <- sum(data.id$exp < x.val)

    if (length(data.id$id) <= length(data.other$id)) {
      x.margin <- tp - fp
    }
    else{
      x.margin <- tp - fp
    }
    x.margin <- (x.factor**2)*x.margin
    
    de <- data.frame(x.val, x.margin, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
VlnPlot(cbmc, "HLA-DOB")
get_split_pos.1(cbmc, "CD19", "6")
get_split_pos.1(cbmc, "HLA-DOB", "6")
get_split_pos.1(cbmc, "CD79B", "6")

df <- data.frame()
for (gene in markers.prauc[[6]]$gene[1:20]) {
  df.s <- get_split_pos.1(cbmc, gene, "6")
  df <- rbind(df, df.s)
}
df[order(df$x.margin, decreasing = T), ]

markers.wilcox[[6]]

Idents(cbmc) <- "seurat_clusters"
markers.wilcox.6 <- FindMarkers(cbmc, ident.1 = "12", test.use = "LR")
markers.wilcox.6["CD19",]
markers.wilcox.6["HLA-DOB",]

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, "VPREB3")
VlnPlot(cbmc, "CD19")

markers.i
get_split_pos.1(cbmc, "CD34", "12")
get_split_pos.1(cbmc, "CRHBP", "12")
get_split_pos.1(cbmc, "SPINK2", "12")

```


# Detect combine markers for interested cell groups

```{r}
# makers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   df.split <- Detect_combine_markers(cbmc, x.cluster, markers.allset, max.gene = 50)
#   makers.prauc[[x.cluster]] <- df.split
# }

load(file = "first8clusters.combine.markers.rds")

makers.prauc

id <- "7"
df <- data.frame(exp1 = cbmc@assays$RNA@data["MYL3",],
                 exp2 = cbmc@assays$RNA@data["TMSB4X",],
                 id = as.character(cbmc@active.ident))


df.i <- df[df$id == "5", ]
df.o <- df[df$id != "5", ]

cor(df.i$exp1, df.i$exp2)
cor(df.o$exp1, df.o$exp2)

x.seq <- 1
df.all <- data.frame()
for (x.seq in 1:nrow(makers.prauc[[5]])) {
  gene.c <- makers.prauc[[5]][x.seq,]
  df <- data.frame(exp1 = cbmc@assays$RNA@data[gene.c$Gene1,],
                   exp2 = cbmc@assays$RNA@data[gene.c$Gene2,],
                   id = as.character(cbmc@active.ident))
  df.i <- df[df$id == "5", ]
  df.o <- df[df$id != "5", ]
  # print(gene.c)
  df.s <- data.frame(gene.c$Gene1, gene.c$Gene2, cor(df.i$exp1, df.i$exp2), cor(df.o$exp1, df.o$exp2))
  colnames(df.s) <- c("gene1", "gene2", "cor.i", "cor.o")
  df.all <- rbind(df.all, df.s)
}

cbmc <- makeid(cbmc, "5")
df <- data.frame(exp1 = cbmc@assays$RNA@data["MYL3",],
                 exp2 = cbmc@assays$RNA@data["MT-CO2",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data["MYL3",],
                 exp2 = cbmc@assays$RNA@data["TMSB4X",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))
df.all

```



```{r fig.width=10, fig.height=8}
scrna <- cbmc
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  
  # x.df <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.1)
  # x.df$method <- "COMET"
  
  if (!grepl("_negation", genes[1])) {
    if (!grepl("_negation", genes[2])) {
      gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }else{
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }else{
      if (!grepl("_negation", genes[2])) {
        genes[1] <- gsub("_negation", "", genes[1])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[2], gene2 = genes[1], id = x.cluster, step = 0.01)
      }else{
        genes[1] <- gsub("_negation", "", genes[1])
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }

  x.df <- gene.prauc
  x.df$method <- "COMET"
  # g <- ggplot() + geom_line(gene.prauc.comet, mapping = aes(x.rec, x.pre, color = method)) + xlim(c(0,1)) + ylim(c(0,1))
  
  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  Direction.c <- paste(df.split[1, ]$Direction1, df.split[1, ]$Direction2, sep = "")
  if (Direction.c == "++") {
    gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "+-") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "-+") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene2, gene2 = gene1, id = x.cluster, step = 0.01)
  }else{
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }
  
  x.df.2 <- gene.prauc
  x.df.2$method <- "PRAUC"
  
  x.df <- rbind(x.df, x.df.2)

  print(ggplot() + geom_line(x.df, mapping = aes(x.rec, x.pre, col = method)) + ggtitle(paste(x.cluster))+ 
          xlim(c(0,1)) + ylim(c(0,1)))
}
```


# Dotplot of Combine markers

```{r fig.width=10, fig.height=5}
for (x.cluster in seq(1,8)) {
  scrna <- makeid(scrna, x.cluster)
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_grid_2(cbmc, gene1, gene2, gene1.direc, gene2.direc, x.cluster, return.obj = T) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_grid_2(cbmc, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster, return.obj = T) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```





# Umap plot of combine markers

```{r fig.height = 7, fig.width=18}
Idents(cbmc) <- "seurat_clusters"
plot_marker_c_umap(cbmc, "TCL1A", "CD79B", "+", "+", "6")
scrna <- cbmc
Idents(scrna) <- "seurat_clusters"
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_marker_c_umap(scrna, gene1, gene2, gene1.direc, gene2.direc, x.cluster) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_marker_c_umap(scrna, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```

```{r}
cbmc.enhance <- enhance_seurat_wrapper(cbmc)
id <- "5"
gene1 <- "MYL3"
gene2 <- "FTH1"

df <- data.frame(exp1 = cbmc.enhance[gene1,],
                 exp2 = cbmc.enhance[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data[gene1,],
                 exp2 = cbmc@assays$RNA@data[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

```




# step by step (Maximam Recall approach)

```{r}
# markers.max_recall <- list()
# for (x.cluster in seq(1,8)) {
#   markers.i <- marker_stepbystep(cbmc, x.cluster, depth = 2, markers.allset)
#   markers.max_recall[[x.cluster]] <- markers.i
# }
# save(markers.max_recall, file = "first8.stepbystep.rds")
load(file = "first8.stepbystep.rds")
for (x.cluster in seq(1,8)) {
  markers.i <- markers.max_recall[[x.cluster]]
  print(grid_plot(cbmc, markers.i, x.cluster))
}


```                                                                                                                                                                                               

```{r}
matrix_cometsc <- Seurat::GetAssayData(so) #gets the normalized count matrix
write.table(as.matrix(matrix_cometsc), file= "markers.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)

umap_cometsc <- Embeddings(citeseq, reduction = "wnn.umap")
write.table(umap_cometsc, file="citeseq.vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

Idents(citeseq) <- "celltype.l1"

cluster_cometsc <- noquote(as.matrix(Idents(citeseq))) # Get the active cluster identities. Should be numbers. COMET does not take Non-Number cluster names.

write.table(cluster_cometsc, file = "citeseq.clusters.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

DefaultAssay(citeseq) <- "SCT"
write.table(rownames(citeseq[["SCT"]]), file = "citeseq.genes.txt", col.names = F, row.names = F, quote = F)


```



