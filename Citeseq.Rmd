---
title: "Cell marker identification with seurat samples"
author: "Ronghui"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
# .libPaths("~/R/x86_64-pc-linux-gnu-library/3.6")
library(Seurat)
library(SeuratDisk)
library(dplyr, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
library(ggplot2, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
suppressMessages(library(cowplot, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(randomForest, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(patchwork))
suppressMessages(library(data.table))
suppressMessages(library(MLmetrics))
# source("/home/ronghui/project/scMarkerDetect/R/Cell_markers.ident.R")
# source("/home/ronghui/project/scMarkerDetect/enhance-R-master/enhance.R")
# library(scMarkerDetect)
load("de.results.RData")
```



```{r pressure, echo=FALSE, fig.height=9, fig.width=12}
markers.allset <- read.csv(file=file.path("/home/ronghui/project/scMarkerDetect/gene_db/proteinatlas.ihc.csv"))[ ,1]

# markers.allset <- read.csv(file=file.path("/home/ronghui/project/dbmaker/abcam.tr.csv"))[ ,1]
# markers.allset <- unique(markers.allset)
# 
# markers.allset <- gsub(" ", "", markers.allset)
# # markers.allset <- gsub("-", "", markers.allset)
# 
# 
# cbmc.rna <- as.sparse(read.csv(file = "GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz", sep = ",",
#     header = TRUE, row.names = 1))
# 
# cbmc.rna <- CollapseSpeciesExpressionMatrix(cbmc.rna)
# 
# 
# markers.allset <- intersect(rownames(cbmc.rna) ,markers.allset)
# 
# length(markers.allset)

markers.allset <- c(as.character(markers.allset))
markers.allset <- unique(markers.allset)
```

# Seurat example

```{r}
# DefaultAssay(cbmc) <- "RNA"
# DefaultAssay(cbmc)
# 
# cbmc <- NormalizeData(cbmc)
# cbmc <- FindVariableFeatures(cbmc)
# cbmc <- ScaleData(cbmc)
# cbmc <- RunPCA(cbmc, verbose = FALSE)
# cbmc <- FindNeighbors(cbmc, dims = 1:30)
# cbmc <- FindClusters(cbmc, resolution = 0.8, verbose = FALSE)
# cbmc <- RunUMAP(cbmc, dims = 1:30)

# load("/home/ronghui/project/dbmaker/seurat.cbmc.rds")
# citeseq <- LoadH5Seurat("multi.h5seurat")
citeseq <- LoadH5Seurat("/home/ronghui/project/scMarkerDetect/multi.h5seurat")
DimPlot(cbmc, label = TRUE)
citeseq@reductions$apca <- NULL
citeseq@assays$SCT@data


DefaultAssay(scrna) <- "ADT"
DimPlot(scrna, group.by = "celltype.l1", reduction = "wnn.umap")
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD8")
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD14")
DefaultAssay(scrna) <- "SCT"
FeaturePlot(citeseq,  reduction = "wnn.umap", features = "CD79A")
Idents(scrna) <- "celltype.l1"
makers.b <- FindMarkers(citeseq, ident.1 = "B")
makers.cd8t <- FindMarkers(scrna, ident.1 = "CD8 T")
makers.cd8t <- makers.cd8t[order(makers.cd8t$avg_log2FC, decreasing = T),]

makers.b.adt <- makers.b
makers.b <- makers.b[order(makers.b$avg_log2FC, decreasing = T),]

makers.b.all <- makers.b
makers.b.all$avg_log2FC <- abs(makers.b.all$avg_log2FC)
makers.b.all <- makers.b[order(makers.b.all$avg_log2FC, decreasing = T),]

VlnPlot(citeseq, "CD19", assay = "SCT")
table(citeseq@assays$SCT@data["CD19",])
id <- "B"
gene <- "CD19"
get_split_pos.1(citeseq, "CD19", "B")
get_split_pos.1(citeseq, "CD72", "B")
get_split_pos.1(citeseq, "LINC00926", "B")

DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, "LINC02397")
VlnPlot(scrna, "CD19")

Idents(citeseq) <- "celltype.l1"
citeseq <- makeid(citeseq, "B")
table(as.numeric(citeseq@active.ident), citeseq@active.ident)
makers.b["CD21",]


Idents(citeseq) <- "celltype.l1"
DefaultAssay(citeseq) <- "SCT"
markers.b.t <- FindMarkers(citeseq, ident.1 = "B", test.use = "t")
makers.mono <- makers.mono[order(makers.mono$avg_log2FC, decreasing = T),]
df.mono["CD14", ]

match("NCR1", rownames(df.nk))
match("NCR1", rownames(markers.nk.lr))
match("NCR1", rownames(markers.nk.wilcox))
match("NCR1", rownames(markers.nk.mast))
match("CLEC12A", rownames(markers.dc.mast))

match("LY6D", rownames(df.b))
df.dc
df.nk

match("CD8A", rownames(markers.cd8t.mast))
adt.de.all[adt.de.all$cluster == "B", ]


pdf("citeseq.b.heatmap.pdf", width = 10, height = 8)
DoHeatmap(object = citeseq.small, features = b.adt.genes, slot = "data") + scale_fill_gradientn(colors = c("white", "red"))
dev.off()

mylevels <- c("B", "DC", "CD8 T", "CD4 T", "Mono", "NK", "other T", "other")
citeseq.down@active.ident <- factor(x = citeseq.down@active.ident, levels = mylevels)

c("CD21", "CD72")

match("CD8", rownames(df.))

DefaultAssay(citeseq) <- "ADT"
FeaturePlot(citeseq, "CD8A", cols = c("lightgrey", "darkgreen"), reduction = "wnn.umap")

```

```{r}
pdf("citeseq.umap.pdf")
DimPlot(citeseq, group.by = "celltype.l1", reduction = "wnn.umap") + ggtitle()
dev.off()
```

```{r}
load("citeseq.b.xx.rds")
load("citeseq.de.b.RData")
de.b.xx

adt.de.all[adt.de.all$cluster == "CD4 T", ]
adt.de.all[adt.de.all$cluster == "CD8 T", ]
adt.de.all[adt.de.all$cluster == "Mono", ]

dc.adt <- adt.de.all[adt.de.all$cluster == "DC", ]

dc.adt[order(dc.adt$avg_log2FC, decreasing = T), ]
```



```{r}
df.fc.re <- de.b.t
df.fc.re$avg_log2FC <- abs(df.fc.re$avg_log2FC)
df.fc.re <- df.fc.re[order(df.fc.re$avg_log2FC, decreasing = T), ]

t.cells.genes <- c("CR2", "CD72", "CD22", "IGHD", "CD19", "TNFRSF13C", "Ms4a1", "NT5E", "IGHM", "ICOSLG")

t.cells.genes <- toupper(t.cells.genes)

df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(de.b.t))),
                   wilcox.test <- c(match(gene, rownames(de.b.wilcox))),
                   mast <- c(match(gene, rownames(de.b.mast))),
                   LR <- c(match(gene, rownames(de.b.lr))),
                   roc <- c(match(gene, rownames(de.b.roc))),
                   FC <- c(match(gene, rownames(df.fc.re))),
                   sc2panel <- c(match(gene, de.b.xx$gene))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR","ROC", "FC", "sc2panel")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

de.b.xx[order(de.b.xx$x.margin, decreasing = T),]
df

df.melt <- melt(df)

# df.melt[is.na(df.melt)] <- 198


# pdf("mca.spleen.boxplot.pdf", width = 14, height = 10)
# ggplot(df.melt, aes(x=variable, y = value, fill = variable))+
#   geom_boxplot()+
#   coord_trans(y = squash_axis(100, 300, 30)) + xlab("Test") + ylab("Marker ranking") + ggtitle("MCA Spleen tissue")
# dev.off()

# pdf("CIteseq.Bcell.markers.ranking.boxplot.pdf", width = 7, height = 5)
ggplot(df.melt, aes(x=variable, y = value, fill = variable))+
  geom_boxplot()+
  xlab("Test") + ylab("Marker ranking") + ggtitle("Citeseq Human B cell")
# dev.off()

```

# Final ranking

```{r}
load("citeseq.de.b..RData")
df.fc.re <- fc.b
df.fc.re$avg_log2FC <- abs(df.fc.re$avg_log2FC)
df.fc.re <- df.fc.re[order(df.fc.re$avg_log2FC, decreasing = T), ]

t.cells.genes <- c("CR2", "CD72", "CD22", "IGHD", "CD19", "TNFRSF13C", "Ms4a1", "NT5E", "IGHM", "ICOSLG")

t.cells.genes <- toupper(t.cells.genes)

df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(de.b.t))),
                   wilcox.test <- c(match(gene, rownames(de.b.wilcox))),
                   mast <- c(match(gene, rownames(de.b.mast))),
                   LR <- c(match(gene, rownames(de.b.lr))),
                   roc <- c(match(gene, rownames(de.b.roc))),
                   FC <- c(match(gene, rownames(df.fc.re))),
                   Hypergate  <- c(match(gene, df.b.f1$gene)),
                   sc2panel <- c(match(gene, df.b.f5$gene)),
                   sc2panel2 <- c(match(gene, df.b.sc2$gene))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR","ROC", "FC", "Hypergate", "sc2panel", "sc2panel2")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

load("citeseq.de.dc.RData")
df.fc.re <- fc.b
df.fc.re$avg_log2FC <- abs(df.fc.re$avg_log2FC)
df.fc.re <- df.fc.re[order(df.fc.re$avg_log2FC, decreasing = T), ]

t.cells.genes <- c("IL3RA", "NRP1")

t.cells.genes <- toupper(t.cells.genes)

# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(de.dc.t))),
                   wilcox.test <- c(match(gene, rownames(de.dc.wilcox))),
                   mast <- c(match(gene, rownames(de.dc.mast))),
                   LR <- c(match(gene, rownames(de.dc.lr))),
                   roc <- c(match(gene, rownames(de.dc.roc))),
                   FC <- c(match(gene, rownames(df.fc.re))),
                   Hypergate  <- c(match(gene, df.dc.f1$gene)),
                   sc2panel <- c(match(gene, df.dc.f5$gene)),
                   sc2panel2 <- c(match(gene, df.dc.sc2$gene))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR","ROC", "FC", "Hypergate", "sc2panel", "sc2panel2")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

load("citeseq.de.mono.RData")
df.fc.re <- fc.b
df.fc.re$avg_log2FC <- abs(df.fc.re$avg_log2FC)
df.fc.re <- df.fc.re[order(df.fc.re$avg_log2FC, decreasing = T), ]

t.cells.genes <- c("CD86", "FCGR1A", "ITGAM", "PVR", "CD14")

t.cells.genes <- toupper(t.cells.genes)

# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(de.mono.t))),
                   wilcox.test <- c(match(gene, rownames(de.mono.wilcox))),
                   mast <- c(match(gene, rownames(de.mono.mast))),
                   LR <- c(match(gene, rownames(de.mono.lr))),
                   roc <- c(match(gene, rownames(de.mono.roc))),
                   FC <- c(match(gene, rownames(df.fc.re))),
                   Hypergate  <- c(match(gene, df.mono.f1$gene)),
                   sc2panel <- c(match(gene, df.mono.f5$gene)),
                   sc2panel2 <- c(match(gene, df.mono.sc2$gene))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR","ROC", "FC", "Hypergate", "sc2panel", "sc2panel2")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

load("citeseq.de.cd8t.RData")
df.fc.re <- fc.b
df.fc.re$avg_log2FC <- abs(df.fc.re$avg_log2FC)
df.fc.re <- df.fc.re[order(df.fc.re$avg_log2FC, decreasing = T), ]

t.cells.genes <- c("CD8B", "CD8A")

t.cells.genes <- toupper(t.cells.genes)

# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(de.cd8t.t))),
                   wilcox.test <- c(match(gene, rownames(de.cd8t.wilcox))),
                   mast <- c(match(gene, rownames(de.cd8t.mast))),
                   LR <- c(match(gene, rownames(de.cd8t.lr))),
                   roc <- c(match(gene, rownames(de.cd8t.roc))),
                   FC <- c(match(gene, rownames(df.fc.re))),
                   Hypergate  <- c(match(gene, df.cd8t.f1$gene)),
                   sc2panel <- c(match(gene, df.cd8t.f5$gene)),
                   sc2panel2 <- c(match(gene, df.cd8t.sc2$gene))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR","ROC", "FC", "Hypergate", "sc2panel", "sc2panel2")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}


load("citeseq.de.cd4t.RData")
df.fc.re <- fc.b
df.fc.re$avg_log2FC <- abs(df.fc.re$avg_log2FC)
df.fc.re <- df.fc.re[order(df.fc.re$avg_log2FC, decreasing = T), ]

t.cells.genes <- c("CD4")

t.cells.genes <- toupper(t.cells.genes)

# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(de.cd4t.t))),
                   wilcox.test <- c(match(gene, rownames(de.cd4t.wilcox))),
                   mast <- c(match(gene, rownames(de.cd4t.mast))),
                   LR <- c(match(gene, rownames(de.cd4t.lr))),
                   roc <- c(match(gene, rownames(de.cd4t.roc))),
                   FC <- c(match(gene, rownames(df.fc.re))),
                   Hypergate  <- c(match(gene, df.cd4t.f1$gene)),
                   sc2panel <- c(match(gene, df.cd4t.f5$gene)),
                   sc2panel2 <- c(match(gene, df.cd4t.sc2$gene))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR","ROC", "FC", "Hypergate", "sc2panel", "sc2panel2")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
# de.b.xx[order(de.b.xx$x.margin, decreasing = T),]
# df

df.melt <- melt(df)

# ggplot(df.melt, aes(x=variable, y = value, fill = variable))+
#   geom_boxplot()+
#   xlab("Test") + ylab("Marker ranking") + ggtitle("Citeseq Human B cell")

library(scales)

squash_axis <- function(from, to, factor) { 
    # Args:
    #   from: left end of the axis
    #   to: right end of the axis
    #   factor: the compression factor of the range [from, to]

  trans <- function(x) {    
      # get indices for the relevant regions
      isq <- x > from & x < to
      ito <- x >= to

      # apply transformation
      x[isq] <- from + (x[isq] - from)/factor
      x[ito] <- from + (to - from)/factor + (x[ito] - to)

      return(x)
  }

  inv <- function(x) {
      # get indices for the relevant regions
      isq <- x > from & x < from + (to - from)/factor
      ito <- x >= from + (to - from)/factor

      # apply transformation
      x[isq] <- from + (x[isq] - from) * factor
      x[ito] <- to + (x[ito] - (from + (to - from)/factor))

      return(x)
  }

# return the transformation
  return(trans_new("squash_axis", trans, inv))
}


pdf("plots/citeseq.ranking.boxplot.pdf", width = 7, height = 5)
ggplot(df.melt, aes(x=variable, y = value, fill = variable))+
  geom_boxplot()+
  coord_trans(y = squash_axis(2000, 9000, 30)) + xlab("Test") + ylab("Marker ranking") + ggtitle("Markers Ranking in HCA")+
  theme_bw() + scale_color_lancet()
dev.off()

df

ggplot(df.melt, aes(x=variable, y = value, fill = variable))+
  geom_boxplot()+
  coord_trans(y = squash_axis(2000, 9000, 30)) + xlab("Test") + ylab("Marker ranking") + ggtitle("Markers Ranking in HCA")+
  theme_bw() + scale_color_lancet()
```


```{r}


genes.c <- vector("list")
genes.c[["B"]] <- data.frame(adt.n = c("CR2", "CD72", "CD22", "IGHD", "CD19", "TNFRSF13C", "Ms4a1", "NT5E", "IGHM", "ICOSLG"),
                             sct.n = c("CD21", "CD72", "CD22","IgD", "CD19", "CD268", "CD20", "CD73", "IgM", "CD275-2"))
celltype <- c("B", "Mono", "DC", "CD4 T", "CD8 T")
for (cell.x in celltype) {
  gene.df <- genes.c[[cell.x]]
  for (variable in vector) {
    
  }
  
}

genes.c[["B"]] <- data.frame(adt.n = c("CD123", "CD304", "CD271"),
                             sct.n = c("IL3RA", "NRP1", "NGFR"))

Idents(citeseq) <- "celltype.l1"
adt.n <- "CD4-2"
sct.n <- "CD4"
cell.id <- "CD4 T"

DefaultAssay(citeseq) <- "SCT"
sct.c <-FetchData(citeseq, vars = c(sct.n))
DefaultAssay(citeseq) <- "ADT"
adt.c <-FetchData(citeseq, vars = c(adt.n, "ident"))

df.c <- cbind(sct.c, adt.c)

colnames(df.c) <- c(paste(sct.n, "RNA", sep = " "), paste(adt.n, " Protein"), "Ident")
df.c$Ident <- ifelse(df.c$Ident == cell.id, cell.id, "Other")

# df.c[,1] <- normalize(df.c[,1])
# df.c[,2] <- normalize(df.c[,2])

df.s <- melt(df.c)
ggplot(df.s, aes(x=value, y=variable, color=Ident, point_color=Ident, fill=Ident)) +
  
  geom_density_ridges(
    jittered_points=FALSE, scale = .95, rel_min_height = .01
  ) + 
  scale_y_discrete(expand = c(.01, 0)) +
  # scale_x_continuous(expand = c(0, 0), name = "Expression") +
  scale_fill_manual(values = c("#CB181D80", "#2171B580")) +
  scale_color_manual(values = c("#CB181D80", "#2171B580"), guide = "none") +
  scale_discrete_manual("point_color", values = c("#CB181D80", "#2171B580"), guide = "none") +
  guides(fill = guide_legend(
    override.aes = list(
      fill = c("#CB181D80", "#2171B580"),
      color = NA, point_color = NA))
  ) +
  theme_ridges(center = TRUE) +
  xlim(0.3, 2.5) + ylab("") + ggtitle(paste(sct.n)) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )#+ xlim(0, 1)

p1 <- ggplot(mpg, aes(displ, hwy)) +
  geom_point()
p1
p1 +
  scale_x_continuous("Engine displacement (L)") +
  scale_y_continuous("Highway MPG")
p1 + labs(x = NULL, y = NULL)
p1 + scale_x_continuous(limits = c(2, 6))
p1 + xlim(2, 6)
```



```{r}
paletteLength <- 6
myColor <- colorRampPalette(c("red", "white"))(paletteLength)

quantile_breaks <- function(xs, n = 10) {
  breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}

mat_breaks <- quantile_breaks(df$sc2panel, n = 11)

mat_breaks <- seq(1, 500, length.out = 10)

# pdf("CIteseq.Bcell.markers.ranking.heatmap.pdf", width = 7, height = 5)
pheatmap(df, 
         color=myColor,
         cluster_row = FALSE, 
         breaks = mat_breaks,
         cluster_col = FALSE,  na_col = "#000000", angle_col = "45")
# dev.off()

pdf("CIteseq.Bcell.markers.ranking.heatmap.log_of_ranking.pdf", width = 7, height = 5)
pheatmap(log2(df), 
         color=myColor, cluster_row = FALSE, 
         # breaks = mat_breaks,
         cluster_col = FALSE,  na_col = "#000000", angle_col = "45")
dev.off()

```


```{r}
DefaultAssay(scrna) <- "ADT"
Idents(scrna) <- "celltype.l1"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD14")


get_split_pos.1(scrna, "CD14", "Mono")
get_split_pos.1(scrna, "S100A9", "Mono")

df.mono <- data.frame()
for (gene in rownames(makers.mono)[1:30]) {
  df.s <- get_split_pos.1(scrna, gene, "Mono")
  df.mono <- rbind(df.mono, df.s)
}
df.mono[order(df.mono$x.margin.adj, decreasing = T), ]


DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, "CD14")


get_gene_PRAUC_pos_matrix(scrna, "CD72", "B")
df <- data.frame()
for (gene in rownames(makers.b[makers.b$avg_log2FC > 0, ])) {
  df.prauc <- get_gene_PRAUC_pos(scrna, gene, "B")
  df.s <- data.frame(gene, df.prauc)
  df <- rbind(df, df.s)
}

df[order(df$df.prauc, decreasing = T), ]
markers.b.roc

df.m <- get_gene_PRAUC_pos_matrix(scrna, "CD72", "B")

plot(df.m$x.rec, df.m$x.pre)

markers.b.roc <- FindMarkers(scrna, ident.1 = "B", test.use = "roc")


for (gene in rownames(markers.b.t)) {
  df.s <- get_split_pos.2(citeseq, gene, "B")
  df.mono <- rbind(df.mono, df.s)
}                                       
df.mono[order(df.mono$x.margin.adj, decreasing = T), ]


df.b <- data.frame()
for (gene in rownames(markers.b.t)) {
  df.s <- get_split_pos.2(citeseq, gene, "B")
  df.b <- rbind(df.b, df.s)
}
df.b <- df.b[order(df.b$x.margin.adj, decreasing = T), ]

df.nk <- data.frame()
for (gene in rownames(markers.nk.t)) {
  df.s <- get_split_pos.2(citeseq, gene, "NK")
  df.nk <- rbind(df.nk, df.s)
}
df.nk <- df.nk[order(df.nk$x.margin.adj, decreasing = T), ]

df.mono <- data.frame()
for (gene in rownames(markers.mono.t)) {
  df.s <- get_split_pos.2(citeseq, gene, "Mono")
  df.mono <- rbind(df.mono, df.s)
}
df.mono <- df.mono[order(df.mono$x.margin.adj, decreasing = T), ]


df.cd4t <- data.frame()
for (gene in rownames(markers.cd4t.t)) {
  df.s <- get_split_pos.2(citeseq, gene, "CD4 T")
  df.cd4t <- rbind(df.cd4t, df.s)
}
df.cd4t <- df.cd4t[order(df.cd4t$x.margin.adj, decreasing = T), ]


```


```{r}
start_time <- Sys.time()
all.markers.t <- FindAllMarkers(citeseq, test.use = "t")
end_time <- Sys.time()
end_time - start_time

round(normalize(mca.spleen@assays$RNA@data["Cd19",]),3)

get_split_pos.3 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = round(normalize(scrna@assays$RNA@data[gene,]), 3),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)

  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(0, 1, step)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)
    data.i.a <- data.id[data.id$exp > x.val, ]
    data.o.a <- data.other[data.other$exp > x.val, ]
    data.i.b <- data.id[data.id$exp <= x.val, ]
    data.o.b <- data.other[data.other$exp <= x.val, ]

    x.margin <- sum((data.i.a$exp - x.val))*nrow(data.o.b) +
      sum((x.val -data.o.b$exp))*nrow(data.i.a) -
      sum((data.o.a$exp - x.val))*nrow(data.o.b)
    x.margin <- x.margin/data.all.l

    # x.margin <- sum((data.id[data.id$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id) +
    #   sum((x.val - data.other[data.other$exp <x.val, ]$exp))*length(data.id[data.id$exp > x.val, ]$id) -
    #   sum((data.other[data.other$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id)

    x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

start_time <- Sys.time()
get_split_pos.2(scrna, "Cd19", "B Cell(Lung)")
end_time <- Sys.time()
end_time - start_time

start_time <- Sys.time()
get_split_pos.3(scrna, "Cd19", "B Cell(Lung)")
end_time <- Sys.time()
end_time - start_time

```



```{r}
get_split_pos.1(scrna, "LINC02397", "B")
get_split_pos.1(scrna, "CD79A", "B")
get_split_pos.1(scrna, "CD16", "B")

DefaultAssay(scrna) <- "ADT"
markers.adt <- FindAllMarkers(scrna, test.use = "t")
markers.adt.list <- split(markers.adt, markers.adt$cluster)
markers.adt.list <- lapply(markers.adt.list, subset, subset = p_val_adj < 0.05)
DimPlot(scrna, group.by = "celltype.l1", reduction = "wnn.umap", label = T)
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD16")

DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, " CD")

markers.adt.intersect.list <- list()
for (cluster in names(markers.adt.list)) {
  df <- markers.adt.list[[cluster]]
  df <- df[df$gene %in% intersect(rownames(scrna[["ADT"]]), rownames(scrna[["SCT"]])), ]
  df <- df[order(df$avg_log2FC, decreasing = T),]
  markers.adt.intersect.list[[cluster]] <- df
}

```


```{r}
markers.t.list
```

```{r}
get_split_pos.1(scrna, "CD14", "Mono", step = 0.1)
```



```{r}
intersect(rownames(scrna[["ADT"]]), rownames(scrna[["SCT"]]))

DefaultAssay(scrna) <- "SCT"
FeaturePlot(scrna, "CLEC12A", reduction = "wnn.umap")
DimPlot(scrna, group.by = "celltype.l1", reduction = "wnn.umap", label = T)
VlnPlot(scrna, "CLEC12A")
```

```{r}
get_split_pos.1(scrna.1, "CD22", "B")
get_split_pos.1(scrna, "CNTNAP2", "B")
get_split_pos.1(scrna, "CD79A", "B")
get_split_pos.1(scrna.1, "CD19", "B")
get_split_pos.1(scrna.1, "CD72", "B")
get_split_pos.1(scrna, "CLEC12A", "Mono")

```



```{r}
DefaultAssay(scrna) <- "ADT"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD72")

DefaultAssay(scrna) <- "SCT"
VlnPlot(scrna, "CD72")
VlnPlot(scrna, "CD19")
```



```{r}
df <- data.frame()
for (gene in c(rownames(makers.b[makers.b$avg_log2FC > 0, ]), "CD19")) {
  df.s <- get_split_pos.1(citeseq, gene, "B")
  df <- rbind(df, df.s)
}

df[order(df$x.margin, decreasing = T), ]


df.dc <- data.frame()
for (gene in rownames(markers.dc.t)) {
  df.s <- get_split_pos.2(citeseq, gene, "DC")
  df.dc <- rbind(df.dc, df.s)
}

df.dc <- df.dc[order(df.dc$x.margin.adj, decreasing = T), ]


df.5 <- data.frame()
for (gene in rownames(makers.b[makers.b$avg_log2FC > 0, ])) {
  df.s <- get_split_pos.1(scrna, gene, "B")
  df.5 <- rbind(df.5, df.s)
}

df.5[order(df.5$x.margin.adj, decreasing = T), ]
makers.b
makers.b["CD19",]
makers.b["CD22",]
df.5["CD79A",]

DefaultAssay(scrna) <- "ADT"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD24")

DefaultAssay(scrna) <- "SCT"
FeaturePlot(scrna,  reduction = "wnn.umap", features = "CD79A")
Idents(scrna) <- "celltype.l1"
markers.t <- FindAllMarkers(scrna, test.use = "t")
markers.wilcox <- FindAllMarkers(scrna, test.use = "wilcox")
markers.wilcox.list <- split(markers.wilcox, markers.wilcox$cluster)
markers.wilcox.list <- lapply(markers.wilcox.list, subset, subset = p_val_adj < 0.05)

# save(markers.wilcox.list, file = "citeseq.markers.wilcoc.rds")
# save(markers.t.list, file = "citeseq.markers.t.rds")

markers.t.list <- split(markers.t, markers.t$cluster)
markers.t.list <- lapply(markers.t.list, subset, subset = p_val_adj < 0.05)
cluster <- "B"
markers.list.rerank.2 <- list()
for (cluster in names(markers.t.list)) {
  df <- data.frame()
  markers.list <- markers.t.list[[cluster]]
  print(paste(cluster))
  
  for (gene in markers.list$gene) {
    df.s <- get_split_pos.1(scrna, gene, cluster)
    df <- rbind(df, df.s)
  }
  markers.list.rerank.2[[cluster]] <- df
}

markers.list.rerank.2.sort <- list()
for (cluster in names(markers.list.rerank)) {
  markers.list <- markers.list.rerank.2[[cluster]]
  markers.list <- markers.list[order(markers.list$x.margin.adj, decreasing = T), ]
  markers.list
  markers.list.rerank.2.sort[[cluster]] <- markers.list
}

markers.list.rerank.1[["DC"]][intersect(rownames(scrna[["ADT"]]), rownames(scrna[["SCT"]])),]

markers.wilcox.list[["Mono"]][rownames(markers.list.rerank.1[["Mono"]])[1:50],]


VlnPlot(scrna.1, "FCAR")
VlnPlot(scrna.1, "CD14")
hist(as.numeric(scrna[["SCT"]]["FCAR", ]))

scrna <- NormalizeData(scrna, assay = "SCT")

save(markers.list.rerank.1, file = "citeseq.markers.rerank.rds")

```

```{r}
get_split_pos.1(scrna, "CLEC12A", "Mono")
```

```{r}
VlnPlot(scrna, "CLEC12A")
```


```{r}
get_split_pos.1(scrna.1, "CD19", "B")
get_split_pos.1(scrna.1, "CD79A", "B")

get_split_pos.1(scrna.1, "CD14", "Mono")
get_split_pos.1(scrna.1, "S100A12", "Mono")

df.b.1 <- data.frame()
for (gene in c(rownames(makers.b[makers.b$avg_log2FC > 0, ])[1:50], "CD19", "CD24")) {
  df.s <- get_split_pos.1(scrna, gene, "B")
  df.b.1 <- rbind(df.b.1, df.s)
}

df.b.1[order(df.b.1$x.margin.adj, decreasing = T), ]
```


```{r}
makers.mono["WLS",]
makers.mono["VSTM1",]
makers.b
makers.b["CD79A",]
makers.b["CD22",]
get_split_pos.1(scrna, "CD14", "Mono")
get_split_pos.1(scrna, "AC245128.3", "Mono")
get_split_pos.1(scrna, "CD79A", "B")
get_split_pos.1(scrna, "CD22", "B")
get_split_pos.1(scrna, "CD19", "B")
get_split_pos.1(scrna, "LINC00926", "B")

sum(scrna@active.ident == "B")

hist(as.numeric(scrna@assays$SCT@data["CD14", ]))
hist(as.numeric(scrna@assays$SCT@data["WLS", ]))

VlnPlot(scrna, "SLC11A1")


df.b.1 <- data.frame()
for (gene in c(rownames(makers.b[makers.b$avg_log2FC > 0, ])[1:50], "CD19", "CD24")) {
  df.s <- get_split_pos.1(scrna, gene, "B")
  df.b.1 <- rbind(df.b.1, df.s)
}

df.b.1[order(df.b.1$x.margin.adj, decreasing = T), ]


df.mono.1 <- data.frame()
pb <- txtProgressBar(style=3)
i <- 1
for (gene in rownames(makers.mono[makers.mono$avg_log2FC > 0, ])) {
  df.s <- get_split_pos.1(scrna, gene, "Mono", step = 0.1)
  df.mono.1 <- rbind(df.mono.1, df.s)
  setTxtProgressBar(pb, i/length(rownames(makers.mono[makers.mono$avg_log2FC > 0, ])))
  i <- i + 1
}
close(pb)

df.mono.1 <- df.mono.1[order(df.mono.1$x.margin.adj, decreasing = T), ]
df.mono.1

# get_split_pos.1(scrna, "WLS", "Mono")

get_split_pos.1(scrna, "AC245128.3", "Mono")

DefaultAssay(scrna) <- "SCT"
df.mono.1
VlnPlot(scrna, "CPSF2")
```

```{r}
get_split_pos.1(scrna, "CD22", "B", step = 0.1)
get_split_pos.1(scrna, "CD19", "B", step = 0.1)
get_split_pos.1(scrna, "CD79A", "B", step = 0.1)
get_split_pos.1(scrna, "CD14", "Mono", step = 0.1)
get_split_pos.1(scrna, "CLEC12A", "Mono", step = 0.1)
VlnPlot(scrna, "CPSF2")
```



```{r}
matrix_cometsc <- Seurat::GetAssayData(citeseq, slot = "data", assay = "SCT") #gets the normalized count matrix

library(Matrix)
write(colnames(matrix_cometsc), file = "colnames.txt")
write(rownames(matrix_cometsc), file = "rownames.txt")
writeMM(matrix_cometsc, file = "sparsematrix.txt")

write.table(matrix_cometsc, file= "citeseq.matrix.1.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)

umap_cometsc <- Embeddings(citeseq, reduction = "wnn.umap")
write.table(umap_cometsc, file="vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

citeseq@meta.data$numer_id <- as.numeric(citeseq@active.ident)
Idents(citeseq) <- "numer_id"
cluster_cometsc <- noquote(as.matrix(Idents(citeseq))) # Get the active cluster identities. Should be numbers. COMET does not take Non-Number cluster names.

write.table(cluster_cometsc, file = "citeseq.clusters.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)
write.table(top50_markers_MAST_res1_pct25$gene, file = "genes.txt", col.names = F, row.names = F, quote = F)
```


```{r}
t.cells.genes <- c("Cd19", "Cd79b", "Ms4a1", "Cd22")
t.cells.genes <- toupper(t.cells.genes)

df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.b.t))),
                   wilcox.test <- c(match(gene, rownames(markers.b.wilcox))),
                   mast <- c(match(gene, rownames(markers.b.mast))),
                   LR <- c(match(gene, rownames(markers.b.lr))),
                   SD <- c(match(gene, rownames(df.b)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

########################################################################################################################################
t.cells.genes <- c("Klrb1", "Ncr1")
t.cells.genes <- toupper(t.cells.genes)
# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.nk.t))),
                   wilcox.test <- c(match(gene, rownames(markers.nk.wilcox))),
                   mast <- c(match(gene, rownames(markers.nk.mast))),
                   LR <- c(match(gene, rownames(markers.nk.lr))),
                   SD <- c(match(gene, rownames(df.nk)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

t.cells.genes <- c("Cd3d", "Cd3e", "Cd3g")
t.cells.genes <- toupper(t.cells.genes)
# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t))),
                   wilcox.test <- c(match(gene, rownames(markers.nk.wilcox))),
                   mast <- c(match(gene, rownames(markers.nk.mast))),
                   LR <- c(match(gene, rownames(markers.nk.lr))),
                   SD <- c(match(gene, rownames(df.nk)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,60), fmt.key="%.0f", na.print='Missing', main = "Cell markers")

# pdf("plots/Lung.markers.plotmatrix.pdf", height = 7, width = 10)
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,60), fmt.key="%.0f", na.print='Missing', main = "Cell markers")
# dev.off()

annotation_col = data.frame(
  GeneClass = factor(rep(c("B cells", "NK cells", "T cells"), c(5, 3, 3)))
                )
rownames(annotation_col) = rownames(df)

paletteLength <- 6
myColor <- colorRampPalette(c("red", "white"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c( 
              seq(70/paletteLength, 70, length.out=floor(paletteLength)))

pheatmap(t(df), color=myColor, breaks=myBreaks, cluster_row = FALSE, cluster_col = FALSE, annotation_col = annotation_col,  na_col = "#000000", angle_col = "45")

# pdf("plots/Lung.markers.pheatmap.pdf", height = 7, width = 10)
pheatmap(t(df), color=myColor, breaks=myBreaks, cluster_row = FALSE, cluster_col = FALSE, annotation_col = annotation_col,  na_col = "#000000", angle_col = "45")
# dev.off()
```




```{r}
# # Normalize ADT data,
# DefaultAssay(cbmc) <- "ADT"
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2)
# DefaultAssay(cbmc) <- "RNA"
# 
# # Note that the following command is an alternative but returns the same result
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2, assay = "ADT")

# Now, we will visualize CD14 levels for RNA and protein By setting the default assay, we can
# visualize one or the other
DefaultAssay(cbmc) <- "ADT"
p1 <- FeaturePlot(cbmc, "CD8", cols = c("lightgrey", "darkgreen")) + ggtitle("CD19 protein")
DefaultAssay(cbmc) <- "RNA"
p2 <- FeaturePlot(cbmc, "CD8") + ggtitle("CD19 RNA")

rownames(cbmc[["ADT"]])

for (gene in intersect(rownames(cbmc[["ADT"]]), rownames(cbmc[["RNA"]]))) {
  print(FeaturePlot(cbmc, gene, cols = c("lightgrey", "darkgreen")))
}

intersect(rownames(cbmc[["ADT"]]), rownames(cbmc[["RNA"]]))

# place plots side-by-side
p1 | p2
```

# Get single markers from Seurat and PRAUC

```{r warning=F}
Idents(cbmc) <- "seurat_clusters"

# markers.wilcox <- list()
# markers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   markers <- FindMarkers(cbmc, ident.1 = x.cluster, features = intersect(rownames(cbmc[["RNA"]]), markers.allset))
#   markers <- markers[order(markers$avg_log2FC, decreasing = T),]
#   markers.wilcox[[x.cluster]] <- markers
#   markers.i <- identify_single_marker(cbmc, x.cluster, markers.allset)
#   markers.prauc[[x.cluster]] <- markers.i
# }

# save(markers.wilcox, file = "first8.seuratDE.markers.rds")
# save(markers.prauc, file = "first8.prauc.markers.rds")

load(file = "first8.seuratDE.markers.rds")
load(file = "first8.prauc.markers.rds")

Idents(cbmc) <- "seurat_clusters"
markers.i <- identify_single_marker(cbmc, "12", markers.allset)

```



Compare top 9 marker from DE and prauc based method

# Plot PRAUC of TOP 9 Positive markers from DE and prauc based ranking

```{r}
Idents(cbmc) <- "seurat_clusters"

for (x.cluster in seq(1,8)) {
  df.prauc <- markers.prauc[[x.cluster]]
  df.wilcox <- markers.wilcox[[x.cluster]]
  
  g <- ggplot()
  for (genes in intersect(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc$gene[1:9], rownames(df.wilcox)[1:9])) {
    if (df.prauc[df.prauc$gene == genes, ]$direction == "+") {
      df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }else{
      df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }
  }
  print(g)
}

```


# Plot PRAUC of TOP 12 markers from COMET and prauc ranking

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
x.cluster <- 12
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_singleton_all_ranked.csv", sep = ""))
  genes <- genes[1:10, ]
  comet.genes.pos <- genes[genes$Log2FoldChange > 0, ]$gene_1
  comet.genes.neg <- genes[genes$Log2FoldChange < 0, ]$gene_1
  comet.genes.neg <-gsub("_negation", "", comet.genes.neg)
  
  df.prauc <- markers.prauc[[x.cluster]]
  df.prauc <- df.prauc[1:10,]
  df.prauc.pos <- df.prauc[df.prauc$direction == "+", ]$gene
  df.prauc.neg <- df.prauc[df.prauc$direction == "-", ]$gene
  
  g <- ggplot()
  for (genes in intersect(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.pos, comet.genes.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  
  for (genes in intersect(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.neg, comet.genes.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  print(g + xlab("Recall") + ylab("Precision") + ggtitle(paste(x.cluster)))
}

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, comet.genes.pos)
VlnPlot(cbmc, df.prauc.pos)
genes[genes$gene_1 == "CD11c", ]
df.prauc[df.prauc$gene== "CD11c",]
genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", "12", "_singleton_all_ranked.csv", sep = ""))
genes
markers.prauc[[6]]
genes$hgrank + genes$fcrank
markers.i
cbmc <- makeid(cbmc, "12")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "PROM1")
VlnPlot(cbmc, "CD34")
VlnPlot(cbmc, "SPINK2")

Idents(cbmc) <- "seurat_clusters"
cbmc.6 <- subset(cbmc, idents = "6")
cbmc.other <- subset(cbmc, idents = "6", invert = TRUE)
mean(cbmc.6@assays$RNA@data["CD37",])/mean(cbmc.other@assays$RNA@data["CD37",])
mean(cbmc.6@assays$RNA@data["CD19",])/mean(cbmc.other@assays$RNA@data["CD19",])
0.8571429*6.0270978
0.6857143*8.3523919
```

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "HLA-DOB")
VlnPlot(cbmc, df.prauc.pos)


get_split_pos.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- mean(data.id$exp)/mean(data.other$exp)
  # df <- data.frame(sum(data.other$exp == 0), length(data.other$exp))
  # return(df)
  # x.factor <- length(data.other$id)/length(data.id$id)
  

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id[data.id$exp >= x.val, ]$exp)
    fp <- sum(data.other[data.id$exp >= x.val, ]$exp)
    tn <- sum(data.other$exp < x.val)
    fn <- sum(data.id$exp < x.val)

    if (length(data.id$id) <= length(data.other$id)) {
      x.margin <- tp - fp
    }
    else{
      x.margin <- tp - fp
    }
    x.margin <- (x.factor**2)*x.margin
    
    de <- data.frame(x.val, x.margin, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
VlnPlot(cbmc, "HLA-DOB")
get_split_pos.1(cbmc, "CD19", "6")
get_split_pos.1(cbmc, "HLA-DOB", "6")
get_split_pos.1(cbmc, "CD79B", "6")

df <- data.frame()
for (gene in markers.prauc[[6]]$gene[1:20]) {
  df.s <- get_split_pos.1(cbmc, gene, "6")
  df <- rbind(df, df.s)
}
df[order(df$x.margin, decreasing = T), ]

markers.wilcox[[6]]

Idents(cbmc) <- "seurat_clusters"
markers.wilcox.6 <- FindMarkers(cbmc, ident.1 = "12", test.use = "LR")
markers.wilcox.6["CD19",]
markers.wilcox.6["HLA-DOB",]

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, "VPREB3")
VlnPlot(cbmc, "CD19")

markers.i
get_split_pos.1(cbmc, "CD34", "12")
get_split_pos.1(cbmc, "CRHBP", "12")
get_split_pos.1(cbmc, "SPINK2", "12")

```


# Detect combine markers for interested cell groups

```{r}
# makers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   df.split <- Detect_combine_markers(cbmc, x.cluster, markers.allset, max.gene = 50)
#   makers.prauc[[x.cluster]] <- df.split
# }

load(file = "first8clusters.combine.markers.rds")

makers.prauc

id <- "7"
df <- data.frame(exp1 = cbmc@assays$RNA@data["MYL3",],
                 exp2 = cbmc@assays$RNA@data["TMSB4X",],
                 id = as.character(cbmc@active.ident))


df.i <- df[df$id == "5", ]
df.o <- df[df$id != "5", ]

cor(df.i$exp1, df.i$exp2)
cor(df.o$exp1, df.o$exp2)

x.seq <- 1
df.all <- data.frame()
for (x.seq in 1:nrow(makers.prauc[[5]])) {
  gene.c <- makers.prauc[[5]][x.seq,]
  df <- data.frame(exp1 = cbmc@assays$RNA@data[gene.c$Gene1,],
                   exp2 = cbmc@assays$RNA@data[gene.c$Gene2,],
                   id = as.character(cbmc@active.ident))
  df.i <- df[df$id == "5", ]
  df.o <- df[df$id != "5", ]
  # print(gene.c)
  df.s <- data.frame(gene.c$Gene1, gene.c$Gene2, cor(df.i$exp1, df.i$exp2), cor(df.o$exp1, df.o$exp2))
  colnames(df.s) <- c("gene1", "gene2", "cor.i", "cor.o")
  df.all <- rbind(df.all, df.s)
}

cbmc <- makeid(cbmc, "5")
df <- data.frame(exp1 = cbmc@assays$RNA@data["MYL3",],
                 exp2 = cbmc@assays$RNA@data["MT-CO2",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data["MYL3",],
                 exp2 = cbmc@assays$RNA@data["TMSB4X",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))
df.all

```



```{r fig.width=10, fig.height=8}
scrna <- cbmc
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  
  # x.df <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.1)
  # x.df$method <- "COMET"
  
  if (!grepl("_negation", genes[1])) {
    if (!grepl("_negation", genes[2])) {
      gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }else{
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }else{
      if (!grepl("_negation", genes[2])) {
        genes[1] <- gsub("_negation", "", genes[1])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[2], gene2 = genes[1], id = x.cluster, step = 0.01)
      }else{
        genes[1] <- gsub("_negation", "", genes[1])
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }

  x.df <- gene.prauc
  x.df$method <- "COMET"
  # g <- ggplot() + geom_line(gene.prauc.comet, mapping = aes(x.rec, x.pre, color = method)) + xlim(c(0,1)) + ylim(c(0,1))
  
  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  Direction.c <- paste(df.split[1, ]$Direction1, df.split[1, ]$Direction2, sep = "")
  if (Direction.c == "++") {
    gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "+-") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "-+") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene2, gene2 = gene1, id = x.cluster, step = 0.01)
  }else{
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }
  
  x.df.2 <- gene.prauc
  x.df.2$method <- "PRAUC"
  
  x.df <- rbind(x.df, x.df.2)

  print(ggplot() + geom_line(x.df, mapping = aes(x.rec, x.pre, col = method)) + ggtitle(paste(x.cluster))+ 
          xlim(c(0,1)) + ylim(c(0,1)))
}
```


# Dotplot of Combine markers

```{r fig.width=10, fig.height=5}
for (x.cluster in seq(1,8)) {
  scrna <- makeid(scrna, x.cluster)
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_grid_2(cbmc, gene1, gene2, gene1.direc, gene2.direc, x.cluster, return.obj = T) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_grid_2(cbmc, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster, return.obj = T) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```





# Umap plot of combine markers

```{r fig.height = 7, fig.width=18}
Idents(cbmc) <- "seurat_clusters"
plot_marker_c_umap(cbmc, "TCL1A", "CD79B", "+", "+", "6")
scrna <- cbmc
Idents(scrna) <- "seurat_clusters"
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_marker_c_umap(scrna, gene1, gene2, gene1.direc, gene2.direc, x.cluster) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_marker_c_umap(scrna, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```

```{r}
cbmc.enhance <- enhance_seurat_wrapper(cbmc)
id <- "5"
gene1 <- "MYL3"
gene2 <- "FTH1"

df <- data.frame(exp1 = cbmc.enhance[gene1,],
                 exp2 = cbmc.enhance[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data[gene1,],
                 exp2 = cbmc@assays$RNA@data[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

```




# step by step (Maximam Recall approach)

```{r}
# markers.max_recall <- list()
# for (x.cluster in seq(1,8)) {
#   markers.i <- marker_stepbystep(cbmc, x.cluster, depth = 2, markers.allset)
#   markers.max_recall[[x.cluster]] <- markers.i
# }
# save(markers.max_recall, file = "first8.stepbystep.rds")
load(file = "first8.stepbystep.rds")
for (x.cluster in seq(1,8)) {
  markers.i <- markers.max_recall[[x.cluster]]
  print(grid_plot(cbmc, markers.i, x.cluster))
}


```                                                                                                                                                                                               

```{r}
matrix_cometsc <- Seurat::GetAssayData(so) #gets the normalized count matrix
write.table(as.matrix(matrix_cometsc), file= "markers.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)

umap_cometsc <- Embeddings(citeseq, reduction = "wnn.umap")
write.table(umap_cometsc, file="citeseq.vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

Idents(citeseq) <- "celltype.l1"

cluster_cometsc <- noquote(as.matrix(Idents(citeseq))) # Get the active cluster identities. Should be numbers. COMET does not take Non-Number cluster names.

write.table(cluster_cometsc, file = "citeseq.clusters.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

DefaultAssay(citeseq) <- "SCT"
write.table(rownames(citeseq[["SCT"]]), file = "citeseq.genes.txt", col.names = F, row.names = F, quote = F)


```



