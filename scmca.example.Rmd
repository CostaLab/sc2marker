---
title: "Cell marker identification with seurat samples"
author: "Ronghui"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
library(Seurat)
library(patchwork)
mca.matrix <- readRDS(file = "/home/ronghui/project/scMarkerDetect/MCA/MCA_merged_mat.rds")
mca.metadata <- read.csv(file = "/home/ronghui/project/scMarkerDetect/MCA/MCA_All-batch-removed-assignments.csv", row.names = 1)

# 3896.0100681384406 minutes
save.image(file = "mca.lung.mca.RData")
load("mca.lung.mca.RData")
```



```{r pressure, echo=FALSE, fig.height=9, fig.width=12}
mca <- CreateSeuratObject(counts = mca.matrix, meta.data = mca.metadata, project = "MouseCellAtlas")
# Only keep annotated cells
mca <- subset(mca, cells = names(which(!is.na(mca$ClusterID))))
# Leaves us with 242k cells
Idents(mca) <- "Tissue"
mca <- NormalizeData(mca, normalization.method = "LogNormalize", scale.factor = 10000)
mca.spleen <- subset(mca, idents = "Spleen")

unique(mca.spleen@active.ident)
rm(mca.matrix, mca.metadata)
```




```{r}
cell.anno <- read.csv(file=file.path("/home/ronghui/project/scMarkerDetect/MCA_CellAssignments.csv"))
cell.spleen <- cell.anno[grep("Spleen", cell.anno$Cell.name), ]
mca.spleen@meta.data$anno <- cell.spleen[match(colnames(mca.spleen), cell.spleen$Cell.name), ]$Annotation
Idents(mca.spleen) <- "anno"

mca.spleen@meta.data$anno.n <- as.numeric(Idents(mca.spleen))
table(mca.spleen$anno, mca.spleen$anno.n)
```

# Lung

```{r}
cell.lung <- cell.anno[grep("^Lung", cell.anno$Tissue), ]
table(cell.lung$Annotation)
mca.lung <- subset(mca, idents = "Lung")
cell.anno <- read.csv(file=file.path("/home/ronghui/project/scMarkerDetect/MCA_CellAssignments.csv"))

mca.lung@meta.data$anno <- cell.lung[match(colnames(mca.lung), cell.lung$Cell.name), ]$Annotation
Idents(mca.lung) <- "anno"
mca.lung@meta.data$anno.n <- as.numeric(Idents(mca.lung))
dt.lung <- as.matrix(table(mca.lung$anno, mca.lung$anno.n))
dt.lung
table(mca.lung@meta.data$anno)

mca.lung <- RenameIdents(object = mca.lung, `Dividing T cells(Lung)` = "T Cell(Lung)")
mca.lung <- RenameIdents(object = mca.lung, `T Cell_Cd8b1 high(Lung)` = "T Cell(Lung)")
mca.lung@meta.data$anno <- mca.lung@active.ident
```

```{r}
mca.lung <- FindVariableFeatures(mca.lung)
mca.lung <- ScaleData(mca.lung, verbose = FALSE)
mca.lung <- RunPCA(mca.lung, npcs = 30, verbose = FALSE)
mca.lung <- RunUMAP(mca.lung, reduction = "pca", dims = 1:30)
DimPlot(mca.lung, reduction = "umap", group.by = "anno")
FeaturePlot(mca.lung, features = c("Cd19"))
FeaturePlot(mca.lung, features = c("Ms4a1"))
FeaturePlot(mca.lung, features = c("Cd22"))

mca.spleen <- FindVariableFeatures(mca.spleen)
mca.spleen <- ScaleData(mca.spleen, verbose = FALSE)
mca.spleen <- RunPCA(mca.spleen, npcs = 30, verbose = FALSE)
mca.spleen <- RunUMAP(mca.spleen, reduction = "pca", dims = 1:30)
pdf("plots/spleen_umap.pdf")
DimPlot(mca.spleen, reduction = "umap", group.by = "anno", label = F)
dev.off()

pdf("plots/spleen_umap_B_highlight.pdf")
DimPlot(mca.spleen, reduction = "umap", group.by = "anno", label = F, cells.highlight = WhichCells(mca.spleen, idents = "Marginal zone B cell(Spleen)")) +
  ggtitle("") + theme(legend.position="none")
dev.off()

pdf("plots/spleen_B.pdf")
FeaturePlot(mca.spleen, features = c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22"), ncol = 2)
dev.off()

pdf("plots/spleen_T.pdf")
FeaturePlot(mca.spleen, features = c("Cd3d", "Cd3e", "Cd3g"), ncol = 2)
dev.off()

pdf("plots/spleen_NK.pdf")
FeaturePlot(mca.spleen, features = c("Klrb1c", "Klrb1a", "Ncr1"), ncol = 2)
dev.off()


pdf("plots/lung_umap.pdf", height = 7, width = 10)
DimPlot(mca.lung, reduction = "umap", group.by = "anno", label = F) +
  theme(legend.text = element_text(size=7)) + ggtitle("")
dev.off()

pdf("plots/lung_B.pdf")
FeaturePlot(mca.lung, features = c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22"), ncol = 2)
dev.off()

pdf("plots/lung_T.pdf")
FeaturePlot(mca.lung, features = c("Cd3d", "Cd3e", "Cd3g"), ncol = 2)
dev.off()

pdf("plots/lung_NK.pdf")
FeaturePlot(mca.lung, features = c("Klrb1c", "Klrb1a", "Ncr1"), ncol = 2)
dev.off()
```


```{r}
clusters <- c("B Cell(Lung)", "Alveolar macrophage_Ear2 high(Lung)", "NK Cell(Lung)", "Dendritic cell_Naaa high(Lung)", "T Cell(Lung)")
Idents(mca.lung) <- "anno"

lung.markers.wilcox <- list()
lung.markers.t <- list()
lung.markers.MAST <- list()
lung.markers.LR <- list()
for (x.cluster in clusters) {
  markers <- FindMarkers(mca.lung, ident.1 = x.cluster, test.use = "t", min.pct = 0.05)
  lung.markers.t[[x.cluster]] <- markers
  
  markers <- FindMarkers(mca.lung, ident.1 = x.cluster, test.use = "wilcox", min.pct = 0.05)
  lung.markers.wilcox[[x.cluster]] <- markers
  
  markers <- FindMarkers(mca.lung, ident.1 = x.cluster, test.use = "MAST", min.pct = 0.05)
  lung.markers.MAST[[x.cluster]] <- markers
  
  markers <- FindMarkers(mca.lung, ident.1 = x.cluster, test.use = "LR", min.pct = 0.05)
  lung.markers.LR[[x.cluster]] <- markers
}

# T cell
id <- "T Cell(Lung)"
De.lung.t <-FindMarkers(mca.lung, ident.1 = "T Cell(Lung)", test.use = "t", min.pct = 0.05)
# De.lung.t <- lung.markers.t[["T Cell_Cd8b1 high(Lung)"]]
De.lung.t <- subset(De.lung.t, p_val < 0.05)

lung.t <- data.frame()
for (gene in rownames(De.lung.t)) {
  df.s <- get_split_pos.2(mca.lung, gene, id, step = 0.01)
  lung.t <- rbind(lung.t, df.s)
}
lung.t <- lung.t[order(lung.t$x.margin.adj, decreasing = T), ]
lung.t

# B cell
id <- "B Cell(Lung)"
# De.lung.t <-FindMarkers(mca.spleen, ident.1 = "Marginal zone B cell(Spleen)", test.use = "t")
De.lung.b <- lung.markers.t[["B Cell(Lung)"]]
De.lung.b <- subset(De.lung.b, p_val < 0.05)

lung.b <- data.frame()
for (gene in rownames(De.lung.b)) {
  df.s <- get_split_pos.2(mca.lung, gene, id, step = 0.01)
  lung.b <- rbind(lung.b, df.s)
}
lung.b <- lung.b[order(lung.b$x.margin.adj, decreasing = T), ]
lung.b

# NK cell
id <- "NK Cell(Lung)"
# De.lung.t <-FindMarkers(mca.spleen, ident.1 = "Marginal zone B cell(Spleen)", test.use = "t")
De.lung.nk <- lung.markers.t[[id]]
De.lung.nk <- subset(De.lung.nk, p_val < 0.05)

lung.nk <- data.frame()
for (gene in rownames(De.lung.nk)) {
  df.s <- get_split_pos.2(mca.lung, gene, id, step = 0.1)
  lung.nk <- rbind(lung.nk, df.s)
}
lung.nk <- lung.nk[order(lung.nk$x.margin.adj, decreasing = T), ]
lung.nk
```

```{r}
# T cells in spleen 
t.cells.genes <- c("Cd3d", "Cd3e", "Cd3g")

# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_4_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[["T Cell(Lung)"]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[["T Cell(Lung)"]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[["T Cell(Lung)"]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[["T Cell(Lung)"]]))),
                   # Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.t)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "SD"))
# df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))

plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in T cell (Lung Tissue)"))
  plots[[gene]] <- p
  print(p)
}

plots <-Filter(Negate(is.null), plots)
pdf("plots/T_markers_ranking_Lung.pdf")
plot_grid(plotlist=plots, ncol=2)
dev.off()
```

```{r}
# B cells in Lung 

t.cells.genes <- c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22")

# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[["B Cell(Lung)"]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[["B Cell(Lung)"]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[["B Cell(Lung)"]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[["B Cell(Lung)"]]))),
                   # Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.b)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "SD"))
# df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))

plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in B cell (Lung Tissue)"))
  plots[[gene]] <- p
  print(p)
}

plots <-Filter(Negate(is.null), plots)
pdf("plots/B_markers_ranking_Lung.pdf")
plot_grid(plotlist=plots, ncol=2)
dev.off()
```

```{r}
t.cells.genes <- c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22")

# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[["B Cell(Lung)"]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[["B Cell(Lung)"]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[["B Cell(Lung)"]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[["B Cell(Lung)"]]))),
                   # Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.b)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

df.t <- as.data.frame(t(df))
df.order <- data.frame()
for (gene in colnames(df.t)) {
  df.s <- order(df.t[,gene])
  # colnames(df.s) <- colnames(df.t)
  df.order <- rbind(df.order, df.s)
}
colnames(df.order) <- colnames(df)
rownames(df.order) <- rownames(df)
df.order <- as.data.frame(t(df.order))

df.melt <- melt(t(df.order))
df.order <- rbind(df.order)

ggplot(df.melt) +
  geom_line(aes(Var1, value, group=Var2, color=Var2)) + scale_y_reverse() +
  ylab("Ranking") + xlab("Markers")
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,100), fmt.key="%.0f",)
# plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=range(t(df)))
########################################################################################################################################
t.cells.genes <- c("Klrb1c", "Klrb1a", "Ncr1")
id <- "NK Cell(Lung)"
df <- data.frame()
# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[[id]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[[id]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[[id]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[[id]]))),
                   # Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.nk)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

df.t <- as.data.frame(t(df))
df.order <- data.frame()
for (gene in colnames(df.t)) {
  df.s <- order(df.t[,gene])
  # colnames(df.s) <- colnames(df.t)
  df.order <- rbind(df.order, df.s)
}
colnames(df.order) <- colnames(df)
rownames(df.order) <- rownames(df)
df.order <- as.data.frame(t(df.order))

df.m <- melt(t(df.order))
df.order <- rbind(df.order)

ggplot(df.m) +
  geom_line(aes(Var1, value, group=Var2, color=Var2)) + scale_y_reverse() +
  ylab("Ranking") + xlab("Markers")
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,100), fmt.key="%.0f",)
# plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=range(t(df)))


t.cells.genes <- c("Cd3d", "Cd3e", "Cd3g")
df <- data.frame()
# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_4_singleton_all_ranked.csv"))
# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[["T Cell(Lung)"]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[["T Cell(Lung)"]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[["T Cell(Lung)"]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[["T Cell(Lung)"]]))),
                   # Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.t)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df.t <- as.data.frame(t(df))
df.order <- data.frame()
for (gene in colnames(df.t)) {
  df.s <- order(df.t[,gene])
  # colnames(df.s) <- colnames(df.t)
  df.order <- rbind(df.order, df.s)
}
colnames(df.order) <- colnames(df)
rownames(df.order) <- rownames(df)
df.order <- as.data.frame(t(df.order))
df.m <- melt(t(df.order))
df.order <- rbind(df.order)

ggplot(df.m) +
  geom_line(aes(Var1, value, group=Var2, color=Var2)) + scale_y_reverse() +
  ylab("Ranking") + xlab("Markers")
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,100), fmt.key="%.0f",)
# plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=range(t(df)))

```

```{r}
t.cells.genes <- c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22")

# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[["B Cell(Lung)"]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[["B Cell(Lung)"]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[["B Cell(Lung)"]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[["B Cell(Lung)"]]))),
                   # Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.b)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

########################################################################################################################################
t.cells.genes <- c("Klrb1c", "Klrb1a", "Ncr1")
id <- "NK Cell(Lung)"
# df <- data.frame()
# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[[id]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[[id]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[[id]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[[id]]))),
                   # Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.nk)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

t.cells.genes <- c("Cd3d", "Cd3e", "Cd3g")
# df <- data.frame()
# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_4_singleton_all_ranked.csv"))
# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[["T Cell(Lung)"]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[["T Cell(Lung)"]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[["T Cell(Lung)"]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[["T Cell(Lung)"]]))),
                   # Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.t)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,60), fmt.key="%.0f", na.print='Missing', main = "Cell markers")

pdf("plots/Lung.markers.plotmatrix.pdf", height = 7, width = 10)
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,60), fmt.key="%.0f", na.print='Missing', main = "Cell markers")
dev.off()

annotation_col = data.frame(
  GeneClass = factor(rep(c("B cells", "NK cells", "T cells"), c(5, 3, 3)))
                )
rownames(annotation_col) = rownames(df)

paletteLength <- 6
myColor <- colorRampPalette(c("red", "white"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c( 
              seq(70/paletteLength, 70, length.out=floor(paletteLength)))

pheatmap(t(df), color=myColor, breaks=myBreaks, cluster_row = FALSE, cluster_col = FALSE, annotation_col = annotation_col,  na_col = "#000000", angle_col = "45")

pdf("plots/Lung.markers.pheatmap.pdf", height = 7, width = 10)
pheatmap(t(df), color=myColor, breaks=myBreaks, cluster_row = FALSE, cluster_col = FALSE, annotation_col = annotation_col,  na_col = "#000000", angle_col = "45")
dev.off()
```




```{r}
# NK cells in Lung 

t.cells.genes <- c("Klrb1c", "Klrb1a", "Ncr1")
id <- "NK Cell(Lung)"

# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[[id]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[[id]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[[id]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[[id]]))),
                   # Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.nk)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "SD"))
# df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))

plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in NK cell (Lung Tissue)"))
  plots[[gene]] <- p
  print(p)
}

plots <-Filter(Negate(is.null), plots)
pdf("plots/NK_markers_ranking_Lung.pdf")
plot_grid(plotlist=plots, ncol=2)
dev.off()
```

```{r}
# De cells in Lung 

# id <- "Dendritic cell_Naaa high(Lung)"
# 
# # De.lung.t <-FindMarkers(mca.spleen, ident.1 = "Marginal zone B cell(Spleen)", test.use = "t")
# De.lung.d <- lung.markers.t[[id]]
# De.lung.d <- subset(De.lung.d, p_val < 0.05)
# 
# lung.d <- data.frame()
# for (gene in rownames(De.lung.d)) {
#   df.s <- get_split_pos.2(mca.lung, gene, id, step = 0.1)
#   lung.d <- rbind(lung.d, df.s)
# }
# # df.b <- df.b[df.b$x.val != 0, ]
# # df.b$x.margin.adj.a <- df.b$x.margin.adj/df.b$x.val
# lung.d <- lung.d[order(lung.d$x.margin.adj, decreasing = T), ]
# lung.d

t.cells.genes <- c("Cd74", "Itgax")

# genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(lung.markers.t[[id]]))),
                   wilcox.test <- c(match(gene, rownames(lung.markers.wilcox[[id]]))),
                   mast <- c(match(gene, rownames(lung.markers.MAST[[id]]))),
                   LR <- c(match(gene, rownames(lung.markers.LR[[id]]))),
                   # Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(lung.d)))
                   )
  # colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "SD"))
# df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))

for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in Dendritic cell (Lung Tissue)"))
  print(p)
}
```



# Spleen

```{r}
De.spleen <-FindMarkers(mca.spleen, ident.1 = "Marginal zone B cell(Spleen)", test.use = "t")

De.spleen <- subset(De.spleen, p_val < 0.05)

df.b <- data.frame()
for (gene in rownames(De.spleen)) {
  df.s <- get_split_pos.2(mca.spleen, gene, "Marginal zone B cell(Spleen)", step = 0.01)
  df.b <- rbind(df.b, df.s)
}
df.b <- df.b[order(df.b$x.margin.adj, decreasing = T), ]
df.b


De.Macrophage <-FindMarkers(mca.spleen, ident.1 = "Macrophage(Spleen)", test.use = "t")
De.Macrophage <- subset(De.Macrophage, p_val < 0.05)
df.m <- data.frame()
for (gene in rownames(De.Macrophage)) {
  df.s <- get_split_pos.2(mca.spleen, gene, "Macrophage(Spleen)", step = 0.01)
  df.m <- rbind(df.m, df.s)
}
df.m <- df.m[order(df.m$x.margin.adj, decreasing = T), ]
df.m


De.tcell <-FindMarkers(mca.spleen, ident.1 = "T cell(Spleen)", test.use = "t")
De.tcell <- subset(De.tcell, p_val < 0.05)
df.t <- data.frame()
for (gene in rownames(De.tcell)) {
  df.s <- get_split_pos.2(mca.spleen, gene, "T cell(Spleen)", step = 0.01)
  df.t <- rbind(df.t, df.s)
}
df.t <- df.t[df.t$x.val != 0, ]
df.t <- df.t[order(df.t$x.margin.adj, decreasing = T), ]
df.t

Idents(mca.spleen) <- "anno"
pc1 <- FetchData(object = mca.spleen, vars = c('Ms4a1', "Cd14", 'ident'))
colnames(pc1) <- c("gene1", "gene2", "id")
pc1$gene1 <- normalize(pc1$gene1)

clusters <- c("T cell(Spleen)", "Macrophage(Spleen)", "Marginal zone B cell(Spleen)", "NK cell(Spleen)", "Dendritic cell_S100a4 high(Spleen)", "Dendritic cell_Siglech high(Spleen)")
Idents(mca.spleen) <- "anno"

markers.wilcox <- list()
markers.t <- list()
markers.MAST <- list()
markers.LR <- list()
for (x.cluster in clusters) {
  markers <- FindMarkers(mca.spleen, ident.1 = x.cluster, test.use = "t")
  markers.t[[x.cluster]] <- markers
  
  markers <- FindMarkers(mca.spleen, ident.1 = x.cluster, test.use = "wilcox")
  markers.wilcox[[x.cluster]] <- markers
  
  markers <- FindMarkers(mca.spleen, ident.1 = x.cluster, test.use = "MAST")
  markers.MAST[[x.cluster]] <- markers
  
  markers <- FindMarkers(mca.spleen, ident.1 = x.cluster, test.use = "LR")
  markers.LR[[x.cluster]] <- markers
}

# T cells in spleen 

t.cells.genes <- c("Cd3d", "Cd3e", "Cd3g")

genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_4_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["T cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["T cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["T cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["T cell(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.t)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))


plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in T cell (Spleen Tissue)"))
  plots[[gene]] <- p
  print(p)
}


# plots <-Filter(Negate(is.null), plots)
# 
# pdf("plots/T_markers_ranking_spleen.pdf")
# plot_grid(plotlist=plots, ncol=2)
# dev.off()
```

```{r}
t.cells.genes <- c("Cd3d", "Cd3e", "Cd3g")

genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_4_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["T cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["T cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["T cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["T cell(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.t)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))


plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in T cell (Spleen Tissue)"))
  plots[[gene]] <- p
  print(p)
}

df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["T cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["T cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["T cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["T cell(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.t)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(df), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,30), fmt.key="%.0f",)
```



```{r}
# B cells in spleen 

t.cells.genes <- c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22")

genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["Marginal zone B cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["Marginal zone B cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["Marginal zone B cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["Marginal zone B cell(Spleen)"]]))),
                   Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.b)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))


plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in T cell (Spleen Tissue)"))
  plots[[gene]] <- p
  print(p)
}


# plots <-Filter(Negate(is.null), plots)
# 
# pdf("plots/B_markers_ranking_spleen.pdf")
# plot_grid(plotlist=plots, ncol=2)
# dev.off()

t.cells.genes <- c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22")

genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["Marginal zone B cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["Marginal zone B cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["Marginal zone B cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["Marginal zone B cell(Spleen)"]]))),
                   Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.b)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
# df.t <- as.data.frame(t(df))
# df.order <- data.frame()
# for (gene in colnames(df.t)) {
#   df.s <- order(df.t[,gene])
#   # colnames(df.s) <- colnames(df.t)
#   df.order <- rbind(df.order, df.s)
# }
# colnames(df.order) <- colnames(df)
# rownames(df.order) <- rownames(df)
# df.order <- as.data.frame(t(df.order))
# df.m <- melt(t(df.order))
# df.order <- rbind(df.order)

# ggplot(df.m) +
#   geom_line(aes(Var1, value, group=Var2, color=Var2)) + scale_y_reverse() +
#   ylab("Ranking") + xlab("Markers")
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(df), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,50), fmt.key="%.0f",)
```

```{r}
# Macrophage cells in spleen 

t.cells.genes <- c("Cd14", "Adgre1")

genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_8_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["Macrophage(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["Macrophage(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["Macrophage(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["Macrophage(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.m)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))

# library(ggplot2)

plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in Macrophage(Spleen Tissue)"))
  plots[[gene]] <- p
  print(p)
}


plots <-Filter(Negate(is.null), plots)

# pdf("plots/Macrophage_markers_ranking_spleen.pdf")
# plot_grid(plotlist=plots, ncol=2)
# dev.off()
```

```{r}
spleen.nk <-FindMarkers(mca.spleen, ident.1 = "NK cell(Spleen)", test.use = "t")
spleen.nk <- subset(spleen.nk, p_val < 0.05)
df.nk <- data.frame()
for (gene in rownames(spleen.nk)) {
  df.s <- get_split_pos.2(mca.spleen, gene, "NK cell(Spleen)", step = 0.01)
  df.nk <- rbind(df.nk, df.s)
}
df.nk <- df.nk[order(df.nk$x.margin.adj, decreasing = T), ]
df.nk


t.cells.genes <- c("Klrb1c", "Klrb1a", "Ncr1")
 
genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_11_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["NK cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["NK cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["NK cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["NK cell(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.nk)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
df <- as.data.frame(t(df))
df$test.use <- rownames(df)
df$test.use  <- factor(df$test.use, levels = c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD"))

# library(ggplot2)

plots <- list()
for (gene in t.cells.genes) {
  p <- ggplot(df, aes_string(x="test.use", y=paste(gene))) + 
    geom_bar(stat = "identity") +
  ggtitle(paste(gene, " in Macrophage(Spleen Tissue)"))
  plots[[gene]] <- p
  print(p)
}


plots <-Filter(Negate(is.null), plots)

# pdf("plots/NK_markers_ranking_spleen.pdf")
# plot_grid(plotlist=plots, ncol=2)
# dev.off()

t.cells.genes <- c("Klrb1c", "Klrb1a", "Ncr1")
 
genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_11_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["NK cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["NK cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["NK cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["NK cell(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.nk)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,40), fmt.key="%.0f", na.print='Missing', main = "NK cell markers")

```

```{r fig.height=6, fig.width=10}
t.cells.genes <- c("Klrb1c", "Klrb1a", "Ncr1")
 
genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_11_singleton_all_ranked.csv"))
df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["NK cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["NK cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["NK cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["NK cell(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.nk)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

t.cells.genes <- c("Cd14", "Adgre1")

genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_8_singleton_all_ranked.csv"))
# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["Macrophage(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["Macrophage(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["Macrophage(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["Macrophage(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.m)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

t.cells.genes <- c("Ly6d", "Cd19", "Cd79b", "Ms4a1", "Cd22")

genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_5_singleton_all_ranked.csv"))
# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["Marginal zone B cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["Marginal zone B cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["Marginal zone B cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["Marginal zone B cell(Spleen)"]]))),
                   Comet <- c(grep(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.b)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

t.cells.genes <- c("Cd3d", "Cd3e", "Cd3g")
genes <- read.csv(paste("/home/ronghui/project/scMarkerDetect/output/data/cluster_4_singleton_all_ranked.csv"))
# df <- data.frame()
for (gene in t.cells.genes) {
  df.s <- data.frame(t.test <- c(match(gene, rownames(markers.t[["T cell(Spleen)"]]))),
                   wilcox.test <- c(match(gene, rownames(markers.wilcox[["T cell(Spleen)"]]))),
                   mast <- c(match(gene, rownames(markers.MAST[["T cell(Spleen)"]]))),
                   LR <- c(match(gene, rownames(markers.LR[["T cell(Spleen)"]]))),
                   Comet <- c(match(toupper(gene), genes$gene_1)),
                   SD <- c(match(gene, rownames(df.t)))
                   )
  colnames(df.s) <- c("T-test", "Wilcox", "MAST", "LR", "Comet", "SD")
  rownames(df.s) <- paste(gene)
  df <- rbind(df, df.s)
}

pdf("plots/Spleen.markers.plotmatrix.pdf", height = 7, width = 10)
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(as.matrix(t(df)), axis.col=list(side=1, las=2), axis.row = list(side=2, las=1), xlab="", ylab="", breaks=c(1,60), fmt.key="%.0f", na.print='Missing', main = "Cell markers")
dev.off()

annotation_col = data.frame(
  GeneClass = factor(rep(c("NK cells", "Macrophages", "B cells", "T cells"), c(3, 2, 5, 3)))
                )
rownames(annotation_col) = rownames(df)

paletteLength <- 6
myColor <- colorRampPalette(c("red", "white"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c( 
              seq(70/paletteLength, 70, length.out=floor(paletteLength)))

pdf("plots/Spleen.markers.pheatmap.pdf", height = 7, width = 10)
pheatmap(t(df), color=myColor, breaks=myBreaks, cluster_row = FALSE, cluster_col = FALSE, annotation_col = annotation_col,  na_col = "#000000", angle_col = "45")
dev.off()

pheatmap(t(df), color=myColor, breaks=myBreaks, cluster_row = FALSE, cluster_col = FALSE, annotation_col = annotation_col,  na_col = "#000000", angle_col = "45")
# pheatmap(t(df), cluster_row = FALSE, cluster_col = FALSE, breaks = c(0,5,15,20,25,30,35,40,45,50,55,60))#, annotation_col = annotation_col)#,41,46,51,56,61))#, 

# pdf("mca.spleen.boxplot.pdf")
# boxplot(df)
# boxplot(df, ylim = c(0,100))
# ylim
# dev.off()

library(ggplot2)

library(scales)

squash_axis <- function(from, to, factor) { 
    # Args:
    #   from: left end of the axis
    #   to: right end of the axis
    #   factor: the compression factor of the range [from, to]

  trans <- function(x) {    
      # get indices for the relevant regions
      isq <- x > from & x < to
      ito <- x >= to

      # apply transformation
      x[isq] <- from + (x[isq] - from)/factor
      x[ito] <- from + (to - from)/factor + (x[ito] - to)

      return(x)
  }

  inv <- function(x) {
      # get indices for the relevant regions
      isq <- x > from & x < from + (to - from)/factor
      ito <- x >= from + (to - from)/factor

      # apply transformation
      x[isq] <- from + (x[isq] - from) * factor
      x[ito] <- to + (x[ito] - (from + (to - from)/factor))

      return(x)
  }

# return the transformation
  return(trans_new("squash_axis", trans, inv))
}

df

df.melt <- melt(df)

df.melt[is.na(df.melt)] <- 198


pdf("mca.spleen.boxplot.pdf", width = 14, height = 10)
ggplot(df.melt, aes(x=variable, y = value, fill = variable))+
  geom_boxplot()+
  coord_trans(y = squash_axis(100, 300, 30)) + xlab("Test") + ylab("Marker ranking") + ggtitle("MCA Spleen tissue")
dev.off()

ggplot(df.melt, aes(x=variable, y = value, fill = variable))+
  geom_boxplot()+
  xlab("Test") + ylab("Marker ranking") + ggtitle("MCA Spleen tissue")
  

```



```{r}
# CD74	IGKC
# TRAC	IGKC_negation


df <- data.frame(exp1 = mca.spleen@assays$RNA@data["Cd74",],
                 exp2 = mca.spleen@assays$RNA@data["Igkc",],
                 id = as.character(mca.spleen@active.ident))
df$id <- ifelse(df$id == "Marginal zone B cell(Spleen)", "Marginal zone B cell(Spleen)", "Other")

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = mca.spleen@assays$RNA@data["Tmsb4x",],
                 exp2 = mca.spleen@assays$RNA@data["Cd79a",],
                 id = as.character(mca.spleen@active.ident))

df$id <- ifelse(df$id == "Marginal zone B cell(Spleen)", "Marginal zone B cell(Spleen)", "Other")

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))


dist(t(df.id[1:15, 1:15]))
dist.id <- melt(as.matrix(dist(t(df.id))))
dist.id <- dist.id[dist.id$value != 0, ]
dist.id[order(dist.id$value, decreasing = F),]

as.matrix(as.matrix(dist(t(df.id[1:50, 1:50]))))["Ighm", "Igkc"]
as.matrix(as.matrix(dist(t(df.other[1:50, 1:50]))))["Ighm", "Igkc"]

dist(t(df.id[1:15, 1:15]))
dist(t(df.other[1:15, 1:15]))
dist.c <- melt(as.matrix(((dist(t(df.other)) + 1) / (dist(t(df.id)) + 1))))
dist.c <- dist.c[dist.c$value != 0, ]
dist.c[order(dist.c$value, decreasing = T), ]

dist.o <- melt(as.matrix(dist(t(df.other))))
dist.o <- dist.id[dist.o$value != 0, ]
dist.o[order(dist.o$value, decreasing = T),]
dist.o[order(dist.o$Var1, dist.o$Var2),]
dist.id[order(dist.id$Var1, dist.id$Var2),]


max(expr.matrix.1[19,], na.rm=TRUE)
apply(expr.matrix.1, 2, max)
mca.spleen <- FindVariableFeatures(mca.spleen)
mca.spleen@assays$RNA@var.features

marker_stepbystep(mca.spleen, cellgroup = "Marginal zone B cell(Spleen)", step = 0.1)

as.matrix(dist(t(df.id[1:15, 1:15])))
```

```{r}
# dist(as.matrix(t(df.a)))


get_split_pos_pos(mca.spleen, "Cd74",	"Igkc", "Marginal zone B cell(Spleen)", step = 0.1)
get_split_pos.2(mca.spleen, "Cd74", "Marginal zone B cell(Spleen)", step = 0.1)
get_split_pos.2(mca.spleen, "Cd22", "Marginal zone B cell(Spleen)", step = 0.1)
get_split_pos_pos(mca.spleen, "Tmsb4x",	"Cd79a", "Marginal zone B cell(Spleen)", step = 0.1)


get_split_pos_pos(mca.spleen, "Cd74",	"Igkc", "Marginal zone B cell(Spleen)", step = 0.1)
get_split_pos_neg(mca.spleen, "Cd74",	"S100a4", "Marginal zone B cell(Spleen)", step = 0.1)
get_split_pos_neg(mca.spleen, "Cd74",	"Cd7", "Marginal zone B cell(Spleen)", step = 0.1)
get_split_neg_neg(mca.spleen, "S100a4",	"Cd7", "Marginal zone B cell(Spleen)", step = 0.1)
get_split_neg_neg(mca.spleen, "S100a4",	"Plbd1", "Marginal zone B cell(Spleen)", step = 0.1)
re1
```

```{r}
Detect_combine_markers.c <- function(scrna, id, geneset = NULL, step = 0.1, max.gene = NULL){
  if (is.null(geneset)) {
    de.genes <- FindMarkers(scrna, ident.1 = id, test.use = "t")
  }else{
    de.genes <- FindMarkers(scrna, ident.1 = id, test.use = "t", features = geneset)
  }
  de.genes$gene <- rownames(de.genes)
  de.genes <- subset(de.genes, p_val < 0.05)
  # if (max.gene & length(x.split$gene) > max.gene) {
  #   x.split <- x.split[1:max.gene, ]
  # }
  
  de.genes.p <- subset(de.genes, avg_log2FC > 0)
  de.genes.n <- subset(de.genes, avg_log2FC < 0)
  print("Predicting positive markers")
  gene.combn <- t(combn(de.genes.p$gene, 2))
  gene.combn.prauc <- data.frame()
  
  pb <- txtProgressBar(style=3)
  star_time <- Sys.time()

  for (gene.iter in 1:nrow(gene.combn)) {
    genes <- gene.combn[gene.iter,]
    gene1 <- genes[1]
    gene2 <- genes[2]
    de <- get_split_pos_pos(scrna, gene1,	gene2, id, step = 0.1)
    
    # colnames(de) <- c("Gene1", "Gene2", "Gene1.split", "Gene2.split", "x.margin", "x.margin.adj", "TP", "FP", "Direction1", "Direction2")
    gene.combn.prauc <- rbind(gene.combn.prauc, de)
    setTxtProgressBar(pb, gene.iter/nrow(gene.combn))
  }
  end_time <- Sys.time()
  close(pb)
  run_time <- end_time - star_time
  print(run_time)
  gene.combn.prauc <- gene.combn.prauc[order(gene.combn.prauc$x.margin.adj, decreasing = T),]
  return(gene.combn.prauc)
}

id <- "Marginal zone B cell(Spleen)"
de.c <- Detect_combine_markers.c(mca.spleen, "Marginal zone B cell(Spleen)")

de.genes <- FindMarkers(mca.spleen, ident.1 = id, test.use = "t")
de.genes <- subset(de.genes, p_val_adj < 0.05)
de.genes$gene <- rownames(de.genes)
de.genes.p <- subset(de.genes, avg_log2FC > 0)
gene.combn <- t(combn(de.genes.p$gene, 2))
nrow(gene.combn)
gene.combn.prauc[order(gene.combn.prauc$x.margin, decreasing = T),]
```

```{r}
get_split_pos_neg(mca.spleen, "Cd74",	"Plbd1", "Marginal zone B cell(Spleen)", step = 0.01)
```


```{r}

```




```{r}
star_time <- Sys.time()
get_split_pos_neg(mca.spleen, "Cd74",	"Plbd1", "Marginal zone B cell(Spleen)", step = 0.1)
end_time <- Sys.time()
end_time - star_time
0.1480815*5050/60
```



```{r}
df <- data.frame(exp1 = mca.spleen@assays$RNA@data["Cd74",],
                 exp2 = mca.spleen@assays$RNA@data["Plbd1",],
                 id = as.character(mca.spleen@active.ident))

df$id <- ifelse(df$id == "Marginal zone B cell(Spleen)", "Marginal zone B cell(Spleen)", "Other")

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))
```




```{r}
get_split_pos_neg <- function(scrna, gene1, gene2, id, step = 0.01) {
  data.mat.surf <- data.frame(exp1 = round(normalize(scrna@assays$RNA@data[gene1,]), 2),
                              exp2 = round(normalize(scrna@assays$RNA@data[gene2,]), 2),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.size.factor <- 10*(length(data.id$exp1)/length(data.other$exp1))

  for (x.val in seq(0.5, 1, step)) {
    for (y.val in seq(0, 0.5, step)) {
      data.i.a <- data.id[data.id$exp1 > x.val & data.id$exp2 < y.val, ]
      tp <- nrow(data.i.a)
      data.o.a <- data.other[data.other$exp1 > x.val & data.other$exp2 < y.val, ]
      fp <- nrow(data.o.a)
      data.i.b <- data.id[data.id$exp1 <= x.val | data.id$exp2 >= y.val, ]
      fn <- nrow(data.i.b)
      data.o.b <- data.other[data.other$exp1 <= x.val | data.other$exp2 >= y.val, ]
      tn <- nrow(data.o.b)
  
      # x.margin.a <- sum((data.i.a$exp1 - x.val))*nrow(data.o.b) + sum((y.val - data.i.a$exp2))*nrow(data.o.b) +
      #   sum((x.val -data.o.b$exp1))*nrow(data.i.a) + sum((data.o.b$exp2 - y.val))*nrow(data.i.a) -
      #   sum((data.o.a$exp1 - x.val))*nrow(data.o.b) - sum((y.val - data.o.a$exp2))*nrow(data.o.b)
      x.margin <- tp - fp
      x.margin <- x.margin/data.all.l
      # x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*x.margin.a
      de <- data.frame(gene1, gene2, x.val, y.val, x.margin)
      gene.prauc <- rbind(gene.prauc, de)
    }
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  x.val <- x.split[,3]
  y.val <- x.split[,4]
  x.margin <- x.split[,5]
  data.i.a <- data.id[data.id$exp1 > x.val & data.id$exp2 < y.val, ]
  tp <- nrow(data.i.a)
  data.o.a <- data.other[data.other$exp1 > x.val & data.other$exp2 < y.val, ]
  fp <- nrow(data.o.a)
  data.i.b <- data.id[data.id$exp1 <= x.val | data.id$exp2 >= y.val, ]
  fn <- nrow(data.i.b)
  data.o.b <- data.other[data.other$exp1 <= x.val | data.other$exp2 >= y.val, ]
  tn <- nrow(data.o.b)
  
  x.margin.a <- sum((data.i.a$exp1 - x.val))*nrow(data.o.b) + sum((y.val - data.i.a$exp2))*nrow(data.o.b) +
        sum((x.val -data.o.b$exp1))*nrow(data.i.a) + sum((data.o.b$exp2 - y.val))*nrow(data.i.a) -
        sum((data.o.a$exp1 - x.val))*nrow(data.o.b) - sum((y.val - data.o.a$exp2))*nrow(data.o.b)

  x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*x.margin.a
  
  x.split <- data.frame(gene1, gene2, x.val, y.val, x.margin, x.margin.adj, tp, fp, "+", "-")
  return(x.split)
}


get_split_neg_neg <- function(scrna, gene1, gene2, id, step = 0.01) {
  data.mat.surf <- data.frame(exp1 = normalize(scrna@assays$RNA@data[gene1,]),
                              exp2 = normalize(scrna@assays$RNA@data[gene2,]),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step
  # x.size.factor <- 10*(length(data.id$exp1)/length(data.other$exp1))

  for (x.val in seq(0, 1, step)) {
    for (y.val in seq(0, 1, step)) {
      data.i.a <- data.id[data.id$exp1 < x.val & data.id$exp2 < y.val, ]
      tp <- nrow(data.i.a)
      data.o.a <- data.other[data.other$exp1 < x.val & data.other$exp2 < y.val, ]
      fp <- nrow(data.o.a)
      data.i.b <- data.id[data.id$exp1 >= x.val | data.id$exp2 >= y.val, ]
      fn <- nrow(data.i.b)
      data.o.b <- data.other[data.other$exp1 >= x.val | data.other$exp2 >= y.val, ]
      tn <- nrow(data.o.b)
      
      x.margin <- tp - fp
      x.margin <- x.margin/data.all.l
  
      de <- data.frame(gene1, gene2, x.val, y.val, x.margin)
      gene.prauc <- rbind(gene.prauc, de)
    }
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  x.val <- x.split[,3]
  y.val <- x.split[,4]
  x.margin <- x.split[,5]
  data.i.a <- data.id[data.id$exp1 < x.val & data.id$exp2 < y.val, ]
  tp <- nrow(data.i.a)
  data.o.a <- data.other[data.other$exp1 < x.val & data.other$exp2 < y.val, ]
  fp <- nrow(data.o.a)
  data.i.b <- data.id[data.id$exp1 >= x.val | data.id$exp2 >= y.val, ]
  fn <- nrow(data.i.b)
  data.o.b <- data.other[data.other$exp1 >= x.val | data.other$exp2 >= y.val, ]
  tn <- nrow(data.o.b)
  
  x.margin.a <- sum((data.i.a$exp1 - x.val))*nrow(data.o.b) + sum((data.i.a$exp2 - y.val))*nrow(data.o.b) +
    sum((x.val -data.o.b$exp1))*nrow(data.i.a) + sum((y.val -data.o.b$exp2))*nrow(data.i.a) -
    sum((data.o.a$exp1 - x.val))*nrow(data.o.b) - sum((data.o.a$exp2 - y.val))*nrow(data.o.b)
      
  x.margin.a <- -x.margin.a
  x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*x.margin.a
  
  x.split <- data.frame(gene1, gene2, x.val, y.val, x.margin, x.margin.adj, tp, fp, "-", "-")
  return(x.split)
}

get_split_pos_pos <- function(scrna, gene1, gene2, id, step = 0.01) {
  data.mat.surf <- data.frame(exp1 = normalize(scrna@assays$RNA@data[gene1,]),
                              exp2 = normalize(scrna@assays$RNA@data[gene2,]),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.size.factor <- 10*(length(data.id$exp1)/length(data.other$exp1))

  for (x.val in seq(0, 1, step)) {
    for (y.val in seq(0, 1, step)) {
      data.i.a <- data.id[data.id$exp1 > x.val & data.id$exp2 > y.val, ]
      tp <- nrow(data.i.a)
      data.o.a <- data.other[data.other$exp1 > x.val & data.other$exp2 > y.val, ]
      fp <- nrow(data.o.a)
      data.i.b <- data.id[data.id$exp1 <= x.val | data.id$exp2 <= y.val, ]
      fn <- nrow(data.i.b)
      data.o.b <- data.other[data.other$exp1 <= x.val | data.other$exp2 <= y.val, ]
      tn <- nrow(data.o.b)
  
      # x.margin.a <- sum((data.i.a$exp1 - x.val))*nrow(data.o.b) + sum((data.i.a$exp2 - y.val))*nrow(data.o.b) +
      #   sum((x.val -data.o.b$exp1))*nrow(data.i.a) + sum((y.val -data.o.b$exp2))*nrow(data.i.a) -
      #   sum((data.o.a$exp1 - x.val))*nrow(data.o.b) - sum((data.o.a$exp2 - y.val))*nrow(data.o.b)
      x.margin <- tp - fp
      x.margin <- x.margin/data.all.l
  
      # x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*x.margin.a#*((x1.factor*x2.factor)**2)
  
      # de <- data.frame(gene1, gene2, x.val, y.val, x.margin, x.margin.adj, tp, fp, "+", "+")
      de <- data.frame(gene1, gene2, x.val, y.val, x.margin)
      gene.prauc <- rbind(gene.prauc, de)
    }
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  x.val <- x.split[,3]
  y.val <- x.split[,4]
  x.margin <- x.split[,5]
  data.i.a <- data.id[data.id$exp1 > x.val & data.id$exp2 > y.val, ]
  tp <- nrow(data.i.a)
  data.o.a <- data.other[data.other$exp1 > x.val & data.other$exp2 > y.val, ]
  fp <- nrow(data.o.a)
  data.i.b <- data.id[data.id$exp1 <= x.val | data.id$exp2 <= y.val, ]
  fn <- nrow(data.i.b)
  data.o.b <- data.other[data.other$exp1 <= x.val | data.other$exp2 <= y.val, ]
  tn <- nrow(data.o.b)
  
  x.margin.a <- sum((data.i.a$exp1 - x.val))*nrow(data.o.b) + sum((data.i.a$exp2 - y.val))*nrow(data.o.b) +
    sum((x.val -data.o.b$exp1))*nrow(data.i.a) + sum((y.val -data.o.b$exp2))*nrow(data.i.a) -
    sum((data.o.a$exp1 - x.val))*nrow(data.o.b) - sum((data.o.a$exp2 - y.val))*nrow(data.o.b)
  x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*x.margin.a#*((x1.factor*x2.factor)**2)
  x.split <- data.frame(gene1, gene2, x.val, y.val, x.margin, x.margin.adj, tp, fp, "+", "+")
  return(x.split)
}
```




```{r}
get_split_pos.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step

  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)

  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)

    x.margin <- tp - fp#*x.size.factor
    # x.margin <- tp - fp*x.size.factor
    # x.margin <- (x.factor**2)*x.margin

    # x.margin.adj <- x.margin*x.factor
    x.margin.adj <- x.margin*(tp/length(data.id$exp))*(tn/length(data.other$exp))*(x.factor**2)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

get_split_pos_pos <- function(scrna, gene1, gene2, id, step = 0.01) {
  data.mat.surf <- data.frame(exp1 = normalize(scrna@assays$RNA@data[gene1,]),
                              exp2 = normalize(scrna@assays$RNA@data[gene2,]),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.size.factor <- 10*(length(data.id$exp1)/length(data.other$exp1))

  for (x.val in seq(0, 1, step)) {
    for (y.val in seq(0, 1, step)) {
      data.i.a <- data.id[data.id$exp1 > x.val & data.id$exp2 > y.val, ]
      tp <- nrow(data.i.a)
      data.o.a <- data.other[data.other$exp1 > x.val & data.other$exp2 > y.val, ]
      fp <- nrow(data.o.a)
      data.i.b <- data.id[data.id$exp1 <= x.val | data.id$exp2 <= y.val, ]
      fn <- nrow(data.i.b)
      data.o.b <- data.other[data.other$exp1 <= x.val | data.other$exp2 <= y.val, ]
      tn <- nrow(data.o.b)
  
      # x.margin.a <- sum((data.i.a$exp1 - x.val))*nrow(data.o.b) + sum((data.i.a$exp2 - y.val))*nrow(data.o.b) +
      #   sum((x.val -data.o.b$exp1))*nrow(data.i.a) + sum((y.val -data.o.b$exp2))*nrow(data.i.a) -
      #   sum((data.o.a$exp1 - x.val))*nrow(data.o.b) - sum((data.o.a$exp2 - y.val))*nrow(data.o.b)
      x.margin <- tp - fp
      x.margin <- x.margin/data.all.l
  
      # x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*x.margin.a#*((x1.factor*x2.factor)**2)
  
      # de <- data.frame(gene1, gene2, x.val, y.val, x.margin, x.margin.adj, tp, fp, "+", "+")
      de <- data.frame(gene1, gene2, x.val, y.val, x.margin)
      gene.prauc <- rbind(gene.prauc, de)
    }
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  x.val <- x.split[,3]
  y.val <- x.split[,4]
  x.margin <- x.split[,5]
  data.i.a <- data.id[data.id$exp1 > x.val & data.id$exp2 > y.val, ]
  tp <- nrow(data.i.a)
  data.o.a <- data.other[data.other$exp1 > x.val & data.other$exp2 > y.val, ]
  fp <- nrow(data.o.a)
  data.i.b <- data.id[data.id$exp1 <= x.val | data.id$exp2 <= y.val, ]
  fn <- nrow(data.i.b)
  data.o.b <- data.other[data.other$exp1 <= x.val | data.other$exp2 <= y.val, ]
  tn <- nrow(data.o.b)
  x.margin.a <- sum((data.i.a$exp1 - x.val))*nrow(data.o.b) + sum((data.i.a$exp2 - y.val))*nrow(data.o.b) +
    sum((x.val -data.o.b$exp1))*nrow(data.i.a) + sum((y.val -data.o.b$exp2))*nrow(data.i.a) -
    sum((data.o.a$exp1 - x.val))*nrow(data.o.b) - sum((data.o.a$exp2 - y.val))*nrow(data.o.b)
  x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*x.margin.a#*((x1.factor*x2.factor)**2)
  x.split <- data.frame(gene1, gene2, x.val, y.val, x.margin, x.margin.adj, tp, fp, "+", "+")
  return(x.split)
}

get_split_pos_c.3 <- function(scrna, gene1, gene2, id, step = 0.01) {
  data.mat.surf <- data.frame(exp1 = normalize(scrna@assays$RNA@data[gene1,]),
                              exp2 = normalize(scrna@assays$RNA@data[gene2,]),
                              id = as.character(scrna@active.ident))
  data.mat.surf$exp <- (data.mat.surf$exp1 + 0.01)*(data.mat.surf$exp2 + 0.01)
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)

  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(0, 1, step)) {
    # tp <- sum(data.id$exp > x.val)
    # fp <- sum(data.other$exp > x.val)
    # tn <- sum(data.other$exp <= x.val)
    # fn <- sum(data.id$exp <= x.val)
    data.i.a <- data.id[data.id$exp > x.val, ]
    tp <- nrow(data.i.a)
    data.o.a <- data.other[data.other$exp > x.val, ]
    fp <- nrow(data.o.a)
    data.i.b <- data.id[data.id$exp <= x.val, ]
    fn <- nrow(data.i.b)
    data.o.b <- data.other[data.other$exp <= x.val, ]
    tn <- nrow(data.o.b)

    # x.margin <- sum((data.i.a$exp - x.val))*nrow(data.o.b) +
    #   sum((x.val -data.o.b$exp))*nrow(data.i.a) -
    #   sum((data.o.a$exp - x.val))*nrow(data.o.b)
    x.margin <- tp - fp
    x.margin <- x.margin/data.all.l

    x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene1, gene2)
  return(x.split)
}



get_split_pos.2 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = normalize(scrna@assays$RNA@data[gene,]),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)

  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(0, 1, step)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)
    data.i.a <- data.id[data.id$exp > x.val, ]
    data.o.a <- data.other[data.other$exp > x.val, ]
    data.i.b <- data.id[data.id$exp <= x.val, ]
    data.o.b <- data.other[data.other$exp <= x.val, ]

    x.margin <- sum((data.i.a$exp - x.val))*nrow(data.o.b) +
      sum((x.val -data.o.b$exp))*nrow(data.i.a) -
      sum((data.o.a$exp - x.val))*nrow(data.o.b)
    x.margin <- x.margin/data.all.l

    # x.margin <- sum((data.id[data.id$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id) +
    #   sum((x.val - data.other[data.other$exp <x.val, ]$exp))*length(data.id[data.id$exp > x.val, ]$id) -
    #   sum((data.other[data.other$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id)

    # x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)
    x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

get_split_pos.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step

  # x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)

  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)

    x.margin <- tp - fp#*x.size.factor
    # x.margin <- tp - fp*x.size.factor
    # x.margin <- (x.factor**2)*x.margin

    # x.margin.adj <- x.margin*x.factor
    x.margin.adj <- x.margin*(tp/length(data.id$exp))*(tn/length(data.other$exp))*(x.factor**2)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}
```


```{r}
scrna <- mca.spleen
gene <- "Cd19"
id <- "Marginal zone B cell(Spleen)"
step <- 0.1
x.val <- 1.213446

get_split_pos.3 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step

  # x.factor <- (mean(data.id$exp) + 0.0001)/(mean(data.other$exp) + 0.0001)

  # x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)

    x.margin <- tp - fp#*x.size.factor
    # x.margin <- tp - fp*x.size.factor
    # x.margin <- (x.factor**2)*x.margin
    x.factor <- (tp/nrow(data.id) + 0.0001)/(fp/nrow(data.other) + 0.0001)
    # data.mat.surf[data.mat.surf$exp <= x.val, ]$exp <- 0
    # data.mat.surf[data.mat.surf$exp > x.val, ]$exp <- 1
    # 
    # data.id <- data.mat.surf[data.mat.surf$id == id,]
    # data.other <- data.mat.surf[data.mat.surf$id != id,]
    
    # x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)
    # x.margin.adj <- x.margin*x.factor
    x.margin.adj <- x.margin*(tp/length(data.id$exp))*(tn/length(data.other$exp))*(x.factor**2)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

normalize <- function(x, ...) {
    return((x - min(x, ...)) /(max(x, ...) - min(x, ...)))
}

normalize(a)

tp + fp
log2(4.394653)

get_split_pos.1(mca.spleen, "Cd19", "Marginal zone B cell(Spleen)")
```




```{r}
mca.spleen <- FindVariableFeatures(mca.spleen)
mca.spleen <- ScaleData(mca.spleen)
mca.spleen <- RunPCA(mca.spleen, npcs = 100, ndims.print = 1:5, nfeatures.print = 5)
```




# Get single markers from Seurat and PRAUC

```{r warning=F}
matrix_cometsc <- Seurat::GetAssayData(mca.spleen) #gets the normalized count matrix
write.table(as.matrix(matrix_cometsc), file= "exprs.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)


umap_cometsc <- Embeddings(mca.spleen, reduction = "pca")
umap_cometsc <- umap_cometsc[,c(1,2)]
write.table(umap_cometsc, file="mca.spleen.vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

# umap_cometsc <- Embeddings(so, reduction = "umap")
# write.table(umap_cometsc, file="mca.spleen.vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

Idents(mca.spleen) <- "anno"

mca.spleen@meta.data$anno.n <- as.numeric(Idents(mca.spleen))

Idents(mca.spleen) <- "anno.n"

cluster_cometsc <- noquote(as.matrix((Idents(mca.spleen)))) # Get the active cluster identities. Should be numbers. COMET does not take Non-Number cluster names.

write.table(cluster_cometsc, file = "mca.spleen.clusters.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)


write.table(rownames(mca.spleen), file = "mca.spleen.genes.txt", col.names = F, row.names = F, quote = F)


matrix_cometsc <- Seurat::GetAssayData(mca.spleen) #gets the normalized count matrix

write.table(as.matrix(matrix_cometsc), file= "exprs.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)


# generate Lung data for Comet
matrix_cometsc <- Seurat::GetAssayData(mca.lung) #gets the normalized count matrix
write.table(as.matrix(matrix_cometsc), file= "lung.exprs.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)

mca.lung <- FindVariableFeatures(mca.lung)
mca.lung <- ScaleData(mca.lung)
mca.lung <- RunPCA(mca.lung, npcs = 100, ndims.print = 1:5, nfeatures.print = 5)

umap_cometsc <- Embeddings(mca.lung, reduction = "pca")
umap_cometsc <- umap_cometsc[,c(1,2)]
write.table(umap_cometsc, file="mca.lung.vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)

Idents(mca.lung) <- "anno"
mca.lung@meta.data$anno.n <- as.numeric(Idents(mca.lung))

Idents(mca.lung) <- "anno.n"
cluster_cometsc <- noquote(as.matrix((Idents(mca.lung)))) # Get the active cluster identities. Should be numbers. COMET does not take Non-Number cluster names.
write.table(cluster_cometsc, file = "mca.lung.clusters.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)
rm(matrix_cometsc, cluster_cometsc, umap_cometsc)

```

```{r}
get_split_pos.1(cbmc, "IGHD", "6")
```
```{r}
VlnPlot(cbmc, "IGHD")
```


```{r}
GetAssays(assays, index)
```


```{r}

get_split_pos.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)
  
  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)
    
    x.margin <- tp - fp#*x.size.factor
    # x.margin <- tp - fp*x.size.factor
    # x.margin <- (x.factor**2)*x.margin
    
    # x.margin.adj <- x.margin*x.factor
    x.margin.adj <- x.margin*(tp/length(data.id$exp))*(tn/length(data.other$exp))*(x.factor**2)
    
    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}


get_split_neg.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- (mean(data.other$exp) + 0.001)/(mean(data.id$exp) + 0.001)
  
  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp < x.val)
    fp <- sum(data.other$exp < x.val)
    tn <- sum(data.other$exp >= x.val)
    fn <- sum(data.id$exp >= x.val)
    
    x.margin <- tp - fp#*x.size.factor
    # x.margin <- tp - fp*x.size.factor
    # x.margin <- (x.factor**2)*x.margin
    
    # x.margin.adj <- x.margin*x.factor
    x.margin.adj <- x.margin*(tp/length(data.id$exp))*(tn/length(data.other$exp))*(x.factor**2)
    
    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "-")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}
```





Compare top 9 marker from DE and prauc based method

# Plot PRAUC of TOP 9 Positive markers from DE and prauc based ranking

```{r}
Idents(cbmc) <- "seurat_clusters"

for (x.cluster in seq(1,8)) {
  df.prauc <- markers.prauc[[x.cluster]]
  df.wilcox <- markers.wilcox[[x.cluster]]
  
  g <- ggplot()
  for (genes in intersect(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc$gene[1:9], rownames(df.wilcox)[1:9])) {
    if (df.prauc[df.prauc$gene == genes, ]$direction == "+") {
      df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }else{
      df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }
  }
  print(g)
}

```


# Plot PRAUC of TOP 12 markers from COMET and prauc ranking

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
x.cluster <- 12
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_singleton_all_ranked.csv", sep = ""))
  genes <- genes[1:10, ]
  comet.genes.pos <- genes[genes$Log2FoldChange > 0, ]$gene_1
  comet.genes.neg <- genes[genes$Log2FoldChange < 0, ]$gene_1
  comet.genes.neg <-gsub("_negation", "", comet.genes.neg)
  
  df.prauc <- markers.prauc[[x.cluster]]
  df.prauc <- df.prauc[1:10,]
  df.prauc.pos <- df.prauc[df.prauc$direction == "+", ]$gene
  df.prauc.neg <- df.prauc[df.prauc$direction == "-", ]$gene
  
  g <- ggplot()
  for (genes in intersect(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.pos, comet.genes.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  
  for (genes in intersect(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.neg, comet.genes.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  print(g + xlab("Recall") + ylab("Precision") + ggtitle(paste(x.cluster)))
}

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, comet.genes.pos)
VlnPlot(cbmc, df.prauc.pos)
genes[genes$gene_1 == "CD11c", ]
df.prauc[df.prauc$gene== "CD11c",]
genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", "12", "_singleton_all_ranked.csv", sep = ""))
genes
markers.prauc[[6]]
genes$hgrank + genes$fcrank
markers.i
cbmc <- makeid(cbmc, "12")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "PROM1")
VlnPlot(cbmc, "CD34")
VlnPlot(cbmc, "SPINK2")

```

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "HLA-DOB")
VlnPlot(cbmc, df.prauc.pos)


id <- "6"
gene <- "CD19"

get_split_pos.2 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = normalize(scrna@assays$RNA@data[gene,]),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)
  # x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(0, 1, step)) {
    # tp <- sum(data.id$exp > x.val)
    # fp <- sum(data.other$exp > x.val)
    # tn <- sum(data.other$exp <= x.val)
    # fn <- sum(data.id$exp <= x.val)
    data.i.a <- data.id[data.id$exp > x.val, ]
    data.o.a <- data.other[data.other$exp > x.val, ]
    data.i.b <- data.id[data.id$exp <= x.val, ]
    data.o.b <- data.other[data.other$exp <= x.val, ]

    x.margin <- sum((data.i.a$exp - x.val))*nrow(data.o.b) +
      sum((x.val -data.o.b$exp))*nrow(data.i.a) -
      sum((data.o.a$exp - x.val))*nrow(data.o.b)
    x.margin <- x.margin/data.all.l
    
    # x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)

    # de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    de <- data.frame(x.val, x.margin)
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  x.val <- x.split[,1]
  x.margin <- x.split[,2]
  # data.i.a <- data.id[data.id$exp > x.val, ]
  # tp <- nrow(data.i.a)
  tp <- sum(data.id$exp > x.val)
  # data.o.a <- data.other[data.other$exp > x.val, ]
  # fp <- nrow(data.o.a)
  fp <- sum(data.other$exp > x.val)
  
  # data.i.b <- data.id[data.id$exp <= x.val, ]
  # fn <- nrow(data.i.b)
  # fn <- sum(data.id$exp <= x.val)
  
  # data.o.b <- data.other[data.other$exp <= x.val, ]
  # tn <- nrow(data.o.b)
  tn <- sum(data.other$exp <= x.val)

  x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)
  x.split <- data.frame(gene, x.val, x.margin, x.margin.adj, tp, fp, "+")
  
  # rownames(x.split) <- paste(gene)
  return(x.split)
}


get_split_pos.3 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = normalize(scrna@assays$RNA@data[gene,]),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)

  # x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(0, 1, step)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)
    data.i.a <- data.id[data.id$exp > x.val, ]
    data.o.a <- data.other[data.other$exp > x.val, ]
    data.i.b <- data.id[data.id$exp <= x.val, ]
    data.o.b <- data.other[data.other$exp <= x.val, ]

    # x.margin <- sum((data.i.a$exp - x.val))*nrow(data.o.b) +
    #   sum((x.val -data.o.b$exp))*nrow(data.i.a) -
    #   sum((data.o.a$exp - x.val))*nrow(data.o.b)

    x.margin <- sum((data.id$exp - x.val))*nrow(data.other) +
      sum((x.val - data.other$exp))*nrow(data.id)
    
    x.margin <- x.margin/data.all.l
    
    x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}


x.val <- 0.7016315
Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
VlnPlot(cbmc, "HLA-DOB")
get_split_pos.2(cbmc, "CD19", "6")
get_split_pos.1(cbmc, "CD19", "6")
get_split_pos.1(cbmc, "HLA-DOB", "6")
get_split_pos.1(cbmc, "CD79B", "6")

df <- data.frame()
for (gene in markers.prauc[[6]]$gene[1:20]) {
  df.s <- get_split_pos.2(cbmc, gene, "6")
  df <- rbind(df, df.s)
}
df[order(df$x.margin.adj, decreasing = T), ]

markers.wilcox[[6]]

Idents(cbmc) <- "seurat_clusters"
markers.wilcox.6 <- FindMarkers(cbmc, ident.1 = "12", test.use = "LR")
markers.wilcox.6["CD19",]
markers.wilcox.6["HLA-DOB",]

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, "VPREB3")
VlnPlot(cbmc, "CD19")

markers.i

get_split_pos.2(cbmc, "CD34", "12")
get_split_pos.2(cbmc, "CRHBP", "12")
get_split_pos.1(cbmc, "SPINK2", "12")
get_split_pos.2(cbmc, "SPINK2", "12")

get_split_neg.2 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = normalize(scrna@assays$RNA@data[gene,]),
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- 0
  x.min <- 1
  x.num <- 1/step

  x.factor <- (mean(data.other$exp) + 0.001)/(mean(data.id$exp) + 0.001)
  
  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(0, 1, step)) {
    tp <- sum(data.id$exp < x.val)
    fp <- sum(data.other$exp < x.val)
    tn <- sum(data.other$exp >= x.val)
    fn <- sum(data.id$exp >= x.val)
    data.i.a <- data.id[data.id$exp < x.val, ]
    data.o.a <- data.other[data.other$exp < x.val, ]
    data.i.b <- data.id[data.id$exp >= x.val, ]
    data.o.b <- data.other[data.other$exp >= x.val, ]

    x.margin <- sum((data.i.a$exp - x.val))*nrow(data.o.b) +
      sum((x.val -data.o.b$exp))*nrow(data.i.a) -
      sum((data.o.a$exp - x.val))*nrow(data.o.b)
    
    x.margin <- 0-x.margin
    x.margin <- x.margin/data.all.l

    # x.margin <- sum((data.id[data.id$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id) +
    #   sum((x.val - data.other[data.other$exp <x.val, ]$exp))*length(data.id[data.id$exp > x.val, ]$id) -
    #   sum((data.other[data.other$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id)

    x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)

    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

```


# Detect combine markers for interested cell groups

```{r}
# makers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   df.split <- Detect_combine_markers(cbmc, x.cluster, markers.allset, max.gene = 50)
#   makers.prauc[[x.cluster]] <- df.split
# }

load(file = "first8clusters.combine.markers.rds")

makers.prauc

id <- "6"
df <- data.frame(exp1 = normalize(cbmc@assays$RNA@data["FCRLA",]),
                 exp2 = normalize(cbmc@assays$RNA@data["HLA-DRA",]),
                 id = as.character(cbmc@active.ident))


df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

dist(rbind(df.i$exp1, df.i$exp2))
dist(rbind(df.o$exp1, df.o$exp2))



x.seq <- 1
df.all <- data.frame()
for (x.seq in 1:nrow(makers.prauc[[5]])) {
  gene.c <- makers.prauc[[5]][x.seq,]
  df <- data.frame(exp1 = cbmc@assays$RNA@data[gene.c$Gene1,],
                   exp2 = cbmc@assays$RNA@data[gene.c$Gene2,],
                   id = as.character(cbmc@active.ident))
  df.i <- df[df$id == "5", ]
  df.o <- df[df$id != "5", ]
  # print(gene.c)
  df.s <- data.frame(gene.c$Gene1, gene.c$Gene2, cor(df.i$exp1, df.i$exp2), cor(df.o$exp1, df.o$exp2))
  colnames(df.s) <- c("gene1", "gene2", "cor.i", "cor.o")
  df.all <- rbind(df.all, df.s)
}

cbmc <- makeid(cbmc, "6")
df <- data.frame(exp1 = cbmc@assays$RNA@data["CD19",],
                 exp2 = cbmc@assays$RNA@data["HLA-DRA",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data["CD79B",],
                 exp2 = cbmc@assays$RNA@data["HLA-DRA",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

normalize <- function(x, ...) {
    return((x - min(x, ...)) /(max(x, ...) - min(x, ...)))
}

x <- c(1, NA, 2, 3)

normalize(x, na.rm = TRUE)

rownames(markers.wilcox[[6]])

Detect_combine_markers.1 <- function(scrna, id, geneset, step = 0.1, max.gene = NULL){
  gene.combn <- t(combn(geneset, 2))
  gene.combn.prauc <- data.frame()

  for (gene.iter in 1:length(gene.combn[,1])) {
    
    genes <- gene.combn[gene.iter,]
    gene1 <- genes[1]
    gene2 <- genes[2]
    
    df <- data.frame(exp1 = scale(scrna@assays$RNA@data[gene1,]),
                     exp2 = scale(scrna@assays$RNA@data[gene2,]),
                     id = as.character(scrna@active.ident))
  
    df.i <- df[df$id == id, ]
    df.o <- df[df$id != id, ]
    
    # x.fc1 <- round((mean(df.i$exp1) + 0.001)/(mean(df.o$exp1) + 0.001), 3)
    # x.fc2 <- round((mean(df.i$exp2) + 0.001)/(mean(df.o$exp2) + 0.001), 3)
    
    x.dist <- as.numeric(dist(rbind(df.o$exp1, df.o$exp2))/dist(rbind(df.i$exp1, df.i$exp2)))
    
    # x.dist <- x.dist*((x.fc1*x.fc2))

    de <- data.frame(gene1, gene2, x.dist)
    colnames(de) <- c("Gene1", "Gene2", "dist")
    gene.combn.prauc <- rbind(gene.combn.prauc, de)
  }
  gene.combn.prauc <- gene.combn.prauc[order(gene.combn.prauc$dist, decreasing = T),]
  return(gene.combn.prauc)
}

```

```{r}
x.dist.6 <- Detect_combine_markers.1(cbmc, "6", rownames(df.6)[1:50])
```


```{r}
cbmc <- makeid(cbmc, "6")
df <- data.frame(exp1 = cbmc@assays$RNA@data["CD79B",],
                 exp2 = cbmc@assays$RNA@data["CD74",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = scale(cbmc@assays$RNA@data["HLA-DRA",]),
                 exp2 = scale(cbmc@assays$RNA@data["LTB",]),
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data["HLA-DRA",],
                 exp2 = cbmc@assays$RNA@data["FCRLA",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))


```

```{r}
id <- "6"
df <- data.frame(exp1 = normalize(cbmc@assays$RNA@data["CD79B",]),
                 exp2 = normalize(cbmc@assays$RNA@data["CD74",]),
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

df[df$exp1 >  quantile(df.i$exp1, 0.5), ]$exp1 <- 1
df[df$exp1 != 1, ]$exp1 <- 0

df[df$exp2 >  quantile(df.i$exp2, 0.5), ]$exp2 <- 1
df[df$exp2 != 1, ]$exp2 <- 0

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

dist(rbind(df.o$exp1, df.o$exp2))
dist(rbind(df.i$exp1, df.i$exp2))


plot(df$exp1, df$exp2)


dist(rbind(df.o$exp1, df.o$exp2))/dist(rbind(df.i$exp1, df.i$exp2))

df <- data.frame(exp1 = scale(cbmc@assays$RNA@data["RPSA",]),
                 exp2 = scale(cbmc@assays$RNA@data["HLA-DRA",]),
                 id = as.character(cbmc@active.ident))

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

df[df$exp1 >  quantile(df.i$exp1, 0.5), ]$exp1 <- 1
df[df$exp1 != 1, ]$exp1 <- 0

df[df$exp2 >  quantile(df.i$exp2, 0.5), ]$exp2 <- 1
df[df$exp2 != 1, ]$exp2 <- 0

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]


dist(rbind(df.o$exp1, df.o$exp2))/dist(rbind(df.i$exp1, df.i$exp2))
```

```{r}
get_PRAUC_matrix_combine_markers.1 <- function(scrna, gene1,  gene2, id, step = 0.01){
  data.mat.surf <- data.frame(gene1 = scrna@assays$RNA@data[gene1,],
                              gene2 = scrna@assays$RNA@data[gene2,],
                              id = as.character(makeid(scrna, id)@active.ident))
  gene.prauc <- data.frame(x.pre <- c(),
                           x.rec <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  
  x.seq <- seq(0.05, 0.95, step)

  for (x.val in quantile(data.id$gene1, x.seq)) {
    for (y.val in quantile(data.id$gene2, x.seq)) {
      tp <- sum(data.id$gene1 > x.val & data.id$gene2 > y.val)
      fp <- sum(data.other$gene1 > x.val & data.other$gene2 > y.val)
      fn <- sum(data.id$gene1 <= x.val | data.id$gene2 <= y.val)
      x.pre <- tp/(tp + fp)
      x.rec <- tp/(tp + fn)
      de <- data.frame(x.pre, x.rec)
      gene.prauc <- rbind(gene.prauc, de)
    }
  }
  gene.prauc <- gene.prauc[complete.cases(gene.prauc), ]
  gene.prauc <- gene.prauc[order(gene.prauc$x.rec), ]
  return(gene.prauc)
}
df <- get_PRAUC_matrix_combine_markers.1(cbmc, "CD79B", "CD74", "6", step = 0.1)

plot(df$x.rec, df$x.pre)

ggplot(df)+
  geom_line(aes(x.rec, x.pre), se = FALSE)

df <- get_PRAUC_matrix_combine_markers.1(cbmc, "FCRLA", "HLA-DRA", "6", step = 0.1)

plot(df$x.rec, df$x.pre)

ggplot(df)+
  geom_line(aes(x.rec, x.pre), se = FALSE)


```


```{r fig.width=10, fig.height=8}
scrna <- cbmc
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  
  # x.df <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.1)
  # x.df$method <- "COMET"
  
  if (!grepl("_negation", genes[1])) {
    if (!grepl("_negation", genes[2])) {
      gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }else{
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }else{
      if (!grepl("_negation", genes[2])) {
        genes[1] <- gsub("_negation", "", genes[1])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[2], gene2 = genes[1], id = x.cluster, step = 0.01)
      }else{
        genes[1] <- gsub("_negation", "", genes[1])
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }

  x.df <- gene.prauc
  x.df$method <- "COMET"
  # g <- ggplot() + geom_line(gene.prauc.comet, mapping = aes(x.rec, x.pre, color = method)) + xlim(c(0,1)) + ylim(c(0,1))
  
  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  Direction.c <- paste(df.split[1, ]$Direction1, df.split[1, ]$Direction2, sep = "")
  if (Direction.c == "++") {
    gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "+-") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "-+") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene2, gene2 = gene1, id = x.cluster, step = 0.01)
  }else{
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }
  
  x.df.2 <- gene.prauc
  x.df.2$method <- "PRAUC"
  
  x.df <- rbind(x.df, x.df.2)

  print(ggplot() + geom_line(x.df, mapping = aes(x.rec, x.pre, col = method)) + ggtitle(paste(x.cluster))+ 
          xlim(c(0,1)) + ylim(c(0,1)))
}
```


# Dotplot of Combine markers

```{r fig.width=10, fig.height=5}
for (x.cluster in seq(1,8)) {
  scrna <- makeid(scrna, x.cluster)
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_grid_2(cbmc, gene1, gene2, gene1.direc, gene2.direc, x.cluster, return.obj = T) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_grid_2(cbmc, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster, return.obj = T) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```





# Umap plot of combine markers

```{r fig.height = 7, fig.width=18}
Idents(cbmc) <- "seurat_clusters"
plot_marker_c_umap(cbmc, "TCL1A", "CD79B", "+", "+", "6")
scrna <- cbmc
Idents(scrna) <- "seurat_clusters"
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_marker_c_umap(scrna, gene1, gene2, gene1.direc, gene2.direc, x.cluster) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_marker_c_umap(scrna, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```

```{r}
cbmc.enhance <- enhance_seurat_wrapper(cbmc)
id <- "5"
gene1 <- "MYL3"
gene2 <- "FTH1"

df <- data.frame(exp1 = cbmc.enhance[gene1,],
                 exp2 = cbmc.enhance[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data[gene1,],
                 exp2 = cbmc@assays$RNA@data[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

```




# step by step (Maximam Recall approach)

```{r}
# markers.max_recall <- list()
# for (x.cluster in seq(1,8)) {
#   markers.i <- marker_stepbystep(cbmc, x.cluster, depth = 2, markers.allset)
#   markers.max_recall[[x.cluster]] <- markers.i
# }
# save(markers.max_recall, file = "first8.stepbystep.rds")
load(file = "first8.stepbystep.rds")
for (x.cluster in seq(1,8)) {
  markers.i <- markers.max_recall[[x.cluster]]
  print(grid_plot(cbmc, markers.i, x.cluster))
}
```                                                                                                                                                                                               

```{r}
start_time <- Sys.time() 
all.markers.lr <- FindAllMarkers(mca.lung, test.use = "LR") 
end_time <- Sys.time() 
lung.lr <- end_time - start_time 

start_time <- Sys.time() 
all.markers.t <- FindAllMarkers(mca.lung, test.use = "t") 
end_time <- Sys.time() 
lung.t <- end_time - start_time 

start_time <- Sys.time() 
all.markers.wilcox <- FindAllMarkers(mca.lung, test.use = "wilcox") 
end_time <- Sys.time() 
lung.wilcox <- end_time - start_time 

start_time <- Sys.time() 
all.markers.mast <- FindAllMarkers(mca.lung, test.use = "MAST") 
end_time <- Sys.time() 
lung.mast <- end_time - start_time 

rm(scrna)

load("/home/ronghui/project/scRNA/exp/hematology/MPN/Review_pack/objects/tpo.umap.seurat2.rds")
tpo <- UpdateSeuratObject(tpo)
DimPlot(tpo, reduction = "umap")

tpo@meta.data

Idents(tpo) <- "Clusters"
tpo <- RenameIdents(object = tpo, `1` = "MSC1.2")
tpo <- RenameIdents(object = tpo, `2` = "MSC1.2")
tpo <- RenameIdents(object = tpo, `3` = "MSC3.4")
tpo <- RenameIdents(object = tpo, `4` = "MSC3.4")
tpo <- RenameIdents(object = tpo, `5` = "nmSCPs")
tpo <- RenameIdents(object = tpo, `6` = "mSCPs")
tpo <- RenameIdents(object = tpo, `7` = "OLC")
tpo <- RenameIdents(object = tpo, `8` = "endothelial cells")
# tpo <- RenameIdents(object = tpo, `5` = "5, nonmyelinating SCPs")
# tpo <- RenameIdents(object = tpo, `6` = "6, myelinating SCPs")
# tpo <- RenameIdents(object = tpo, `7` = "7, OLC")
# tpo <- RenameIdents(object = tpo, `8` = "8, endothelial cells")

outdir <- "/home/ronghui/project/scRNA/exp/hematology/MPN/output"

Ly_molecules <- read.csv(file=file.path(outdir, "Ly.csv"))[ ,5]

#  Ly molecules A
Ly_molecules_A <- read.csv(file=file.path(outdir, "Ly_A.csv"))[ ,5]

# Mouse CD molecules
CD_molecules <- read.csv(file=file.path(outdir, "Cd.csv"))[ ,2]

# Mouse CD molecules A
CD_molecules_A <- read.csv(file=file.path(outdir, "Cd_A.csv"))[ ,2]

# Mouse CD molecules B
CD_molecules_B <- read.csv(file=file.path(outdir, "Cd_B.csv"))[ ,2]

all <- list(Ly = Ly_molecules, Ly_A = Ly_molecules_A,
            Cd = CD_molecules, Cd_A = CD_molecules_A, Cd_B = CD_molecules_B)

all_genes <- c(as.character(Ly_molecules), as.character(Ly_molecules_A), as.character(CD_molecules), 
               as.character(CD_molecules_A), as.character(CD_molecules_B))
all_genes <- unique(all_genes)
all_genes <- firstup(tolower(all_genes))
all_genes = intersect(all_genes, rownames(tpo@assays$RNA@data))

get_split_pos.2(tpo, "Cd63", "MSC1.2")

df <- data.frame(exp1 = tpo@assays$RNA@data["Pdgfrb",],
                 exp2 = tpo@assays$RNA@data["Pdgfra",],
                 id = as.character(tpo@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

de.tpo <- FindAllMarkers(tpo, features = all_genes, test.use = "wilcox")
de.tpo <- de.tpo %>% group_by(cluster)
de.tpo.12 <- de.tpo[de.tpo$cluster == "MSC1.2", ]
de.tpo.12

get_split_pos.2(tpo, "Cd63", "MSC1.2")
get_split_pos.2(tpo, "Pdgfra", "MSC1.2")
get_split_pos.2(tpo, "Pdgfrb", "MSC1.2")

df.12 <- data.frame()
for (gene in all_genes) {
  df.s <- get_split_pos.2(tpo, gene, "MSC1.2")
  df.12 <- rbind(df.12, df.s)
}
df.12[order(df.12$x.margin.adj, decreasing = T), ]


df.12[order(df.12$x.margin, decreasing = T), ]


df <- data.frame(exp1 = tpo@assays$RNA@data["Vcam1",],
                 exp2 = tpo@assays$RNA@data["Pdgfrb",],
                 id = as.character(tpo@active.ident))
ggplot(df) + geom_point(aes(exp1, exp2, col = id))


g1 <- FeaturePlot(tpo, "Vcam1")
g2 <- FeaturePlot(tpo, "Pdgfrb")
g3 <- FeaturePlot(tpo, "Pdgfra")
g4 <- UMAPPlot(tpo)
g5 <- FeaturePlot(tpo, "Cd63")

g4$data$Vcam1 <- g1$data$Vcam1
g4$data$Pdgfrb <- g2$data$Pdgfrb
g4$data$Pdgfra <- g3$data$Pdgfra
g4$data$Cd63 <- g5$data$Cd63

g4$data$ident <- factor(g4$data$ident, levels = c("MSC1.2", "MSC3.4", 
                                                  "nmSCPs", "mSCPs",
                                                  "OLC", "endothelial cells"))


g4 %+% g4$data + 
  scale_color_manual(values = my_color_palette) + ggtitle("Umap Reduction of MPN")

g4 %+% g4$data[g4$data$Vcam1 > 0 & g4$data$Pdgfrb > 0 & g4$data$Pdgfra > 0, ]+ 
  scale_color_manual(values = my_color_palette) + xlim(c(-5.5, 5.5)) + ylim(c(-5, 6)) + ggtitle("Vcam1 + Pdgfra + Pdgfrb")
g4 %+% g4$data[g4$data$Vcam1 > 0 & g4$data$Pdgfrb > 0 & g4$data$Pdgfra > 0 & g4$data$Cd63 > 2.5, ] + 
  scale_color_manual(values = my_color_palette) + xlim(c(-5, 6)) + ylim(c(-5, 6)) + ggtitle("Cd63")

require(scales)
identities <- levels(tpo@active.ident)

my_color_palette <- hue_pal()(length(identities))
my_color_palette <- rev(my_color_palette)


tpo.msc <- subset(tpo, subset = Vcam1 > 0.50)
table(tpo.msc@active.ident)
tpo.msc <- subset(tpo.msc, subset = Pdgfrb > 0.1)
table(tpo.msc@active.ident)
tpo.msc <- subset(tpo.msc, subset = Pdgfra > 0.1)
table(tpo.msc@active.ident)

tpo.msc <- subset(tpo, subset = Vcam1 > 0.10 & Pdgfrb > 0.1 & Pdgfra > 0.1)

tpo.msc12 <- subset(tpo.msc, subset = Cd63 > 2.5)
tpo.msc34 <- subset(tpo.msc, subset = Cd63 < 0.5)
table(tpo@active.ident)
table(tpo.msc@active.ident)
table(tpo.msc34@active.ident)



table(tpo.msc12$Clusters)
max(FetchData(object = tpo.msc, vars = 'Cd63'))

tpo.msc <- subset(tpo, subset = Vcam1 > 1)
table(tpo.msc$Clusters)
df.step1 <- data.frame()
for (gene in all_genes) {
  df.s <- get_split_pos.2(tpo.msc, gene, "MSC1.2")
  df.step1 <- rbind(df.step1, df.s)
}
df.step1[order(df.step1$x.margin.adj, decreasing = T), ]

tpo.msc <- subset(tpo, subset = Vcam1 > 1.316387)
table(tpo.msc$Clusters)
tpo.msc <- subset(tpo.msc, subset = Cd63 > 2)
table(tpo.msc$Clusters)


get_split_pos(tpo, "Vcam1", "MSC1.2")
get_split_pos(tpo.msc, "Pdgfrb", "MSC1.2")
get_split_pos(tpo.msc, "Cd81", "MSC1.2")

VlnPlot(tpo.msc, "Pdgfrb")

pie(table(tpo@active.ident))
tpo.msc <- subset(tpo, subset = Vcam1 > 0)
pie(table(tpo.msc@active.ident))
tpo.msc <- subset(tpo.msc, subset = Pdgfrb > 0)
pie(table(tpo.msc@active.ident))
tpo.msc <- subset(tpo.msc, subset = Pdgfra > 0)
pie(table(tpo.msc@active.ident))
tpo.msc.1 <- subset(tpo.msc, subset = Cd63 > 0)
pie(table(tpo.msc.1@active.ident))

tpo.msc.2 <- subset(tpo.msc, subset = Cd63 < 0.1)
pie(table(tpo.msc.2@active.ident))

```

```{r}
library(tidyr)
library(ggplot2)
library(dplyr)
data_wide <- iris[ , c(3,1)]

colnames(data_wide) <- c("Cellgroup", "Other")
data_wide <- data_wide[, c(2,1)]
colnames(data_wide) <- c("Cellgroup", "Other")

# pdf("plots/method.des.1.pdf")
data_wide %>% 
  gather(key="Cell.ID", value="Val") %>%
  ggplot( aes(x=Cell.ID, y=Val, fill=Cell.ID)) +
    geom_violin() + xlab("") + 
    geom_hline(aes(yintercept = 5.5), linetype = "longdash") +
    geom_text(aes(1.5, 5.5, label = "split.value", vjust = -1), size = 5)+
    annotate(
      "text", label = "A",
      x = "Cellgroup", y = 6, size = 8, colour = "black"
      )+
    annotate(
      "text", label = "B",
      x = "Cellgroup", y = 5, size = 8, colour = "black"
      )+
    annotate(
      "text", label = "C",
      x = "Other", y = 6, size = 8, colour = "black"
      )+
    annotate(
      "text", label = "D",
      x = "Other", y = 5, size = 8, colour = "black"
      )
# dev.off()



 gene.split.score = sum(A - split.value)*size(D) + sum(split.value - D)*size(A)  - sum(C - spllit.value)**size(D)
 
 gene.ranking.score = gene.split.score*(A/(A+B))*(D/(C+D))*(mean(A+B)/mean(C+D))^2


```



```{r}
Idents(tpo) <- "Clusters"
tpo <- RenameIdents(object = tpo, `1` = "MSC")
tpo <- RenameIdents(object = tpo, `2` = "MSC")
tpo <- RenameIdents(object = tpo, `3` = "MSC")
tpo <- RenameIdents(object = tpo, `4` = "MSC")
tpo <- RenameIdents(object = tpo, `5` = "nmSCPs")
tpo <- RenameIdents(object = tpo, `6` = "mSCPs")
tpo <- RenameIdents(object = tpo, `7` = "OLC")
tpo <- RenameIdents(object = tpo, `8` = "endothelial cells")

df.msc <- data.frame()
for (gene in all_genes) {
  df.s <- get_split_pos.2(tpo, gene, "MSC")
  df.msc <- rbind(df.msc, df.s)
}
df.msc[order(df.msc$x.margin, decreasing = T), ]


tpo.msc <- subset(tpo, subset = Vcam1 > 0)
table(tpo.msc@active.ident)

df.msc <- data.frame()
for (gene in all_genes) {
  df.s <- get_split_pos.2(tpo.msc, gene, "MSC")
  df.msc <- rbind(df.msc, df.s)
}
df.msc[order(df.msc$x.margin, decreasing = T), ]

tpo.msc <- subset(tpo.msc, subset = Pdgfrb > 0)
table(tpo.msc@active.ident)

df.msc <- data.frame()
for (gene in all_genes) {
  df.s <- get_split_pos.2(tpo.msc, gene, "MSC")
  df.msc <- rbind(df.msc, df.s)
}
df.msc[order(df.msc$x.margin, decreasing = T), ]


tpo.msc <- subset(tpo.msc, subset = Pdgfra > 0)
table(tpo.msc@active.ident)

tpo.msc <- subset(tpo, subset = Vcam1 > 0)
table(tpo.msc@active.ident)
tpo.msc <- subset(tpo.msc, subset = Pdgfrb > 0)
table(tpo.msc@active.ident)
tpo.msc <- subset(tpo.msc, subset = Pdgfra > 0)
table(tpo.msc@active.ident)

```


```{r}
get_split_pos_pos(tpo, "Pdgfrb",	"Pdgfra", "MSC1.2", step = 0.1)
get_split_pos_pos(tpo, "Vcam1",	"Pdgfra", "MSC1.2", step = 0.1)
get_split_pos_pos(tpo, "Vcam1",	"Pdgfrb", "MSC1.2", step = 0.1)
tpo.c
tpo.c <- Detect_combine_markers.c(tpo, "MSC1.2", geneset = all_genes)
tpo.c2 <- Detect_combine_markers.c(tpo.s, "MSC1.2", geneset = all_genes)


0.2*max(tpo@assays$RNA@data["Vcam1",])

tpo.1234 <- subset(tpo, idents = c("MSC1.2", "MSC3.4"))


df.1234 <- data.frame()
for (gene in all_genes) {
  df.s <- get_split_pos.2(tpo.1234, gene, "MSC1.2")
  df.1234 <- rbind(df.1234, df.s)
}
df.1234[order(df.1234$x.margin.adj, decreasing = T), ]
de.1234
de.1234 <- FindMarkers(tpo.1234, ident.1 = "MSC1.2", features = all_genes)

marker_stepbystep.2 <- function(scrna, cellgroup, depth = 2, geneset = NULL, step = 0.01){
  if (is.null(geneset)) {
    geneset <- rownames(scrna[["RNA"]])
  }
  geneset <- intersect(rownames(scrna[["RNA"]]), geneset)
  len.id <- sum(scrna@active.ident == cellgroup)
  len.other <- sum(scrna@active.ident != cellgroup)
  df.split <- data.frame()

  for (variable in seq(depth)) {
    df.fc <- FoldChange(scrna, ident.1 = cellgroup, features = geneset)
    # markers <- get_split_pos.2(scrna, ident.1 = cellgroup, features = geneset)
    # markers <- subset(markers, p_val < 0.05)

    markers.pos <- subset(df.fc, avg_log2FC > 0)
    markers.neg <- subset(df.fc, avg_log2FC < 0)

    gene.prauc <- data.frame()

    for (genes in rownames(markers.pos)) {
      de <- data.frame(genes, get_split_pos.2(scrna, genes, cellgroup, step))
      names(de)<-c("gene", "split.value","x.margin", "x.margin.adj", "tp", "fp", "direction")
      gene.prauc <- rbind(gene.prauc, de)
    }
    # for (genes in rownames(markers.neg)) {
    #   de <- data.frame(genes, get_split_neg.2(scrna, genes, cellgroup, step))
    #   names(de)<-c("gene", "split.value","x.margin", "x.margin.adj", "tp", "fp", "direction")
    #   gene.prauc <- rbind(gene.prauc, de)
    # }
    gene.prauc <- gene.prauc[order(gene.prauc$x.margin.adj, decreasing = T),]
    
    df <- gene.prauc[1,]
    if (df$direction == "+") {
      split.step <- get_split_pos(scrna, df$gene, cellgroup)
    }else{
      split.step <- get_split_neg(scrna, df$gene, cellgroup)
    }
    
    names(split.step) <- c("split.value", "split.margin", "direction")
    
    df.split <- rbind(df.split, split.step)

    left.cells <- GetCellNames(scrna = scrna, gene = df$gene, value = df.split$split.value, direction = df.split$direction)
    scrna <- subset(scrna, cells = left.cells)
    geneset <- setdiff(geneset, df$gene)
  }
  return(df.split)
}

df <- marker_stepbystep.2(tpo, "MSC1.2", depth = 3, step = 0.01, geneset = all_genes)

df <- FoldChange(tpo, ident.1 = "MSC1.2", features = all_genes)
markers.pos <- subset(df, avg_log2FC > 0)
markers.neg <- subset(df, avg_log2FC < 0)

gene.prauc <- data.frame()
    for (genes in rownames(markers.pos)) {
      de <- data.frame(genes, get_split_pos.2(tpo, genes, "MSC1.2", 0.01))
      names(de)<-c("gene", "split.value","x.margin", "x.margin.adj", "tp", "fp", "direction")
      gene.prauc <- rbind(gene.prauc, de)
    }

df <- get_split_pos.2(tpo, "Cd63", "MSC1.2")

rbind(df.split, df)

names(df)<-c("gene", "split.value","x.margin", "x.margin.adj", "tp", "fp", "direction")

df
df <- get_split_pos(tpo, "Vcam1", "MSC1.2")
 names(df) <- c("split.value", "split.margin", "direction")
 df

VlnPlot(tpo, "Vcam1")

GetCellNames()

df$direction
```


```{r}
marker_stepbystep <- function(scrna, cellgroup, depth = 2, geneset = NULL, step = 0.01){
  if (is.null(geneset)) {
    geneset <- rownames(scrna)
  }
  geneset <- intersect(rownames(scrna[["RNA"]]), geneset)
  len.id <- sum(scrna@active.ident == cellgroup)
  len.other <- sum(scrna@active.ident != cellgroup)
  df.split <- data.frame()

  for (variable in seq(depth)) {
    markers <- FindMarkers(scrna, ident.1 = cellgroup, features = geneset)
    markers <- subset(markers, p_val < 0.05)

    markers.pos <- subset(markers, avg_log2FC > 0)
    markers.neg <- subset(markers, avg_log2FC < 0)

    gene.prauc <- data.frame()

    for (genes in rownames(markers.pos)) {
      de <- data.frame(genes, get_split_pos.2(scrna, genes, cellgroup, step))
      names(de)<-c("gene", "split.value","x.margin", "x.margin.adj", "tp", "fp", "direction")
      gene.prauc <- rbind(gene.prauc, de)
    }
    for (genes in rownames(markers.neg)) {
      de <- data.frame(genes, get_split_neg.2(scrna, genes, cellgroup, step))
      names(de)<-c("gene", "split.value","x.margin", "x.margin.adj", "tp", "fp", "direction")
      gene.prauc <- rbind(gene.prauc, de)
    }
    gene.prauc <- gene.prauc[order(gene.prauc$x.margin.adj, decreasing = T),]

    df.split <- rbind(df.split, gene.prauc[1,])

    left.cells <- GetCellNames(scrna, gene.prauc[1,1], gene.prauc[1,2], gene.prauc[1,4])
    scrna <- subset(scrna, cells = left.cells)
  }
  return(df.split)
}

marker_stepbystep.c <- function(scrna, cellgroup, depth = 2, geneset = NULL, step = 0.01){
  if (is.null(geneset)) {
    geneset <- rownames(scrna)
  }
  geneset <- intersect(rownames(scrna[["RNA"]]), geneset)
  len.id <- sum(scrna@active.ident == cellgroup)
  len.other <- sum(scrna@active.ident != cellgroup)
  df.split <- data.frame()

  for (variable in seq(depth)) {
    markers <- FindMarkers(scrna, ident.1 = cellgroup, features = geneset)
    markers.pos <- subset(markers, avg_log2FC > 0)
    markers.neg <- subset(markers, avg_log2FC < 0)

    gene.prauc <- data.frame()

    for (genes in rownames(markers.pos)) {
      de <- data.frame(genes, get_split_pos.2(scrna, genes, cellgroup, step))
      names(de)<-c("gene", "split.value","filtered.adj", "direction")
      gene.prauc <- rbind(gene.prauc, de)
    }
    for (genes in rownames(markers.neg)) {
      de <- data.frame(genes, get_split_neg(scrna, genes, cellgroup, step))
      names(de)<-c("gene", "split.value","filtered.adj", "direction")
      gene.prauc <- rbind(gene.prauc, de)
    }
    gene.prauc <- gene.prauc[order(gene.prauc$filtered.adj, decreasing = T),]

    df.split <- rbind(df.split, gene.prauc[1,])

    left.cells <- GetCellNames(scrna, gene.prauc[1,1], gene.prauc[1,2], gene.prauc[1,4])
    scrna <- subset(scrna, cells = left.cells)
  }
  return(df.split)
}

Detect_combine_markers.c <- function(scrna, id, geneset = NULL, step = 0.1, max.gene = NULL){
  # if (is.null(geneset)) {
  #   de.genes <- FindMarkers(scrna, ident.1 = id, test.use = "t")
  # }else{
  #   de.genes <- FindMarkers(scrna, ident.1 = id, test.use = "t", features = geneset)
  # }
  # de.genes$gene <- rownames(de.genes)
  # de.genes <- subset(de.genes, p_val < 0.05)
  
  gene.fc <- FoldChange(scrna, ident.1 = id, features = geneset)
  
  # if (max.gene & length(x.split$gene) > max.gene) {
  #   x.split <- x.split[1:max.gene, ]
  # }
  
  # de.genes.p <- subset(de.genes, avg_log2FC > 0)
  # de.genes.n <- subset(de.genes, avg_log2FC < 0)
  
  de.genes.p <- subset(gene.fc, avg_log2FC > 0)
  de.genes.n <- subset(gene.fc, avg_log2FC < 0)
  
  print("Predicting positive markers")
  gene.combn <- t(combn(de.genes.p$gene, 2))
  gene.combn.prauc <- data.frame()
  
  pb <- txtProgressBar(style=3)
  star_time <- Sys.time()

  for (gene.iter in 1:nrow(gene.combn)) {
    genes <- gene.combn[gene.iter,]
    gene1 <- genes[1]
    gene2 <- genes[2]
    de <- get_split_pos_pos(scrna, gene1,	gene2, id, step = 0.1)
    
    # colnames(de) <- c("Gene1", "Gene2", "Gene1.split", "Gene2.split", "x.margin", "x.margin.adj", "TP", "FP", "Direction1", "Direction2")
    gene.combn.prauc <- rbind(gene.combn.prauc, de)
    setTxtProgressBar(pb, gene.iter/nrow(gene.combn))
  }
  end_time <- Sys.time()
  close(pb)
  run_time <- end_time - star_time
  print(run_time)
  gene.combn.prauc <- gene.combn.prauc[order(gene.combn.prauc$x.margin.adj, decreasing = T),]
  return(gene.combn.prauc)
}



```

```{r}
df.step <- marker_stepbystep(tpo, "MSC1.2", depth = 4, geneset = all_genes)

print(grid_plot(tpo, df.step, "MSC1.2"))
tpo <- makeid(tpo, "MSC1.2")

makeid <- function(scrna, id, panel = "seurat_clusters"){
  levels(scrna@active.ident) <- c(levels(scrna@active.ident), "other")
  scrna@active.ident[scrna@active.ident != id] <- 'other'
  return(scrna)
}

table(tpo@active.ident)
```




