---
title: "Cell marker identification with seurat samples"
author: "Ronghui"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
# .libPaths("~/R/x86_64-pc-linux-gnu-library/3.6")
library(Seurat)
library(dplyr, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
library(ggplot2, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
suppressMessages(library(cowplot, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(randomForest, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(patchwork))
suppressMessages(library(data.table))
suppressMessages(library(MLmetrics))
source("/home/ronghui/project/scMarkerDetect/R/Cell_markers.ident.R")
source("/home/ronghui/project/scMarkerDetect/enhance-R-master/enhance.R")
# library(scMarkerDetect)
```



```{r pressure, echo=FALSE, fig.height=9, fig.width=12}
markers.allset <- read.csv(file=file.path("/home/ronghui/project/scMarkerDetect/gene_db/proteinatlas.ihc.csv"))[ ,1]

# markers.allset <- read.csv(file=file.path("/home/ronghui/project/dbmaker/abcam.tr.csv"))[ ,1]
# markers.allset <- unique(markers.allset)
# 
# markers.allset <- gsub(" ", "", markers.allset)
# # markers.allset <- gsub("-", "", markers.allset)
# 
# 
# cbmc.rna <- as.sparse(read.csv(file = "GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz", sep = ",",
#     header = TRUE, row.names = 1))
# 
# cbmc.rna <- CollapseSpeciesExpressionMatrix(cbmc.rna)
# 
# 
# markers.allset <- intersect(rownames(cbmc.rna) ,markers.allset)
# 
# length(markers.allset)

markers.allset <- c(as.character(markers.allset))
markers.allset <- unique(markers.allset)
```

# Seurat example

```{r}
# DefaultAssay(cbmc) <- "RNA"
# DefaultAssay(cbmc)
# 
# cbmc <- NormalizeData(cbmc)
# cbmc <- FindVariableFeatures(cbmc)
# cbmc <- ScaleData(cbmc)
# cbmc <- RunPCA(cbmc, verbose = FALSE)
# cbmc <- FindNeighbors(cbmc, dims = 1:30)
# cbmc <- FindClusters(cbmc, resolution = 0.8, verbose = FALSE)
# cbmc <- RunUMAP(cbmc, dims = 1:30)

load("/home/ronghui/project/dbmaker/seurat.cbmc.rds")
DimPlot(cbmc, label = TRUE)
```



```{r}
# # Normalize ADT data,
# DefaultAssay(cbmc) <- "ADT"
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2)
# DefaultAssay(cbmc) <- "RNA"
# 
# # Note that the following command is an alternative but returns the same result
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2, assay = "ADT")

# Now, we will visualize CD14 levels for RNA and protein By setting the default assay, we can
# visualize one or the other
DefaultAssay(cbmc) <- "ADT"
p1 <- FeaturePlot(cbmc, "CD19", cols = c("lightgrey", "darkgreen")) + ggtitle("CD19 protein")
DefaultAssay(cbmc) <- "RNA"
p2 <- FeaturePlot(cbmc, "CD19") + ggtitle("CD19 RNA")

rownames(cbmc[["ADT"]])

UMAPPlot(cbmc, label = T)
for (gene in intersect(rownames(cbmc[["ADT"]]), rownames(cbmc[["RNA"]]))) {
  print(FeaturePlot(cbmc, gene, cols = c("lightgrey", "darkgreen")))
}

intersect(rownames(cbmc[["ADT"]]), rownames(cbmc[["RNA"]]))

# place plots side-by-side
p1 | p2

pdf("Citeseq.cd19.pdf", width = 14, height = 10)
DefaultAssay(citeseq) <- "ADT"
p1 <- FeaturePlot(citeseq, "CD19", cols = c("lightgrey", "darkgreen"), reduction = "wnn.umap") + ggtitle("CD19 protein")
DefaultAssay(citeseq) <- "SCT"
p2 <- FeaturePlot(citeseq, "CD19", reduction = "wnn.umap") + ggtitle("CD19 RNA")
print(p1 | p2)
dev.off()
```

# Get single markers from Seurat and PRAUC

```{r warning=F}
Idents(cbmc) <- "seurat_clusters"

markers.wilcox <- list()
markers.prauc <- list()
for (x.cluster in seq(1,8)) {
  markers <- FindMarkers(cbmc, ident.1 = x.cluster, features = intersect(rownames(cbmc[["RNA"]]), markers.allset))
  markers <- markers[order(markers$avg_log2FC, decreasing = T),]
  markers.wilcox[[x.cluster]] <- markers
  # markers.i <- identify_single_marker(cbmc, x.cluster, markers.allset)
  # markers.prauc[[x.cluster]] <- markers.i
}



# save(markers.wilcox, file = "first8.seuratDE.markers.rds")
# save(markers.prauc, file = "first8.prauc.markers.rds")

load(file = "first8.seuratDE.markers.rds")
load(file = "first8.prauc.markers.rds")

Idents(cbmc) <- "seurat_clusters"
markers.12 <- FindMarkers(cbmc, ident.1 = "12", features = intersect(rownames(cbmc[["RNA"]]), markers.allset), assay = "RNA")
markers.12 <- markers.12[order(markers.12$avg_log2FC, decreasing = T), ]
df.12 <- data.frame()
for (gene in rownames(markers.12)) {
  df.s <- get_split_pos.1(cbmc, gene, "12", step = 0.1)
  df.12 <- rbind(df.12, df.s)
}
df.12[order(df.12$x.margin.adj, decreasing = T), ]

markers.wilcox[[6]]
markers.prauc[[6]]


sum(cbmc@active.ident == "6")
df.5.neg <- data.frame()
for (gene in rownames(markers.wilcox[[5]])) {
  df.s <- get_split_neg.1(cbmc, gene, "5", step = 0.1)
  df.5.neg <- rbind(df.5.neg, df.s)
}

markers.wilcox[[6]]

df.6 <- data.frame()
for (gene in rownames(markers.wilcox[[6]])) {
  df.s <- get_split_pos.1(cbmc, gene, "6", step = 0.1)
  df.6 <- rbind(df.6, df.s)
}
df.6[order(df.6$x.margin.adj, decreasing = T), ]


df.5.neg[order(df.5.neg$x.margin.adj, decreasing = T), ]
df.6.1[order(df.6.1$x.margin.adj, decreasing = T), ]
df.6[order(df.6$x.margin, decreasing = T), ]


data.mat.surf <- data.frame(exp = cbmc@assays$RNA@data["CD19",],
                            id = as.character(cbmc@active.ident))


VlnPlot(cbmc, "ECH1")
df.matrix <- get_gene_PRAUC_matrix(cbmc, "CD34", "12", step = 0.1)

plot(df.matrix$x.rec, df.matrix$x.pre)

geneset <- intersect(rownames(cbmc[["RNA"]]), markers.allset)

identify_single_marker.1 <- function(scrna, id, geneset = NULL, step = 0.01){
  if (!is.null(geneset)) {
    if (length(intersect(rownames(scrna[["RNA"]]), geneset)) == 0) {
      print("Genes not find.")
    }else{
      markers.de <- FindMarkers(scrna, ident.1 = id, features = intersect(rownames(scrna[["RNA"]]), geneset), test.use = "t")
    }
  }else{
    markers.de <- FindMarkers(scrna, ident.1 = id, test.use = "t")
  }
  markers.de <- markers.de[markers.de$p_val_adj < 0.05, ]
  markers.pos <- markers.de[markers.de$avg_log2FC > 0, ]
  markers.neg <- markers.de[markers.de$avg_log2FC < 0, ]
  df <- data.frame()
  for (gene in rownames(markers.pos)) {
    df.s <- get_split_pos.1(scrna, gene, id, step = step)
    df <- rbind(df, df.s)
  }
  for (gene in rownames(markers.neg)) {
    df.s <- get_split_neg.1(scrna, gene, id, step = step)
    df <- rbind(df, df.s)
  }
  df <- df[order(df$x.margin.adj, decreasing = T), ]
  return(df)
}

df.6 <- identify_single_marker.1(cbmc, "6", step = 0.1, geneset = markers.allset)
markers.wilcox[[6]]
df.6

df.5 <- identify_single_marker.1(cbmc, "5", step = 0.1, geneset = markers.allset)

df.single <- list()
for (x.cluster in 1:8) {
  df.s <- identify_single_marker.1(cbmc, x.cluster, step = 0.1, geneset = markers.allset)
  df.single[[x.cluster]] <- df.s
}

for (x.cluster in seq(1,8)) {
  markers <- FindMarkers(cbmc, ident.1 = x.cluster, features = intersect(rownames(cbmc[["RNA"]]), markers.allset))
  markers <- markers[order(markers$avg_log2FC, decreasing = T),]
  markers.wilcox[[x.cluster]] <- markers
  # markers.i <- identify_single_marker(cbmc, x.cluster, markers.allset)
  # markers.prauc[[x.cluster]] <- markers.i
}

for (x.cluster in seq(1,8)) {
  markers <- markers.wilcox[[x.cluster]]
  markers <- markers[order(markers$p_val_adj, decreasing = F),]
  markers.wilcox[[x.cluster]] <- markers
  # markers.i <- identify_single_marker(cbmc, x.cluster, markers.allset)
  # markers.prauc[[x.cluster]] <- markers.i
}

Convert("/home/ronghui/project/scMarkerDetect/MCA_BatchRemoved_Merge_dge.h5ad", dest = "h5seurat", overwrite = TRUE)
sce <- readH5AD("/home/ronghui/project/scMarkerDetect/MCA_BatchRemoved_Merge_dge.h5ad")

file <- system.file("MCA_BatchRemoved_Merge_dge.h5ad", package = "zellkonverter")
kidney <- ReadH5AD("/home/ronghui/project/scMarkerDetect/MCA_BatchRemoved_Merge_dge.h5ad", assay = "RNA", layers = "data" ,verbose =TRUE)
readH5AD(file, reader = "R")
markers.de.6[order(markers.de.6$avg_log2FC, decreasing = T), ]

VlnPlot(cbmc, rownames(df.single[[6]])[1])
```

```{r}
get_split_pos.1(cbmc, "IGHD", "6")
```
```{r}
VlnPlot(cbmc, "IGHD")
```


```{r}
GetAssays(assays, index)
```


```{r}

get_split_pos.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)
  
  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)
    
    x.margin <- tp - fp#*x.size.factor
    # x.margin <- tp - fp*x.size.factor
    # x.margin <- (x.factor**2)*x.margin
    
    # x.margin.adj <- x.margin*x.factor
    x.margin.adj <- x.margin*(tp/length(data.id$exp))*(tn/length(data.other$exp))*(x.factor**2)
    
    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}


get_split_neg.1 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- (mean(data.other$exp) + 0.001)/(mean(data.id$exp) + 0.001)
  
  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp < x.val)
    fp <- sum(data.other$exp < x.val)
    tn <- sum(data.other$exp >= x.val)
    fn <- sum(data.id$exp >= x.val)
    
    x.margin <- tp - fp#*x.size.factor
    # x.margin <- tp - fp*x.size.factor
    # x.margin <- (x.factor**2)*x.margin
    
    # x.margin.adj <- x.margin*x.factor
    x.margin.adj <- x.margin*(tp/length(data.id$exp))*(tn/length(data.other$exp))*(x.factor**2)
    
    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "-")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}
```





Compare top 9 marker from DE and prauc based method

# Plot PRAUC of TOP 9 Positive markers from DE and prauc based ranking

```{r}
Idents(cbmc) <- "seurat_clusters"

for (x.cluster in seq(1,8)) {
  df.prauc <- markers.prauc[[x.cluster]]
  df.wilcox <- markers.wilcox[[x.cluster]]
  
  g <- ggplot()
  for (genes in intersect(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc$gene[1:9], rownames(df.wilcox)[1:9])) {
    if (df.prauc[df.prauc$gene == genes, ]$direction == "+") {
      df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }else{
      df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }
  }
  print(g)
}

```


# Plot PRAUC of TOP 12 markers from COMET and prauc ranking

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
x.cluster <- 12
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_singleton_all_ranked.csv", sep = ""))
  genes <- genes[1:10, ]
  comet.genes.pos <- genes[genes$Log2FoldChange > 0, ]$gene_1
  comet.genes.neg <- genes[genes$Log2FoldChange < 0, ]$gene_1
  comet.genes.neg <-gsub("_negation", "", comet.genes.neg)
  
  df.prauc <- markers.prauc[[x.cluster]]
  df.prauc <- df.prauc[1:10,]
  df.prauc.pos <- df.prauc[df.prauc$direction == "+", ]$gene
  df.prauc.neg <- df.prauc[df.prauc$direction == "-", ]$gene
  
  g <- ggplot()
  for (genes in intersect(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.pos, comet.genes.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  
  for (genes in intersect(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.neg, comet.genes.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  print(g + xlab("Recall") + ylab("Precision") + ggtitle(paste(x.cluster)))
}

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, comet.genes.pos)
VlnPlot(cbmc, df.prauc.pos)
genes[genes$gene_1 == "CD11c", ]
df.prauc[df.prauc$gene== "CD11c",]
genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", "12", "_singleton_all_ranked.csv", sep = ""))
genes
markers.prauc[[6]]
genes$hgrank + genes$fcrank
markers.i
cbmc <- makeid(cbmc, "12")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "PROM1")
VlnPlot(cbmc, "CD34")
VlnPlot(cbmc, "SPINK2")

```

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "HLA-DOB")
VlnPlot(cbmc, df.prauc.pos)


id <- "6"
gene <- "CD19"

get_split_pos.2 <- function(scrna, gene, id, step = 0.01) {
  data.mat.surf <- data.frame(exp = scrna@assays$RNA@data[gene,],
                              id = as.character(scrna@active.ident))
  gene.prauc <- data.frame(x.val <- c(),
                           margin <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  data.id.l <- nrow(data.id)
  data.o.l <- nrow(data.other)
  data.all.l <- nrow(data.mat.surf)

  x.max <- max(data.id$exp)
  x.min <- min(data.id$exp)
  x.num <- 1/step
  
  x.factor <- (mean(data.id$exp) + 0.001)/(mean(data.other$exp) + 0.001)
  
  x.size.factor <- 10*(length(data.id$exp)/length(data.other$exp))

  for (x.val in seq(x.min, x.max, (x.max - x.min)/x.num)) {
    tp <- sum(data.id$exp > x.val)
    fp <- sum(data.other$exp > x.val)
    tn <- sum(data.other$exp <= x.val)
    fn <- sum(data.id$exp <= x.val)
    data.i.a <- data.id[data.id$exp > x.val, ]
    data.o.a <- data.other[data.other$exp > x.val, ]
    data.i.b <- data.id[data.id$exp <= x.val, ]
    data.o.b <- data.other[data.other$exp <= x.val, ]
    
    x.margin <- sum((data.i.a$exp - x.val))*nrow(data.o.b) + 
      sum((x.val -data.o.b$exp))*nrow(data.i.a) -
      sum((data.o.a$exp - x.val))*nrow(data.o.b)
    x.margin <- x.margin/data.all.l
    
    # x.margin <- sum((data.id[data.id$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id) + 
    #   sum((x.val - data.other[data.other$exp <x.val, ]$exp))*length(data.id[data.id$exp > x.val, ]$id) -
    #   sum((data.other[data.other$exp > x.val, ]$exp - x.val))*length(data.other[data.other$exp <x.val, ]$id)

    x.margin.adj <- x.margin*(tp/data.id.l)*(tn/data.o.l)*(x.factor**2)
    
    de <- data.frame(x.val, x.margin, x.margin.adj, tp, fp, "+")
    gene.prauc <- rbind(gene.prauc, de)
  }
  gene.prauc <- gene.prauc[order(gene.prauc$x.margin, decreasing = T),]
  x.split <- gene.prauc[1,]
  rownames(x.split) <- paste(gene)
  return(x.split)
}

x.val <- 0.7016315
Idents(cbmc) <- "seurat_clusters"
cbmc <- makeid(cbmc, "6")
DefaultAssay(cbmc) <- "RNA"
VlnPlot(cbmc, "CD19")
VlnPlot(cbmc, "HLA-DOB")
get_split_pos.2(cbmc, "CD19", "6")
get_split_pos.1(cbmc, "CD19", "6")
get_split_pos.1(cbmc, "HLA-DOB", "6")
get_split_pos.1(cbmc, "CD79B", "6")

df <- data.frame()
for (gene in markers.prauc[[6]]$gene[1:20]) {
  df.s <- get_split_pos.2(cbmc, gene, "6")
  df <- rbind(df, df.s)
}
df[order(df$x.margin.adj, decreasing = T), ]

markers.wilcox[[6]]

Idents(cbmc) <- "seurat_clusters"
markers.wilcox.6 <- FindMarkers(cbmc, ident.1 = "12", test.use = "LR")
markers.wilcox.6["CD19",]
markers.wilcox.6["HLA-DOB",]

cbmc <- makeid(cbmc, "6")
VlnPlot(cbmc, "VPREB3")
VlnPlot(cbmc, "CD19")

markers.i

get_split_pos.2(cbmc, "CD34", "12")
get_split_pos.2(cbmc, "CRHBP", "12")
get_split_pos.1(cbmc, "SPINK2", "12")
get_split_pos.2(cbmc, "SPINK2", "12")

```


# Detect combine markers for interested cell groups

```{r}
# makers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   df.split <- Detect_combine_markers(cbmc, x.cluster, markers.allset, max.gene = 50)
#   makers.prauc[[x.cluster]] <- df.split
# }

load(file = "first8clusters.combine.markers.rds")

makers.prauc

id <- "6"
df <- data.frame(exp1 = normalize(cbmc@assays$RNA@data["FCRLA",]),
                 exp2 = normalize(cbmc@assays$RNA@data["HLA-DRA",]),
                 id = as.character(cbmc@active.ident))


df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

dist(rbind(df.i$exp1, df.i$exp2))
dist(rbind(df.o$exp1, df.o$exp2))



FTH1_negation	UBA52_negation
FCRLA	HLA-DRA
TSC22D3	HLA-DRA

CD37	HLA-DQA1


x.seq <- 1
df.all <- data.frame()
for (x.seq in 1:nrow(makers.prauc[[5]])) {
  gene.c <- makers.prauc[[5]][x.seq,]
  df <- data.frame(exp1 = cbmc@assays$RNA@data[gene.c$Gene1,],
                   exp2 = cbmc@assays$RNA@data[gene.c$Gene2,],
                   id = as.character(cbmc@active.ident))
  df.i <- df[df$id == "5", ]
  df.o <- df[df$id != "5", ]
  # print(gene.c)
  df.s <- data.frame(gene.c$Gene1, gene.c$Gene2, cor(df.i$exp1, df.i$exp2), cor(df.o$exp1, df.o$exp2))
  colnames(df.s) <- c("gene1", "gene2", "cor.i", "cor.o")
  df.all <- rbind(df.all, df.s)
}

cbmc <- makeid(cbmc, "6")
df <- data.frame(exp1 = cbmc@assays$RNA@data["CD19",],
                 exp2 = cbmc@assays$RNA@data["HLA-DRA",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data["CD79B",],
                 exp2 = cbmc@assays$RNA@data["HLA-DRA",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

normalize <- function(x, ...) {
    return((x - min(x, ...)) /(max(x, ...) - min(x, ...)))
}

x <- c(1, NA, 2, 3)

normalize(x, na.rm = TRUE)

rownames(markers.wilcox[[6]])

Detect_combine_markers.1 <- function(scrna, id, geneset, step = 0.1, max.gene = NULL){
  gene.combn <- t(combn(geneset, 2))
  gene.combn.prauc <- data.frame()

  for (gene.iter in 1:length(gene.combn[,1])) {
    
    genes <- gene.combn[gene.iter,]
    gene1 <- genes[1]
    gene2 <- genes[2]
    
    df <- data.frame(exp1 = scale(scrna@assays$RNA@data[gene1,]),
                     exp2 = scale(scrna@assays$RNA@data[gene2,]),
                     id = as.character(scrna@active.ident))
  
    df.i <- df[df$id == id, ]
    df.o <- df[df$id != id, ]
    
    # x.fc1 <- round((mean(df.i$exp1) + 0.001)/(mean(df.o$exp1) + 0.001), 3)
    # x.fc2 <- round((mean(df.i$exp2) + 0.001)/(mean(df.o$exp2) + 0.001), 3)
    
    x.dist <- as.numeric(dist(rbind(df.o$exp1, df.o$exp2))/dist(rbind(df.i$exp1, df.i$exp2)))
    
    # x.dist <- x.dist*((x.fc1*x.fc2))

    de <- data.frame(gene1, gene2, x.dist)
    colnames(de) <- c("Gene1", "Gene2", "dist")
    gene.combn.prauc <- rbind(gene.combn.prauc, de)
  }
  gene.combn.prauc <- gene.combn.prauc[order(gene.combn.prauc$dist, decreasing = T),]
  return(gene.combn.prauc)
}

```

```{r}
x.dist.6 <- Detect_combine_markers.1(cbmc, "6", rownames(df.6)[1:50])
```


```{r}
cbmc <- makeid(cbmc, "6")
df <- data.frame(exp1 = cbmc@assays$RNA@data["CD79B",],
                 exp2 = cbmc@assays$RNA@data["CD74",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = scale(cbmc@assays$RNA@data["HLA-DRA",]),
                 exp2 = scale(cbmc@assays$RNA@data["LTB",]),
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data["HLA-DRA",],
                 exp2 = cbmc@assays$RNA@data["FCRLA",],
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))


```

```{r}
id <- "6"
df <- data.frame(exp1 = normalize(cbmc@assays$RNA@data["CD79B",]),
                 exp2 = normalize(cbmc@assays$RNA@data["CD74",]),
                 id = as.character(cbmc@active.ident))

ggplot(df) +
  geom_point(aes(exp1, exp2, col = id))

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

df[df$exp1 >  quantile(df.i$exp1, 0.5), ]$exp1 <- 1
df[df$exp1 != 1, ]$exp1 <- 0

df[df$exp2 >  quantile(df.i$exp2, 0.5), ]$exp2 <- 1
df[df$exp2 != 1, ]$exp2 <- 0

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

dist(rbind(df.o$exp1, df.o$exp2))
dist(rbind(df.i$exp1, df.i$exp2))


plot(df$exp1, df$exp2)


dist(rbind(df.o$exp1, df.o$exp2))/dist(rbind(df.i$exp1, df.i$exp2))

df <- data.frame(exp1 = scale(cbmc@assays$RNA@data["RPSA",]),
                 exp2 = scale(cbmc@assays$RNA@data["HLA-DRA",]),
                 id = as.character(cbmc@active.ident))

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]

df[df$exp1 >  quantile(df.i$exp1, 0.5), ]$exp1 <- 1
df[df$exp1 != 1, ]$exp1 <- 0

df[df$exp2 >  quantile(df.i$exp2, 0.5), ]$exp2 <- 1
df[df$exp2 != 1, ]$exp2 <- 0

df.i <- df[df$id == id, ]
df.o <- df[df$id != id, ]


dist(rbind(df.o$exp1, df.o$exp2))/dist(rbind(df.i$exp1, df.i$exp2))
```

```{r}
get_PRAUC_matrix_combine_markers.1 <- function(scrna, gene1,  gene2, id, step = 0.01){
  data.mat.surf <- data.frame(gene1 = scrna@assays$RNA@data[gene1,],
                              gene2 = scrna@assays$RNA@data[gene2,],
                              id = as.character(makeid(scrna, id)@active.ident))
  gene.prauc <- data.frame(x.pre <- c(),
                           x.rec <- c())
  data.id <- data.mat.surf[data.mat.surf$id == id,]
  data.other <- data.mat.surf[data.mat.surf$id != id,]
  
  x.seq <- seq(0.05, 0.95, step)

  for (x.val in quantile(data.id$gene1, x.seq)) {
    for (y.val in quantile(data.id$gene2, x.seq)) {
      tp <- sum(data.id$gene1 > x.val & data.id$gene2 > y.val)
      fp <- sum(data.other$gene1 > x.val & data.other$gene2 > y.val)
      fn <- sum(data.id$gene1 <= x.val | data.id$gene2 <= y.val)
      x.pre <- tp/(tp + fp)
      x.rec <- tp/(tp + fn)
      de <- data.frame(x.pre, x.rec)
      gene.prauc <- rbind(gene.prauc, de)
    }
  }
  gene.prauc <- gene.prauc[complete.cases(gene.prauc), ]
  gene.prauc <- gene.prauc[order(gene.prauc$x.rec), ]
  return(gene.prauc)
}
df <- get_PRAUC_matrix_combine_markers.1(cbmc, "CD79B", "CD74", "6", step = 0.1)

plot(df$x.rec, df$x.pre)

ggplot(df)+
  geom_line(aes(x.rec, x.pre), se = FALSE)

df <- get_PRAUC_matrix_combine_markers.1(cbmc, "FCRLA", "HLA-DRA", "6", step = 0.1)

plot(df$x.rec, df$x.pre)

ggplot(df)+
  geom_line(aes(x.rec, x.pre), se = FALSE)


```

```{r}
time <- 0:100
temp <- 20+ 0.01 * time^2 + 0.8 * time + rnorm(101, 0, 5)

# Generate first order linear model
lin.mod <- lm(cbmc@assays$RNA@data["CD79B",]~cbmc@assays$RNA@data["CD74",])

# Generate second order linear model
lin.mod2 <- lm(temp~I(time^2)+time)

# Calculate local regression
ls <- loess(cbmc@assays$RNA@data["CD79B",]~cbmc@assays$RNA@data["CD74",])

# Predict the data (passing only the model runs the prediction 
# on the data points used to generate the model itself)
pr.lm <- predict(lin.mod)
pr.lm2 <- predict(lin.mod2)
pr.loess <- predict(ls)

par(mfrow=c(2,2))
plot(cbmc@assays$RNA@data["CD79B",], cbmc@assays$RNA@data["CD74",])
lines(pr.lm~cbmc@assays$RNA@data["CD79B",], col="blue", lwd=2)

plot(time, temp, "l", las=1, xlab="Time", ylab="Temperature")
lines(pr.lm2~time, col="green", lwd=2)

plot(cbmc@assays$RNA@data["CD79B",], cbmc@assays$RNA@data["CD74",])
lines(pr.loess~cbmc@assays$RNA@data["CD79B",], col="red", lwd=2)

  data.mat.surf <- data.frame(gene1 = cbmc@assays$RNA@data["CD79B",],
                              gene2 = cbmc@assays$RNA@data["CD74",])
  
  # data.mat.surf <- data.mat.surf[data.mat.surf$gene1*data.mat.surf$gene2 != 0, ]
  ggplot(data.mat.surf)+
    geom_point(aes(gene1, gene2))+
    geom_smooth(aes(gene1, gene2), method = lm)
  data.mat.surf <- data.mat.surf[data.mat.surf$gene1*data.mat.surf$gene2 != 0, ]
  ggplot(data.mat.surf)+
    geom_point(aes(gene1, gene2))+
    geom_smooth(aes(gene1, gene2))
  plot(fit1,fit)
  
  qplot(gene1,gene2,data=data.mat.surf) + stat_smooth(aes(outfit=fit<<-..y..)) + stat_smooth(aes(outfit=fit1<<-..x..))
  fit
  fit1
  
  plot(fit1,fit)
```


```{r fig.width=10, fig.height=8}
scrna <- cbmc
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  
  # x.df <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.1)
  # x.df$method <- "COMET"
  
  if (!grepl("_negation", genes[1])) {
    if (!grepl("_negation", genes[2])) {
      gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }else{
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }else{
      if (!grepl("_negation", genes[2])) {
        genes[1] <- gsub("_negation", "", genes[1])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[2], gene2 = genes[1], id = x.cluster, step = 0.01)
      }else{
        genes[1] <- gsub("_negation", "", genes[1])
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }

  x.df <- gene.prauc
  x.df$method <- "COMET"
  # g <- ggplot() + geom_line(gene.prauc.comet, mapping = aes(x.rec, x.pre, color = method)) + xlim(c(0,1)) + ylim(c(0,1))
  
  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  Direction.c <- paste(df.split[1, ]$Direction1, df.split[1, ]$Direction2, sep = "")
  if (Direction.c == "++") {
    gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "+-") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "-+") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene2, gene2 = gene1, id = x.cluster, step = 0.01)
  }else{
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }
  
  x.df.2 <- gene.prauc
  x.df.2$method <- "PRAUC"
  
  x.df <- rbind(x.df, x.df.2)

  print(ggplot() + geom_line(x.df, mapping = aes(x.rec, x.pre, col = method)) + ggtitle(paste(x.cluster))+ 
          xlim(c(0,1)) + ylim(c(0,1)))
}
```


# Dotplot of Combine markers

```{r fig.width=10, fig.height=5}
for (x.cluster in seq(1,8)) {
  scrna <- makeid(scrna, x.cluster)
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_grid_2(cbmc, gene1, gene2, gene1.direc, gene2.direc, x.cluster, return.obj = T) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_grid_2(cbmc, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster, return.obj = T) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```





# Umap plot of combine markers

```{r fig.height = 7, fig.width=18}
Idents(cbmc) <- "seurat_clusters"
plot_marker_c_umap(cbmc, "TCL1A", "CD79B", "+", "+", "6")
scrna <- cbmc
Idents(scrna) <- "seurat_clusters"
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_marker_c_umap(scrna, gene1, gene2, gene1.direc, gene2.direc, x.cluster) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_marker_c_umap(scrna, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```

```{r}
cbmc.enhance <- enhance_seurat_wrapper(cbmc)
id <- "5"
gene1 <- "MYL3"
gene2 <- "FTH1"

df <- data.frame(exp1 = cbmc.enhance[gene1,],
                 exp2 = cbmc.enhance[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

df <- data.frame(exp1 = cbmc@assays$RNA@data[gene1,],
                 exp2 = cbmc@assays$RNA@data[gene2,],
                 id = as.character(makeid(scrna, id)@active.ident))

ggplot(df) + geom_point(aes(exp1, exp2, col = id))

```




# step by step (Maximam Recall approach)

```{r}
# markers.max_recall <- list()
# for (x.cluster in seq(1,8)) {
#   markers.i <- marker_stepbystep(cbmc, x.cluster, depth = 2, markers.allset)
#   markers.max_recall[[x.cluster]] <- markers.i
# }
# save(markers.max_recall, file = "first8.stepbystep.rds")
load(file = "first8.stepbystep.rds")
for (x.cluster in seq(1,8)) {
  markers.i <- markers.max_recall[[x.cluster]]
  print(grid_plot(cbmc, markers.i, x.cluster))
}
```                                                                                                                                                                                               




