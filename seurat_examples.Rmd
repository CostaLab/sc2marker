---
title: "Cell marker identification with seurat samples"
author: "Ronghui"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
# .libPaths("~/R/x86_64-pc-linux-gnu-library/3.6")
library(Seurat)
library(dplyr, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
library(ggplot2, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library")
suppressMessages(library(cowplot, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(randomForest, lib.loc = "/home/ronghui/anaconda3/envs/r4-real/lib/R/library"))
suppressMessages(library(patchwork))
suppressMessages(library(data.table))
suppressMessages(library(MLmetrics))
library(scMarkerDetect)
```



```{r pressure, echo=FALSE, fig.height=9, fig.width=12}
markers.allset <- read.csv(file=file.path("/home/ronghui/project/scMarkerDetect/gene_db/proteinatlas.ihc.csv"))[ ,1]

# markers.allset <- read.csv(file=file.path("/home/ronghui/project/dbmaker/abcam.tr.csv"))[ ,1]
# markers.allset <- unique(markers.allset)
# 
# markers.allset <- gsub(" ", "", markers.allset)
# # markers.allset <- gsub("-", "", markers.allset)
# 
# 
# cbmc.rna <- as.sparse(read.csv(file = "GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz", sep = ",",
#     header = TRUE, row.names = 1))
# 
# cbmc.rna <- CollapseSpeciesExpressionMatrix(cbmc.rna)
# 
# 
# markers.allset <- intersect(rownames(cbmc.rna) ,markers.allset)
# 
# length(markers.allset)

markers.allset <- c(as.character(markers.allset))
markers.allset <- unique(markers.allset)
```

# Seurat example

```{r}
# DefaultAssay(cbmc) <- "RNA"
# DefaultAssay(cbmc)
# 
# cbmc <- NormalizeData(cbmc)
# cbmc <- FindVariableFeatures(cbmc)
# cbmc <- ScaleData(cbmc)
# cbmc <- RunPCA(cbmc, verbose = FALSE)
# cbmc <- FindNeighbors(cbmc, dims = 1:30)
# cbmc <- FindClusters(cbmc, resolution = 0.8, verbose = FALSE)
# cbmc <- RunUMAP(cbmc, dims = 1:30)

load("/home/ronghui/project/dbmaker/seurat.cbmc.rds")
DimPlot(cbmc, label = TRUE)
```



```{r}
# # Normalize ADT data,
# DefaultAssay(cbmc) <- "ADT"
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2)
# DefaultAssay(cbmc) <- "RNA"
# 
# # Note that the following command is an alternative but returns the same result
# cbmc <- NormalizeData(cbmc, normalization.method = "CLR", margin = 2, assay = "ADT")

# Now, we will visualize CD14 levels for RNA and protein By setting the default assay, we can
# visualize one or the other
DefaultAssay(cbmc) <- "ADT"
p1 <- FeaturePlot(cbmc, "CD19", cols = c("lightgrey", "darkgreen")) + ggtitle("CD19 protein")
DefaultAssay(cbmc) <- "RNA"
p2 <- FeaturePlot(cbmc, "CD19") + ggtitle("CD19 RNA")

# place plots side-by-side
p1 | p2
```

# Get single markers from Seurat and PRAUC

```{r warning=F}
Idents(cbmc) <- "seurat_clusters"

# markers.wilcox <- list()
# markers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   markers <- FindMarkers(cbmc, ident.1 = x.cluster, features = intersect(rownames(cbmc[["RNA"]]), markers.allset))
#   markers <- markers[order(markers$avg_log2FC, decreasing = T),]
#   markers.wilcox[[x.cluster]] <- markers
#   markers.i <- identify_single_marker(cbmc, x.cluster, markers.allset)
#   markers.prauc[[x.cluster]] <- markers.i
# }

save(markers.wilcox, file = "first8.seuratDE.markers.rds")
save(markers.prauc, file = "first8.prauc.markers.rds")

load(file = "first8.seuratDE.markers.rds")
load(file = "first8.prauc.markers.rds")

```



Compare top 9 marker from DE and prauc based method

# Plot PRAUC of TOP 9 Positive markers from DE and prauc based ranking

```{r}
Idents(cbmc) <- "seurat_clusters"

for (x.cluster in seq(1,8)) {
  df.prauc <- markers.prauc[[x.cluster]]
  df.wilcox <- markers.wilcox[[x.cluster]]
  
  g <- ggplot()
  for (genes in intersect(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(rownames(df.wilcox)[1:9], df.prauc$gene[1:9])) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc$gene[1:9], rownames(df.wilcox)[1:9])) {
    if (df.prauc[df.prauc$gene == genes, ]$direction == "+") {
      df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }else{
      df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
      df$gene = as.factor(genes)
      df$method = as.factor("PRAUC")
      g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
    }
  }
  print(g)
}

```


# Plot PRAUC of TOP 12 markers from COMET and prauc ranking

```{r fig.height=6, fig.width=8}
Idents(cbmc) <- "seurat_clusters"

for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_singleton_all_ranked.csv", sep = ""))
  genes <- genes[1:12, ]
  comet.genes.pos <- genes[genes$Log2FoldChange > 0, ]$gene_1
  comet.genes.neg <- genes[genes$Log2FoldChange < 0, ]$gene_1
  comet.genes.neg <-gsub("_negation", "", comet.genes.neg)
  
  df.prauc <- markers.prauc[[x.cluster]]
  df.prauc <- df.prauc[1:12,]
  df.prauc.pos <- df.prauc[df.prauc$direction == "+", ]$gene
  df.prauc.neg <- df.prauc[df.prauc$direction == "-", ]$gene
  
  g <- ggplot()
  for (genes in intersect(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.pos, df.prauc.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.pos, comet.genes.pos)) {
    df <- get_gene_PRAUC_matrix(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  
  for (genes in intersect(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("Seurat and COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(comet.genes.neg, df.prauc.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("COMET")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  for (genes in setdiff(df.prauc.neg, comet.genes.neg)) {
    df <- get_gene_PRAUC_matrix_neg(cbmc, genes, x.cluster, step = 0.01)
    df$gene = as.factor(genes)
    df$method = as.factor("PRAUC")
    g <- g + geom_line(df, mapping = aes(x.rec, x.pre, color = method))
  }
  print(g + xlab("Recall") + ylab("Precision") + ggtitle(paste(x.cluster)))
}

```

# Detect combine markers for interested cell groups

```{r}
# makers.prauc <- list()
# for (x.cluster in seq(1,8)) {
#   df.split <- Detect_combine_markers(cbmc, x.cluster, markers.allset, max.gene = 50)
#   makers.prauc[[x.cluster]] <- df.split
# }

load(file = "first8clusters.combine.markers.rds")

makers.prauc
```



```{r fig.width=10, fig.height=8}
scrna <- cbmc
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  
  # x.df <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.1)
  # x.df$method <- "COMET"
  
  if (!grepl("_negation", genes[1])) {
    if (!grepl("_negation", genes[2])) {
      gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }else{
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }else{
      if (!grepl("_negation", genes[2])) {
        genes[1] <- gsub("_negation", "", genes[1])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = genes[2], gene2 = genes[1], id = x.cluster, step = 0.01)
      }else{
        genes[1] <- gsub("_negation", "", genes[1])
        genes[2] <- gsub("_negation", "", genes[2])
        gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = genes[1], gene2 = genes[2], id = x.cluster, step = 0.01)
      }
    }

  x.df <- gene.prauc
  x.df$method <- "COMET"
  # g <- ggplot() + geom_line(gene.prauc.comet, mapping = aes(x.rec, x.pre, color = method)) + xlim(c(0,1)) + ylim(c(0,1))
  
  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  Direction.c <- paste(df.split[1, ]$Direction1, df.split[1, ]$Direction2, sep = "")
  if (Direction.c == "++") {
    gene.prauc <- get_PRAUC_matrix_combine_markers(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "+-") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }else if (Direction.c == "-+") {
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg_pos(scrna = scrna, gene1 = gene2, gene2 = gene1, id = x.cluster, step = 0.01)
  }else{
    gene.prauc <- get_PRAUC_matrix_combine_markers_neg(scrna = scrna, gene1 = gene1, gene2 = gene2, id = x.cluster, step = 0.01)
  }
  
  x.df.2 <- gene.prauc
  x.df.2$method <- "PRAUC"
  
  x.df <- rbind(x.df, x.df.2)

  print(ggplot() + geom_line(x.df, mapping = aes(x.rec, x.pre, col = method)) + ggtitle(paste(x.cluster))+ 
          xlim(c(0,1)) + ylim(c(0,1)))
}
```


# Dotplot of Combine markers

```{r fig.width=10, fig.height=5}
for (x.cluster in seq(1,8)) {
  scrna <- makeid(scrna, x.cluster)
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_grid_2(cbmc, gene1, gene2, gene1.direc, gene2.direc, x.cluster, return.obj = T) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_grid_2(cbmc, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster, return.obj = T) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```





# Umap plot of combine markers

```{r fig.height = 7, fig.width=18}
Idents(cbmc) <- "seurat_clusters"
plot_marker_c_umap(cbmc, "TCL1A", "CD79B", "+", "+", "6")
scrna <- cbmc
Idents(scrna) <- "seurat_clusters"
for (x.cluster in seq(1,8)) {
  genes <- read.csv(paste("/home/ronghui/project/dbmaker/data/cluster_", x.cluster, "_pair_final_ranking.csv", sep = ""))
  genes <- c(genes[1,2], genes[1,3])
  if (!grepl("_negation", genes[1])) {
    gene1.direc <- "+"
  }else{
    gene1.direc <- "-"
  }
  
  if (!grepl("_negation", genes[2])) {
    gene2.direc <- "+"
  }else{
    gene2.direc <- "-"
  }
  genes <- gsub("_negation", "", genes)
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p1 <- plot_marker_c_umap(scrna, gene1, gene2, gene1.direc, gene2.direc, x.cluster) + ggtitle("COMET")
  

  df.split <- makers.prauc[[x.cluster]]
  genes <- c(df.split[1,1], df.split[1,2])
  gene1 <- genes[1]
  gene2 <- genes[2]
  
  p2 <- plot_marker_c_umap(scrna, gene1, gene2, df.split$Direction1[1], df.split$Direction2[1], x.cluster) + ggtitle("PRAUC")
  
  print(p1 | p2)
}
```

# step by step (Maximam Recall approach)

```{r}

df.split <- marker_stepbystep(cbmc, "6", depth = 3, geneset = markers.allset)
df.split1 <- marker_stepbystep(cbmc, "6", depth = 3, geneset = markers.allset)

plot_filter_stepbystep_first2(cbmc, df.split, "6")
plot_filter_stepbystep_first2(cbmc, df.split1, "6")

get_split.1(cbmc, "HLA-DRA", "6")

  
cbmc1 <- subset(x = cbmc, subset = TCL1A > 1.872265 & CD79B > 1.553028 & MS4A1 > 1.095634)
cbmc1 <- subset(x = cbmc, subset = CD74 > 4.077197 & CD79B > 1.68253)# & RPS18 > 4.544471)

cbmc2 <- subset(x = cbmc, subset = FCRLA > 0.9311952 & `HLA-DRA` > 3.580194)# & RPS18 > 4.544471)

tp <- sum(cbmc1@active.ident == "6")
fp <- sum(cbmc1@active.ident != "6")
tp/(tp+fp)

tp <- sum(cbmc2@active.ident == "6")
fp <- sum(cbmc2@active.ident != "6")
tp/(tp+fp)


sum(cbmc1@active.ident == "6")/sum(cbmc@active.ident == "6")
sum(cbmc2@active.ident == "6")/sum(cbmc@active.ident == "6")


TP = sum(cbmc1@active.ident == "6")
```                                                                                                                                                                                               

```{r fig.height=8, fig.width=8}
df.split.5 <- marker_stepbystep(cbmc, "5", depth = 3, geneset = markers.allset)
```





```{r fig.height=9, fig.width=9}

df.split <- df.split.5
grid_plot(cbmc, df.split.5, "5")


plot_filter_combination_first2(cbmc, df.split.5, "5")

plot_filter_combination_first2(cbmc, makers.prauc[[1]], "1")

```







```{r}
Idents(cbmc) <- "seurat_clusters"
DefaultAssay(cbmc) <- "RNA"
matrix_cometsc <- Seurat::GetAssayData(cbmc) #gets the normalized count matrix

length(intersect(rownames(matrix_cometsc), markers.allset))
# 
write.table(as.matrix(matrix_cometsc), file= "seurat.markers.txt", row.names=TRUE, col.names=TRUE, sep = "\t", quote = FALSE)
# 
umap_cometsc <- Embeddings(scrna, reduction = "umap")
write.table(umap_cometsc, file="seurat.vis.txt", row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)
# 
colnames(scrna@meta.data)
Idents(scrna) <- "seurat_clusters"
cluster_cometsc <- noquote(as.matrix(Idents(scrna))) # Get the active cluster identities. Should be numbers. COMET does not take Non-Number cluster names.
# 
write.table(cluster_cometsc, file = "clusters.txt" , row.names=TRUE, col.names=FALSE, sep = "\t", quote = FALSE)
# 
write.table(unique(markers.allset), file = "genes.txt", col.names = F, row.names = F, quote = F)
```


